<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Chunwoo Firestore 연동 예시</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <style>
    body { font-family: 'Noto Sans KR', Arial, sans-serif; background: #181c24; color: #fff; margin: 0; }
    .container { max-width: 900px; margin: 40px auto; background: #232837; border-radius: 12px; box-shadow: 0 2px 16px #0002; padding: 32px 24px; }
    h2 { color: #3b82f6; }
    .menu { display: flex; gap: 16px; margin-bottom: 24px; }
    .menu button { background: #232837; color: #b3b8c5; border: none; border-radius: 8px; padding: 10px 24px; font-size: 1.1rem; font-weight: 700; cursor: pointer; }
    .menu button.active, .menu button:hover { background: #3b82f6; color: #fff; }
    .logout-btn { background: #ef4444; color: #fff; border: none; border-radius: 6px; padding: 8px 20px; font-size: 1rem; font-weight: 700; cursor: pointer; float: right; }
    /* 햄버거 메뉴 스타일 */
    .hamburger { display: none; background: none; border: none; font-size: 2rem; color: #3b82f6; margin-left: 12px; cursor: pointer; }
    @media (max-width: 700px) {
      .menu { display: none; position: absolute; top: 60px; left: 0; width: 100vw; background: #232837; flex-direction: column; gap: 0; z-index: 1001; box-shadow: 0 2px 16px #0002; }
      .menu.menu-open { display: flex; }
      .menu button { width: 100%; padding: 16px; text-align: center; border-radius: 0; }
      .logout-btn { width: 100%; margin: 0; border-radius: 0; }
      .hamburger { display: block; }
    }
    table { width: 100%; border-collapse: collapse; margin-top: 18px; }
    th, td { padding: 10px; border-bottom: 1px solid #2d3344; }
    th { background: #232837; color: #3b82f6; }
    tr:last-child td { border-bottom: none; }
    .login-box { 
      background: #232837; 
      border-radius: 12px; 
      box-shadow: 0 2px 16px #0002; 
      max-width: 350px; 
      margin: 80px auto; 
      padding: 36px 28px 28px 28px; 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
    }
    .login-box h2 { 
      color: #3b82f6; 
      margin-bottom: 24px; 
      font-size: 1.5rem; 
      font-weight: 700; 
    }
    .login-box input { 
      width: 100%; 
      padding: 12px 10px; 
      margin-bottom: 16px; 
      border: 1.5px solid #2d3344; 
      border-radius: 6px; 
      font-size: 1rem; 
      background: #181c24; 
      color: #fff; 
    }
    .login-box button { 
      width: 100%; 
      padding: 12px 0; 
      border: none; 
      border-radius: 6px; 
      font-size: 1.1rem; 
      font-weight: 700; 
      cursor: pointer; 
      margin-bottom: 10px; 
      background: #3b82f6; 
      color: #fff; 
    }
    .login-box button:hover { 
      background: #2563eb; 
    }
    .error-msg { 
      color: #ef4444; 
      font-size: 0.98rem; 
      margin-bottom: 10px; 
      text-align: center; 
    }
  </style>
</head>
<body>
  <div id="main"></div>
  <script>
    // Firebase 초기화
    const firebaseConfig = {
      apiKey: "AIzaSyATCGXGD2_teiJFdpng9J2_fvZRItPef0w",
      authDomain: "chunwooo-edf9f.firebaseapp.com",
      databaseURL: "https://chunwooo-edf9f-default-rtdb.firebaseio.com",
      projectId: "chunwooo-edf9f",
      storageBucket: "chunwooo-edf9f.appspot.com",
      messagingSenderId: "417029078660",
      appId: "1:417029078660:web:00e23d79af77876e598cd1",
      measurementId: "G-653CL9XWFH"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // 인증 상태 감시
    firebase.auth().onAuthStateChanged(user => {
      if (user) {
        // 사용자 정보 가져오기
        db.collection('users').doc(user.uid).get().then(doc => {
          if (doc.exists) {
            window.currentUserRole = doc.data().role;
            renderMain();
          } else {
            renderLogin();
          }
        }).catch(() => {
          renderLogin();
        });
      } else {
        renderLogin();
      }
    });

    // 초기 화면 렌더링
    renderLogin();

    // 메뉴 렌더링
    function renderMenu(active) {
      let userRole = window.currentUserRole || '';
      document.getElementById('main').innerHTML = `
        <div class="container">
          <div style="display:flex;justify-content:space-between;align-items:center;position:relative;">
            <button class="hamburger" id="hamburger-btn">☰</button>
            <div class="menu" id="main-menu">
              <button class="${active==='main'?'active':''}" onclick="closeMenu();renderMain()">건설NEWS</button>
              <button class="${active==='status'?'active':''}" onclick="closeMenu();renderStatus()">공사현황</button>
              <button class="${active==='sites'?'active':''}" onclick="closeMenu();renderSites()">현장내역</button>
              <button class="${active==='discussion'?'active':''}" onclick="closeMenu();renderDiscussion()">협의하기</button>
              <button class="${active==='progress'?'active':''}" onclick="closeMenu();renderProgress()" style="${userRole==='admin'||userRole==='master'?'':'display:none;'}">기성현황</button>
              <button class="${active==='partners'?'active':''}" onclick="closeMenu();renderPartners()">거래처</button>
              ${(userRole==='admin'||userRole==='master')?`<button class="${active==='users'?'active':''}" onclick="closeMenu();renderUsers()">회원명단</button><button class="${active==='roles'?'active':''}" onclick="closeMenu();renderRoleSettings()">권한설정</button>`:''}
            </div>
            <button class="logout-btn" onclick="logout()">로그아웃</button>
          </div>
          <div id="content"></div>
        </div>
      `;
      // 햄버거 메뉴 동작
      const hamburger = document.getElementById('hamburger-btn');
      const menu = document.getElementById('main-menu');
      if (hamburger && menu) {
        hamburger.onclick = function(e) {
          e.stopPropagation();
          menu.classList.toggle('menu-open');
        };
        // 메뉴 바깥 클릭 시 닫힘
        document.addEventListener('click', function handler(e) {
          if (window.innerWidth <= 700 && menu.classList.contains('menu-open')) {
            if (!menu.contains(e.target) && e.target !== hamburger) {
              menu.classList.remove('menu-open');
            }
          }
        });
      }
    }
    // 메뉴 닫기 함수
    function closeMenu() {
      const menu = document.getElementById('main-menu');
      if (menu) menu.classList.remove('menu-open');
    }

    // 현장 목록 Firestore 연동 예시 (추가/수정/삭제 포함)
    function renderSites() {
      renderMenu('sites');
      const content = document.getElementById('content');
      
      // 상태별 탭
      let tabsHtml = `
        <div style='display:flex;gap:12px;margin-bottom:24px;'>
          <button onclick="filterSites('all')" class='tab-btn active' data-status='all'>전체</button>
          <button onclick="filterSites('진행중')" class='tab-btn' data-status='진행중'>진행중</button>
          <button onclick="filterSites('예정')" class='tab-btn' data-status='예정'>예정</button>
          <button onclick="filterSites('완료')" class='tab-btn' data-status='완료'>완료</button>
          <button onclick="filterSites('보류')" class='tab-btn' data-status='보류'>보류</button>
        </div>
        <div style='display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;'>
          <div style='display:flex;gap:8px;'>
            <input type='text' id='site-search' placeholder='현장명/주소/담당자 검색' style='padding:8px 12px;border-radius:6px;border:1.5px solid #2d3344;background:#181c24;color:#fff;width:300px;'>
            <button onclick='searchSites()' style='background:#3b82f6;color:#fff;border:none;border-radius:6px;padding:8px 16px;'>검색</button>
          </div>
          <div style='display:flex;gap:8px;'>
            <button onclick='downloadExcel()' style='background:#22c55e;color:#fff;border:none;border-radius:6px;padding:8px 16px;'>엑셀 다운로드</button>
            <label style='background:#3b82f6;color:#fff;border:none;border-radius:6px;padding:8px 16px;cursor:pointer;'>
              엑셀 업로드
              <input type='file' id='excel-upload' accept='.xlsx,.xls' style='display:none;' onchange='uploadExcel(this)'>
            </label>
          </div>
        </div>`;

      // 추가 폼
      let formHtml = `
        <form id="site-form" style="display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-bottom:18px;">
          <input id="site-name" type="text" placeholder="현장명" style="padding:8px 10px;border-radius:6px;border:1.5px solid #2d3344;background:#181c24;color:#fff;font-size:1rem;" required />
          <input id="site-company" type="text" placeholder="회사" style="padding:8px 10px;border-radius:6px;border:1.5px solid #2d3344;background:#181c24;color:#fff;font-size:1rem;" />
          <input id="site-manager" type="text" placeholder="현장소장" style="padding:8px 10px;border-radius:6px;border:1.5px solid #2d3344;background:#181c24;color:#fff;font-size:1rem;" />
          <select id="site-status" style="padding:8px 10px;border-radius:6px;border:1.5px solid #2d3344;background:#181c24;color:#fff;font-size:1rem;" required>
            <option value="">상태 선택</option>
            <option value="진행중">진행중</option>
            <option value="예정">예정</option>
            <option value="완료">완료</option>
            <option value="보류">보류</option>
          </select>
          <input id="site-address" type="text" placeholder="주소" style="padding:8px 10px;border-radius:6px;border:1.5px solid #2d3344;background:#181c24;color:#fff;font-size:1rem;" />
          <input id="site-phone" type="text" placeholder="연락처" style="padding:8px 10px;border-radius:6px;border:1.5px solid #2d3344;background:#181c24;color:#fff;font-size:1rem;" />
          <div style="position:relative;">
            <input id="site-start" type="text" placeholder="시작일" style="padding:8px 10px;border-radius:6px;border:1.5px solid #2d3344;background:#181c24;color:#fff;font-size:1rem;width:120px;" readonly />
            <div id="start-calendar" style="display:none;position:absolute;top:100%;left:0;z-index:1000;background:#232837;padding:12px;border-radius:8px;box-shadow:0 4px 12px #0003;"></div>
          </div>
          <div style="position:relative;">
            <input id="site-end" type="text" placeholder="종료일" style="padding:8px 10px;border-radius:6px;border:1.5px solid #2d3344;background:#181c24;color:#fff;font-size:1rem;width:120px;" readonly />
            <div id="end-calendar" style="display:none;position:absolute;top:100%;left:0;z-index:1000;background:#232837;padding:12px;border-radius:8px;box-shadow:0 4px 12px #0003;"></div>
          </div>
          <input id="site-contract" type="number" placeholder="계약금액" style="padding:8px 10px;border-radius:6px;border:1.5px solid #2d3344;background:#181c24;color:#fff;font-size:1rem;" />
          <div style="width:100%;">
            <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;">
              <input id="item-name" type="text" placeholder="품목명" style="padding:8px 10px;border-radius:6px;border:1.5px solid #2d3344;background:#181c24;color:#fff;font-size:1rem;" />
              <input id="item-quantity" type="number" placeholder="수량" style="padding:8px 10px;border-radius:6px;border:1.5px solid #2d3344;background:#181c24;color:#fff;font-size:1rem;width:100px;" />
              <input id="item-unit" type="text" placeholder="단위" style="padding:8px 10px;border-radius:6px;border:1.5px solid #2d3344;background:#181c24;color:#fff;font-size:1rem;width:80px;" />
              <button type="button" onclick="addItem()" style="background:#3b82f6;color:#fff;border:none;border-radius:6px;padding:8px 16px;">품목 추가</button>
            </div>
            <div id="items-list" style="margin-bottom:12px;"></div>
          </div>
          <textarea id="site-note" placeholder="비고" style="padding:8px 10px;border-radius:6px;border:1.5px solid #2d3344;background:#181c24;color:#fff;font-size:1rem;width:100%;min-height:60px;"></textarea>
          <button type="submit" style="background:#22c55e;color:#fff;border:none;border-radius:6px;padding:8px 22px;font-weight:700;">+ 현장 추가</button>
        </form>`;

      content.innerHTML = `<h2>현장 목록</h2>${tabsHtml}${formHtml}<div id="sites-list" style="max-height:600px;overflow-y:auto;"></div>`;

      // 달력 초기화
      initCalendar('start-calendar', 'site-start');
      initCalendar('end-calendar', 'site-end');

      // 품목 리스트 초기화
      window.currentItems = [];
      updateItemsList();

      // 폼 이벤트 리스너
      document.getElementById('site-form').onsubmit = function(e) {
        e.preventDefault();
        const name = document.getElementById('site-name').value.trim();
        const company = document.getElementById('site-company').value.trim();
        const manager = document.getElementById('site-manager').value.trim();
        const status = document.getElementById('site-status').value;
        const address = document.getElementById('site-address').value.trim();
        const phone = document.getElementById('site-phone').value.trim();
        const start = document.getElementById('site-start').value;
        const end = document.getElementById('site-end').value;
        const contract = document.getElementById('site-contract').value;
        const note = document.getElementById('site-note').value.trim();
        const items = window.currentItems;

        if (!name || !status) return;

        db.collection('sites').add({ 
          name, company, manager, status, address, phone, start, end, contract, note, items,
          createdAt: new Date()
        }).then(() => {
          // 폼 초기화
          document.getElementById('site-name').value = '';
          document.getElementById('site-company').value = '';
          document.getElementById('site-manager').value = '';
          document.getElementById('site-status').value = '';
          document.getElementById('site-address').value = '';
          document.getElementById('site-phone').value = '';
          document.getElementById('site-start').value = '';
          document.getElementById('site-end').value = '';
          document.getElementById('site-contract').value = '';
          document.getElementById('site-note').value = '';
          window.currentItems = [];
          updateItemsList();
        });
      };

      // 실시간 데이터 감시
      db.collection('sites').onSnapshot(snapshot => {
        renderSitesList(snapshot.docs);
      });
    }

    // 달력 초기화
    function initCalendar(calendarId, inputId) {
      const calendar = document.getElementById(calendarId);
      const input = document.getElementById(inputId);
      
      input.onclick = function() {
        calendar.style.display = calendar.style.display === 'none' ? 'block' : 'none';
        if (calendar.style.display === 'block') {
          renderCalendar(calendar, input);
        }
      };

      document.addEventListener('click', function(e) {
        if (!calendar.contains(e.target) && e.target !== input) {
          calendar.style.display = 'none';
        }
      });
    }

    // 달력 렌더링
    function renderCalendar(calendar, input) {
      const today = new Date();
      const year = today.getFullYear();
      const month = today.getMonth();
      
      let html = `
        <div style='display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;'>
          <button onclick='changeCalendarMonth(this, -1)' style='background:none;border:none;color:#fff;'>&lt;</button>
          <span>${year}년 ${month+1}월</span>
          <button onclick='changeCalendarMonth(this, 1)' style='background:none;border:none;color:#fff;'>&gt;</button>
        </div>
        <div style='display:grid;grid-template-columns:repeat(7,1fr);gap:4px;'>`;
      
      const weekDays = ['일','월','화','수','목','금','토'];
      weekDays.forEach(day => {
        html += `<div style='text-align:center;color:${day==='일'?'#ef4444':'#3b82f6'};'>${day}</div>`;
      });

      const firstDay = new Date(year, month, 1).getDay();
      const lastDate = new Date(year, month+1, 0).getDate();

      for(let i=0; i<firstDay; i++) {
        html += '<div></div>';
      }

      for(let i=1; i<=lastDate; i++) {
        html += `
          <div onclick='selectDate(this, "${input.id}")' 
            style='text-align:center;padding:4px;cursor:pointer;border-radius:4px;'
            data-date='${year}-${String(month+1).padStart(2,'0')}-${String(i).padStart(2,'0')}'>
            ${i}
          </div>`;
      }

      html += '</div>';
      calendar.innerHTML = html;
    }

    // 달력 월 변경
    window.changeCalendarMonth = function(btn, diff) {
      const calendar = btn.parentNode.parentNode;
      const monthText = btn.parentNode.querySelector('span').textContent;
      const [year, month] = monthText.split('년 ').map(v => parseInt(v));
      const newDate = new Date(year, month-1+diff, 1);
      const input = calendar.parentNode.querySelector('input');
      renderCalendar(calendar, input);
    }

    // 날짜 선택
    window.selectDate = function(day, inputId) {
      const date = day.getAttribute('data-date');
      document.getElementById(inputId).value = date;
      day.parentNode.parentNode.style.display = 'none';
    }

    // 품목 추가
    window.addItem = function() {
      const name = document.getElementById('item-name').value.trim();
      const quantity = document.getElementById('item-quantity').value;
      const unit = document.getElementById('item-unit').value.trim();
      
      if (!name || !quantity || !unit) return;

      window.currentItems.push({ name, quantity, unit });
      
      document.getElementById('item-name').value = '';
      document.getElementById('item-quantity').value = '';
      document.getElementById('item-unit').value = '';
      
      updateItemsList();
    }

    // 품목 리스트 업데이트
    function updateItemsList() {
      const container = document.getElementById('items-list');
      let html = '';
      
      window.currentItems.forEach((item, idx) => {
        html += `
          <div style='display:flex;gap:8px;align-items:center;margin-bottom:4px;'>
            <span>${item.name} ${item.quantity}${item.unit}</span>
            <button onclick='removeItem(${idx})' style='background:#ef4444;color:#fff;border:none;border-radius:4px;padding:2px 8px;font-size:0.9em;'>삭제</button>
          </div>`;
      });
      
      container.innerHTML = html;
    }

    // 품목 삭제
    window.removeItem = function(idx) {
      window.currentItems.splice(idx, 1);
      updateItemsList();
    }

    // 현장 목록 렌더링
    function renderSitesList(docs) {
      const container = document.getElementById('sites-list');
      let html = `<table style='width:100%;'><thead><tr>
        <th>현장명</th>
        <th>회사</th>
        <th>현장소장</th>
        <th>상태</th>
        <th>주소</th>
        <th>담당자</th>
        <th>연락처</th>
        <th>공사기간</th>
        <th>계약금액</th>
        <th>관리</th>
      </tr></thead><tbody>`;

      docs.forEach(doc => {
        const d = doc.data();
        html += `<tr>
          <td><input type='text' value='${d.name||''}' id='name-${doc.id}' style='width:120px;padding:4px;border-radius:4px;border:1px solid #2d3344;background:#232837;color:#fff;'></td>
          <td><input type='text' value='${d.company||''}' id='company-${doc.id}' style='width:100px;padding:4px;border-radius:4px;border:1px solid #2d3344;background:#232837;color:#fff;'></td>
          <td><input type='text' value='${d.manager||''}' id='manager-${doc.id}' style='width:100px;padding:4px;border-radius:4px;border:1px solid #2d3344;background:#232837;color:#fff;'></td>
          <td>
            <select id='status-${doc.id}' style='width:100px;padding:4px;border-radius:4px;border:1px solid #2d3344;background:#232837;color:#fff;'>
              <option value='진행중' ${d.status==='진행중'?'selected':''}>진행중</option>
              <option value='예정' ${d.status==='예정'?'selected':''}>예정</option>
              <option value='완료' ${d.status==='완료'?'selected':''}>완료</option>
              <option value='보류' ${d.status==='보류'?'selected':''}>보류</option>
            </select>
          </td>
          <td><input type='text' value='${d.address||''}' id='address-${doc.id}' style='width:150px;padding:4px;border-radius:4px;border:1px solid #2d3344;background:#232837;color:#fff;'></td>
          <td><input type='text' value='${d.manager||''}' id='manager-${doc.id}' style='width:100px;padding:4px;border-radius:4px;border:1px solid #2d3344;background:#232837;color:#fff;'></td>
          <td><input type='text' value='${d.phone||''}' id='phone-${doc.id}' style='width:120px;padding:4px;border-radius:4px;border:1px solid #2d3344;background:#232837;color:#fff;'></td>
          <td>
            <div style='display:flex;gap:4px;align-items:center;'>
              <input type='text' value='${d.start||''}' id='start-${doc.id}' style='width:100px;padding:4px;border-radius:4px;border:1px solid #2d3344;background:#232837;color:#fff;' readonly>
              <span>~</span>
              <input type='text' value='${d.end||''}' id='end-${doc.id}' style='width:100px;padding:4px;border-radius:4px;border:1px solid #2d3344;background:#232837;color:#fff;' readonly>
            </div>
          </td>
          <td><input type='number' value='${d.contract||''}' id='contract-${doc.id}' style='width:120px;padding:4px;border-radius:4px;border:1px solid #2d3344;background:#232837;color:#fff;'></td>
          <td>
            <button onclick="showSiteDetail('${doc.id}')" style='background:#3b82f6;color:#fff;border:none;border-radius:6px;padding:4px 12px;margin-right:4px;'>상세</button>
            <button onclick="updateSite('${doc.id}')" style='background:#2563eb;color:#fff;border:none;border-radius:6px;padding:4px 12px;margin-right:4px;'>수정</button>
            <button onclick="deleteSite('${doc.id}')" style='background:#ef4444;color:#fff;border:none;border-radius:6px;padding:4px 12px;'>삭제</button>
          </td>
        </tr>`;
      });

      html += '</tbody></table>';
      container.innerHTML = html;

      // 달력 초기화
      docs.forEach(doc => {
        initCalendar(`start-calendar-${doc.id}`, `start-${doc.id}`);
        initCalendar(`end-calendar-${doc.id}`, `end-${doc.id}`);
      });
    }

    // 현장 수정
    function updateSite(id) {
      const name = document.getElementById('name-' + id).value.trim();
      const company = document.getElementById('company-' + id).value.trim();
      const manager = document.getElementById('manager-' + id).value.trim();
      const status = document.getElementById('status-' + id).value;
      const address = document.getElementById('address-' + id).value.trim();
      const phone = document.getElementById('phone-' + id).value.trim();
      const start = document.getElementById('start-' + id).value;
      const end = document.getElementById('end-' + id).value;
      const contract = document.getElementById('contract-' + id).value;

      db.collection('sites').doc(id).update({ 
        name, company, manager, status, address, phone, start, end, contract,
        updatedAt: new Date()
      });
    }

    // 현장 삭제
    function deleteSite(id) {
      if (confirm('정말 삭제하시겠습니까?')) {
        db.collection('sites').doc(id).delete();
      }
    }

    // 현장 상세보기
    window.showSiteDetail = function(id) {
      db.collection('sites').doc(id).get().then(doc => {
        const d = doc.data();
        const popupBg = document.createElement('div');
        popupBg.style.cssText = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.4);z-index:2000;display:flex;align-items:center;justify-content:center;';
        popupBg.onclick = function(e){ if(e.target===popupBg) popupBg.remove(); };
        let html = `<div style='background:#232837;padding:32px 28px 24px 28px;border-radius:16px;min-width:320px;max-width:90vw;box-shadow:0 4px 32px #0005;position:relative;'>
          <button onclick='this.parentNode.parentNode.remove()' style='position:absolute;right:16px;top:16px;background:none;border:none;color:#b3b8c5;font-size:1.3rem;cursor:pointer;'>&times;</button>
          <h3 style='margin:0 0 18px 0;color:#3b82f6;'>${d.name||''} 현장 상세정보</h3>
          <div style='display:grid;grid-template-columns:120px 1fr;gap:12px;align-items:start;'>
            <div>상태:</div><div>${d.status||''}</div>
            <div>주소:</div><div>${d.address||''}</div>
            <div>담당자:</div><div>${d.manager||''}</div>
            <div>연락처:</div><div>${d.phone||''}</div>
            <div>공사기간:</div><div>${d.start||''} ~ ${d.end||''}</div>
            <div>계약금액:</div><div>${d.contract ? d.contract.toLocaleString() + '원' : ''}</div>
            <div>품목:</div><div>`;
        
        if(d.items && d.items.length > 0) {
          html += '<ul style="margin:0;padding-left:20px;">';
          d.items.forEach(item => {
            html += `<li>${item.name} ${item.quantity}${item.unit}</li>`;
          });
          html += '</ul>';
        }
        
        html += `</div>
            <div>비고:</div><div style='white-space:pre-wrap;'>${d.note||''}</div>
            <div>등록일:</div><div>${d.createdAt ? d.createdAt.toDate().toLocaleString() : ''}</div>
            <div>수정일:</div><div>${d.updatedAt ? d.updatedAt.toDate().toLocaleString() : ''}</div>
          </div>
        </div>`;
        popupBg.innerHTML = html;
        document.body.appendChild(popupBg);
      });
    }

    // 상태별 필터링
    window.filterSites = function(status) {
      const buttons = document.querySelectorAll('.tab-btn');
      buttons.forEach(btn => {
        btn.classList.toggle('active', btn.getAttribute('data-status') === status);
      });
      
      db.collection('sites').get().then(snapshot => {
        const docs = snapshot.docs.filter(doc => {
          if (status === 'all') return true;
          return doc.data().status === status;
        });
        renderSitesList(docs);
      });
    }

    // 검색
    window.searchSites = function() {
      const keyword = document.getElementById('site-search').value.trim().toLowerCase();
      if (!keyword) {
        db.collection('sites').get().then(snapshot => {
          renderSitesList(snapshot.docs);
        });
        return;
      }

      db.collection('sites').get().then(snapshot => {
        const docs = snapshot.docs.filter(doc => {
          const d = doc.data();
          return (
            (d.name || '').toLowerCase().includes(keyword) ||
            (d.address || '').toLowerCase().includes(keyword) ||
            (d.manager || '').toLowerCase().includes(keyword)
          );
        });
        renderSitesList(docs);
      });
    }

    // 엑셀 다운로드
    window.downloadExcel = function() {
      db.collection('sites').get().then(snapshot => {
        const data = snapshot.docs.map(doc => {
          const d = doc.data();
          return {
            '현장명': d.name || '',
            '상태': d.status || '',
            '주소': d.address || '',
            '담당자': d.manager || '',
            '연락처': d.phone || '',
            '시작일': d.start || '',
            '종료일': d.end || '',
            '계약금액': d.contract || '',
            '품목': (d.items || []).map(item => `${item.name} ${item.quantity}${item.unit}`).join(', '),
            '비고': d.note || ''
          };
        });

        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, '현장목록');
        XLSX.writeFile(wb, '현장목록.xlsx');
      });
    }

    // 엑셀 업로드
    window.uploadExcel = function(input) {
      const file = input.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, {type: 'array'});
        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(firstSheet);

        jsonData.forEach(row => {
          const items = (row['품목'] || '').split(',').map(item => {
            const [name, rest] = item.trim().split(' ');
            const match = rest.match(/(\d+)(.+)/);
            return {
              name: name,
              quantity: match ? match[1] : '',
              unit: match ? match[2] : ''
            };
          });

          db.collection('sites').add({
            name: row['현장명'] || '',
            status: row['상태'] || '진행중',
            address: row['주소'] || '',
            manager: row['담당자'] || '',
            phone: row['연락처'] || '',
            start: row['시작일'] || '',
            end: row['종료일'] || '',
            contract: row['계약금액'] || '',
            items: items,
            note: row['비고'] || '',
            createdAt: new Date()
          });
        });

        alert('엑셀 데이터가 업로드되었습니다.');
        input.value = '';
      };
      reader.readAsArrayBuffer(file);
    }

    // 공사현황과 연동
    function updateStatusCalendar() {
      db.collection('sites').get().then(siteSnap => {
        const sites = siteSnap.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));

        sites.forEach(site => {
          if (!site.start || !site.end) return;

          const start = new Date(site.start);
          const end = new Date(site.end);
          const year = start.getFullYear();
          const month = start.getMonth();

          db.collection('status_calendar').doc(`${year}-${month+1}`).get().then(calDoc => {
            let data = calDoc.exists ? calDoc.data() : {};
            
            for(let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
              const day = d.getDate();
              if (!data[day]) data[day] = [];
              if (!data[day].some(item => item.type === 'site' && item.value === site.name)) {
                data[day].push({
                  type: 'site',
                  value: site.name,
                  siteId: site.id
                });
              }
            }

            db.collection('status_calendar').doc(`${year}-${month+1}`).set(data);
          });
        });
      });
    }

    // 현장 추가/수정/삭제 시 공사현황 업데이트
    db.collection('sites').onSnapshot(() => {
      updateStatusCalendar();
    });

    // 회원가입 화면
    function renderSignup() {
      document.getElementById('main').innerHTML = `
        <div class="login-box">
          <h2>회원가입</h2>
          <input id="signup-name" type="text" placeholder="이름" autocomplete="name"/>
          <input id="signup-affil" type="text" placeholder="소속" autocomplete="organization"/>
          <input id="signup-id" type="text" placeholder="이메일" autocomplete="username"/>
          <div style="position:relative;width:100%;">
            <input id="signup-pw" type="password" placeholder="비밀번호" autocomplete="new-password" style="width:100%;"/>
            <span id="pw-eye" style="position:absolute;right:12px;top:14px;cursor:pointer;font-size:1.2em;color:#b3b8c5;">👁️</span>
          </div>
          <button onclick="signup()">회원가입</button>
          <button onclick="renderLogin()" style="background:#232837;color:#fff;">로그인 화면</button>
          <div class="error-msg" id="signup-error"></div>
        </div>
      `;
      document.getElementById('pw-eye').onclick = function(){
        const pw = document.getElementById('signup-pw');
        pw.type = pw.type==='password'?'text':'password';
      };
    }
    // 회원가입 함수
    function signup() {
      const name = document.getElementById('signup-name').value.trim();
      const affil = document.getElementById('signup-affil').value.trim();
      const email = document.getElementById('signup-id').value.trim();
      const pw = document.getElementById('signup-pw').value.trim();
      
      if (!name || !email || !pw) {
        document.getElementById('signup-error').textContent = '모든 필드를 입력해주세요.';
        return;
      }

      // 이메일 도메인 확인
      if (!email.endsWith('@naver.com')) {
        document.getElementById('signup-error').textContent = 'naver.com 이메일만 사용 가능합니다.';
        return;
      }

      let role = email === 'fire8803@naver.com' ? 'master' : 'admin';
      
      firebase.auth().createUserWithEmailAndPassword(email, pw)
        .then((userCredential) => {
          db.collection('users').doc(userCredential.user.uid).set({
            name, affil, email, pw, role, createdAt: new Date()
          });
          alert('회원가입이 완료되었습니다.');
          renderLogin();
        })
        .catch((e) => {
          document.getElementById('signup-error').textContent = '회원가입 실패: ' + (e.message || '오류');
        });
    }
    // 로그인 화면
    function renderLogin() {
      document.getElementById('main').innerHTML = `
        <div class="login-box">
          <h2>로그인</h2>
          <input id="login-id" type="text" placeholder="이메일" autocomplete="username"/>
          <input id="login-pw" type="password" placeholder="비밀번호" autocomplete="current-password"/>
          <button onclick="login()">로그인</button>
          <button onclick="renderSignup()" style="background:#232837;color:#fff;">회원가입</button>
          <div class="error-msg" id="login-error"></div>
        </div>
      `;

      // 엔터키로 로그인
      document.getElementById('login-pw').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          login();
        }
      });
    }
    // 로그인 함수(로그인 후 Firestore에서 role 확인)
    function login() {
      const id = document.getElementById('login-id').value.trim();
      const pw = document.getElementById('login-pw').value.trim();
      firebase.auth().signInWithEmailAndPassword(id, pw)
        .then(() => {
          // 인증 상태 감시에서 처리
        })
        .catch(() => {
          document.getElementById('login-error').textContent = '이메일 또는 비밀번호가 올바르지 않습니다.';
        });
    }
    // 로그아웃
    function logout() {
      firebase.auth().signOut().then(renderLogin);
    }
    // 회원 관리(권한별 4개 테이블, 전체리스트, 체크박스 일괄삭제, 엑셀, 실시간)
    function renderUsers() {
      renderMenu('users');
      const content = document.getElementById('content');
      content.innerHTML = `<h2>회원명단</h2>
        <div style='display:flex;gap:8px;margin-bottom:16px;'>
          <button onclick='renderUsers()' style='background:#3b82f6;color:#fff;border:none;border-radius:6px;padding:8px 16px;'>권한별 보기</button>
          <button onclick='renderAllUsers()' style='background:#232837;color:#fff;border:none;border-radius:6px;padding:8px 16px;'>전체 회원리스트</button>
          <button onclick='downloadUsersExcel()' style='background:#22c55e;color:#fff;border:none;border-radius:6px;padding:8px 16px;'>엑셀 다운로드</button>
          <label style='background:#3b82f6;color:#fff;border:none;border-radius:6px;padding:8px 16px;cursor:pointer;'>엑셀 업로드<input type='file' id='users-excel-upload' accept='.xlsx,.xls' style='display:none;' onchange='uploadUsersExcel(this)'></label>
        </div>
        <div id='users-tables'></div>`;
      db.collection('users').onSnapshot(snapshot => {
        const users = [];
        snapshot.forEach(doc => {
          const d = doc.data();
          users.push({id: doc.id, ...d});
        });
        renderUserTables(users);
      });
    }
    function renderUserTables(users) {
      const tables = [
        {title:'요청', key:'요청', order:0},
        {title:'대마팀', key:'대마팀', order:1},
        {title:'기타', key:'기타', order:2},
        {title:'관리자', key:'admin', order:3},
        {title:'마스터', key:'master', order:4}
      ];
      let html = '';
      tables.forEach(t => {
        let filtered = users.filter(u => (u.role||'').includes(t.key));
        if(t.key==='기타') filtered = users.filter(u => u.role && !['요청','대마팀','admin','master'].includes(u.role));
        if(t.key==='admin') filtered = users.filter(u => u.role==='admin');
        if(t.key==='master') filtered = users.filter(u => u.role==='master');
        if(filtered.length===0) return;
        html += `<div style='margin-bottom:24px;'><h3 style='color:#3b82f6;'>${t.title} (${filtered.length})</h3>`;
        html += `<div style='max-height:260px;overflow-y:auto;'>`;
        html += `<table style='width:100%;'><thead><tr>${t.key!=='admin'&&t.key!=='master'?'<th><input type="checkbox" onclick="toggleAllUsers(this,\''+t.key+'\')"></th>':''}<th>이름</th><th>아이디</th><th>비밀번호</th><th>소속</th><th>권한</th><th>관리</th></tr></thead><tbody>`;
        filtered.forEach(u => {
          html += `<tr>
            ${t.key!=='admin'&&t.key!=='master'?`<td><input type='checkbox' class='user-chk-${t.key}' value='${u.id}'></td>`:''}
            <td><input type='text' value='${u.name||''}' id='uname-${u.id}' style='width:80px;padding:4px;border-radius:4px;border:1px solid #2d3344;background:#232837;color:#fff;'></td>
            <td>${u.email||''}</td>
            <td><input type='password' value='${u.pw||''}' id='upw-${u.id}' style='width:100px;padding:4px;border-radius:4px;border:1px solid #2d3344;background:#232837;color:#fff;'><span style='cursor:pointer;margin-left:6px;' onclick='togglePw("upw-${u.id}")'>👁️</span></td>
            <td><input type='text' value='${u.affil||''}' id='uaffil-${u.id}' style='width:100px;padding:4px;border-radius:4px;border:1px solid #2d3344;background:#232837;color:#fff;'></td>
            <td><select id='urole-${u.id}' style='padding:4px 8px;border-radius:4px;background:#232837;color:#fff;'>
              <option value='요청' ${u.role==='요청'?'selected':''}>요청</option>
              <option value='대마팀' ${u.role==='대마팀'?'selected':''}>대마팀</option>
              <option value='기타' ${u.role!=='요청'&&u.role!=='대마팀'&&u.role!=='admin'&&u.role!=='master'?'selected':''}>기타</option>
              <option value='admin' ${u.role==='admin'?'selected':''}>관리자</option>
              <option value='master' ${u.role==='master'?'selected':''}>마스터</option>
            </select></td>
            <td><button onclick='updateUser("${u.id}")' style='background:#3b82f6;color:#fff;border:none;border-radius:6px;padding:4px 12px;margin-right:4px;'>수정</button>${t.key!=='admin'&&t.key!=='master'?`<button onclick='deleteUser("${u.id}")' style='background:#ef4444;color:#fff;border:none;border-radius:6px;padding:4px 12px;'>삭제</button>`:''}</td>
          </tr>`;
        });
        html += `</tbody></table>`;
        if(filtered.length>5) html += `<div style='height:8px;'></div>`;
        if(t.key!=='admin'&&t.key!=='master') html += `<button onclick='deleteCheckedUsers("${t.key}")' style='background:#ef4444;color:#fff;border:none;border-radius:6px;padding:4px 16px;margin-top:8px;'>선택삭제</button>`;
        html += `</div></div>`;
      });
      document.getElementById('users-tables').innerHTML = html;
    }
    window.togglePw = function(id) {
      const input = document.getElementById(id);
      input.type = input.type==='password'?'text':'password';
    }
    window.toggleAllUsers = function(chk, role) {
      document.querySelectorAll('.user-chk-'+role).forEach(c=>c.checked=chk.checked);
    }
    window.deleteCheckedUsers = function(role) {
      const ids = Array.from(document.querySelectorAll('.user-chk-'+role+':checked')).map(c=>c.value);
      if(ids.length===0) return;
      if(!confirm('정말 삭제하시겠습니까?')) return;
      ids.forEach(id=>db.collection('users').doc(id).delete());
    }
    window.updateUser = function(id) {
      const name = document.getElementById('uname-'+id).value.trim();
      const pw = document.getElementById('upw-'+id).value.trim();
      const affil = document.getElementById('uaffil-'+id).value.trim();
      let role = document.getElementById('urole-'+id).value;
      if(role==='기타') role = '기타';
      db.collection('users').doc(id).update({ name, pw, affil, role, updatedAt: new Date() });
    }
    window.deleteUser = function(id) {
      if(confirm('정말 삭제하시겠습니까?')) db.collection('users').doc(id).delete();
    }
    // 전체 회원리스트
    function renderAllUsers() {
      renderMenu('users');
      const content = document.getElementById('content');
      content.innerHTML = `<h2>전체 회원리스트</h2>
        <div style='display:flex;gap:8px;margin-bottom:16px;'>
          <button onclick='renderUsers()' style='background:#232837;color:#fff;border:none;border-radius:6px;padding:8px 16px;'>권한별 보기</button>
          <button onclick='downloadUsersExcel()' style='background:#22c55e;color:#fff;border:none;border-radius:6px;padding:8px 16px;'>엑셀 다운로드</button>
          <label style='background:#3b82f6;color:#fff;border:none;border-radius:6px;padding:8px 16px;cursor:pointer;'>엑셀 업로드<input type='file' id='users-excel-upload' accept='.xlsx,.xls' style='display:none;' onchange='uploadUsersExcel(this)'></label>
        </div>
        <div id='all-users-table'></div>`;
      db.collection('users').onSnapshot(snapshot => {
        const users = [];
        snapshot.forEach(doc => {
          const d = doc.data();
          users.push({id: doc.id, ...d});
        });
        let html = `<div style='max-height:400px;overflow-y:auto;'><table style='width:100%;'><thead><tr><th>이름</th><th>아이디</th><th>비밀번호</th><th>소속</th><th>권한</th><th>관리</th></tr></thead><tbody>`;
        users.forEach(u => {
          html += `<tr>
            <td><input type='text' value='${u.name||''}' id='uname-${u.id}' style='width:80px;padding:4px;border-radius:4px;border:1px solid #2d3344;background:#232837;color:#fff;'></td>
            <td>${u.email||''}</td>
            <td><input type='password' value='${u.pw||''}' id='upw-${u.id}' style='width:100px;padding:4px;border-radius:4px;border:1px solid #2d3344;background:#232837;color:#fff;'><span style='cursor:pointer;margin-left:6px;' onclick='togglePw("upw-${u.id}")'>👁️</span></td>
            <td><input type='text' value='${u.affil||''}' id='uaffil-${u.id}' style='width:100px;padding:4px;border-radius:4px;border:1px solid #2d3344;background:#232837;color:#fff;'></td>
            <td><select id='urole-${u.id}' style='padding:4px 8px;border-radius:4px;background:#232837;color:#fff;'>
              <option value='요청' ${u.role==='요청'?'selected':''}>요청</option>
              <option value='대마팀' ${u.role==='대마팀'?'selected':''}>대마팀</option>
              <option value='기타' ${u.role!=='요청'&&u.role!=='대마팀'&&u.role!=='admin'&&u.role!=='master'?'selected':''}>기타</option>
              <option value='admin' ${u.role==='admin'?'selected':''}>관리자</option>
              <option value='master' ${u.role==='master'?'selected':''}>마스터</option>
            </select></td>
            <td><button onclick='updateUser("${u.id}")' style='background:#3b82f6;color:#fff;border:none;border-radius:6px;padding:4px 12px;margin-right:4px;'>수정</button><button onclick='deleteUser("${u.id}")' style='background:#ef4444;color:#fff;border:none;border-radius:6px;padding:4px 12px;'>삭제</button></td>
          </tr>`;
        });
        html += `</tbody></table></div>`;
        document.getElementById('all-users-table').innerHTML = html;
      });
    }
    // 엑셀 다운로드/업로드
    window.downloadUsersExcel = function() {
      db.collection('users').get().then(snapshot => {
        const data = snapshot.docs.map(doc => {
          const d = doc.data();
          return {
            '이름': d.name||'',
            '아이디': d.email||'',
            '비밀번호': d.pw||'',
            '소속': d.affil||'',
            '권한': d.role||'',
            '가입일': d.createdAt?d.createdAt.toDate().toLocaleString():'',
          };
        });
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, '회원명단');
        XLSX.writeFile(wb, '회원명단.xlsx');
      });
    }
    window.uploadUsersExcel = function(input) {
      const file = input.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, {type: 'array'});
        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(firstSheet);
        jsonData.forEach(row => {
          db.collection('users').add({
            name: row['이름']||'',
            email: row['아이디']||'',
            pw: row['비밀번호']||'',
            affil: row['소속']||'',
            role: row['권한']||'',
            createdAt: new Date(row['가입일']||Date.now())
          });
        });
        alert('엑셀 데이터가 업로드되었습니다.');
        input.value = '';
      };
      reader.readAsArrayBuffer(file);
    }

    // 권한설정 화면
    function renderRoleSettings() {
      renderMenu('roles');
      const content = document.getElementById('content');
      // 메뉴별 권한(읽기/쓰기/수정/삭제)
      const menus = [
        {key:'sites', label:'현장'},
        {key:'status', label:'공사현황'},
        {key:'discussion', label:'협의하기'},
        {key:'progress', label:'기성현황'},
        {key:'partners', label:'거래처'},
        {key:'users', label:'회원명단'},
        {key:'roles', label:'권한설정'}
      ];
      content.innerHTML = `<h2>권한설정</h2><form id='role-form'><table style='width:100%;'><thead><tr><th>메뉴</th><th>읽기</th><th>쓰기</th><th>수정</th><th>삭제</th></tr></thead><tbody id='role-tbody'></tbody></table><button type='submit' style='background:#22c55e;color:#fff;border:none;border-radius:6px;padding:10px 28px;font-weight:700;margin-top:18px;'>저장</button></form>`;
      db.collection('role_settings').doc('default').get().then(docSnap => {
        const data = docSnap.exists ? docSnap.data() : {};
        let html = '';
        menus.forEach(m => {
          html += `<tr><td>${m.label}</td>`;
          ['read','write','update','delete'].forEach(act => {
            html += `<td><input type='checkbox' name='${m.key}-${act}' ${data[m.key]&&data[m.key][act]?'checked':''}></td>`;
          });
          html += '</tr>';
        });
        document.getElementById('role-tbody').innerHTML = html;
      });
      document.getElementById('role-form').onsubmit = function(e) {
        e.preventDefault();
        const data = {};
        menus.forEach(m => {
          data[m.key] = {
            read: document.querySelector(`input[name='${m.key}-read']`).checked,
            write: document.querySelector(`input[name='${m.key}-write']`).checked,
            update: document.querySelector(`input[name='${m.key}-update']`).checked,
            delete: document.querySelector(`input[name='${m.key}-delete']`).checked
          };
        });
        db.collection('role_settings').doc('default').set(data).then(()=>{
          alert('권한이 저장되었습니다.');
        });
      }
    }

    // 공사현황(달력+현장리스트+추가사항) Firestore 연동 1차 구현 (날짜별 현장/추가사항 표시, 팝업 추가)
    function renderStatus() {
      renderMenu('status');
      const content = document.getElementById('content');
      // 월 네비게이션
      let today = window.statusToday || new Date();
      let year = today.getFullYear();
      let month = today.getMonth();
      let firstDay = new Date(year, month, 1).getDay();
      let lastDate = new Date(year, month+1, 0).getDate();
      db.collection('sites').get().then(siteSnap => {
        const sites = [];
        siteSnap.forEach(doc => sites.push(doc.data()));
        db.collection('status_calendar').doc(`${year}-${month+1}`).get().then(calDoc => {
          const calendarData = calDoc.exists ? calDoc.data() : {};
          // 달력 UI
          let calHtml = `<div style='display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;'>
            <button onclick='changeStatusMonth(-1)' style='background:#232837;color:#fff;border:none;border-radius:6px;padding:6px 18px;font-size:1.2rem;'>&lt;</button>
            <span style='font-size:1.3rem;font-weight:700;'>${year}년 ${month+1}월</span>
            <button onclick='changeStatusMonth(1)' style='background:#232837;color:#fff;border:none;border-radius:6px;padding:6px 18px;font-size:1.2rem;'>&gt;</button>
          </div>`;
          calHtml += `<table style='width:100%;table-layout:fixed;'><thead><tr>`;
          const weekDays = ['일','월','화','수','목','금','토'];
          for(let i=0;i<7;i++) calHtml += `<th style='color:${i===0?'#ef4444':'#3b82f6'}'>${weekDays[i]}</th>`;
          calHtml += `</tr></thead><tbody><tr>`;
          let day = 1;
          for(let i=0;i<firstDay;i++) calHtml += '<td></td>';
          for(let i=firstDay;i<7;i++) {
            calHtml += renderCalendarCell(day, calendarData, sites);
            day++;
          }
          calHtml += '</tr>';
          while(day<=lastDate) {
            calHtml += '<tr>';
            for(let i=0;i<7;i++) {
              if(day>lastDate) { calHtml += '<td></td>'; continue; }
              calHtml += renderCalendarCell(day, calendarData, sites);
              day++;
            }
            calHtml += '</tr>';
          }
          calHtml += '</tbody></table>';
          // 현장 리스트
          let siteHtml = `<div style='margin-top:24px;'><b>현장 리스트</b><ul style='padding-left:18px;'>`;
          sites.forEach(s=>{siteHtml+=`<li>${s.name||''} (${s.status||''})</li>`});
          siteHtml += '</ul></div>';
          content.innerHTML = `<h2>공사현황</h2>${calHtml}${siteHtml}`;
        });
      });
    }
    // 달력 셀 렌더링 (날짜별 현장/추가사항 표시, 클릭 시 팝업)
    function renderCalendarCell(day, calendarData, sites) {
      let cell = `<td style='vertical-align:top;height:60px;position:relative;cursor:pointer;' onclick='showStatusPopup(${day})'>`;
      cell += `<div style='position:absolute;top:4px;right:8px;font-size:1rem;font-weight:700;'>${day}</div>`;
      let items = (calendarData[day]||[]);
      if(items.length>0) {
        cell += `<div style='margin-top:22px;'>`;
        items.forEach((item,idx)=>{
          if(item.type==='site') cell += `<div style='background:#3b82f6;color:#fff;border-radius:4px;padding:2px 6px;margin:2px 0;font-size:0.95em;'>${item.value}</div>`;
          if(item.type==='extra') cell += `<div style='background:#232837;color:#fff;border-radius:4px;padding:2px 6px;margin:2px 0;font-size:0.95em;'>${item.value}</div>`;
        });
        cell += `</div>`;
      }
      cell += `</td>`;
      return cell;
    }
    // 팝업 표시 함수(현장/추가사항 추가/삭제)
    window.showStatusPopup = function(day) {
      let today = window.statusToday || new Date();
      let year = today.getFullYear();
      let month = today.getMonth();
      const popupBg = document.createElement('div');
      popupBg.style.cssText = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.4);z-index:2000;display:flex;align-items:center;justify-content:center;';
      popupBg.onclick = function(e){ if(e.target===popupBg) popupBg.remove(); };
      db.collection('status_calendar').doc(`${year}-${month+1}`).get().then(docSnap => {
        const data = docSnap.exists ? docSnap.data() : {};
        const items = data[day]||[];
        let html = `<div style='background:#232837;padding:32px 28px 24px 28px;border-radius:16px;min-width:320px;max-width:90vw;box-shadow:0 4px 32px #0005;position:relative;'>
          <button onclick='this.parentNode.parentNode.remove()' style='position:absolute;right:16px;top:16px;background:none;border:none;color:#b3b8c5;font-size:1.3rem;cursor:pointer;'>&times;</button>
          <h3 style='margin:0 0 18px 0;color:#3b82f6;'>${year}년 ${month+1}월 ${day}일</h3>
          <div><b>현장/추가사항</b></div>
          <ul style='padding-left:18px;margin-bottom:12px;'>`;
        items.forEach((item,idx)=>{
          html += `<li style='margin-bottom:4px;'>
            <span style='background:${item.type==='site'?'#3b82f6':'#232837'};color:#fff;border-radius:4px;padding:2px 8px;'>${item.value}</span>
            <button onclick='deleteStatusItem(${day},${idx})' style='background:#ef4444;color:#fff;border:none;border-radius:4px;padding:2px 8px;margin-left:6px;font-size:0.95em;'>삭제</button>
          </li>`;
        });
        html += `</ul>
          <form id='popup-add-form' style='display:flex;gap:8px;margin-top:8px;'>
            <select id='popup-type' style='padding:6px 8px;border-radius:6px;'>
              <option value='site'>현장</option>
              <option value='extra'>추가사항</option>
            </select>
            <input id='popup-value' type='text' placeholder='내용 입력' style='flex:1;padding:6px 8px;border-radius:6px;'>
            <button type='submit' style='background:#22c55e;color:#fff;border:none;border-radius:6px;padding:6px 16px;'>추가</button>
          </form>
        </div>`;
        popupBg.innerHTML = html;
        document.body.appendChild(popupBg);
        document.getElementById('popup-add-form').onsubmit = function(e) {
          e.preventDefault();
          const type = document.getElementById('popup-type').value;
          const value = document.getElementById('popup-value').value.trim();
          if(!value) return;
          const calRef = db.collection('status_calendar').doc(`${year}-${month+1}`);
          calRef.get().then(docSnap2 => {
            let data2 = docSnap2.exists ? docSnap2.data() : {};
            if(!data2[day]) data2[day]=[];
            data2[day].push({type,value});
            calRef.set(data2).then(()=>{
              popupBg.remove();
              renderStatus();
            });
          });
        };
      });
    }
    // 삭제 함수
    window.deleteStatusItem = function(day, idx) {
      let today = window.statusToday || new Date();
      let year = today.getFullYear();
      let month = today.getMonth();
      const calRef = db.collection('status_calendar').doc(`${year}-${month+1}`);
      calRef.get().then(docSnap => {
        let data = docSnap.exists ? docSnap.data() : {};
        if(!data[day]) return;
        data[day].splice(idx,1);
        calRef.set(data).then(()=>{
          renderStatus();
        });
      });
    }
    // 월 네비게이션 함수
    function changeStatusMonth(diff) {
      let today = window.statusToday || new Date();
      today = new Date(today.getFullYear(), today.getMonth()+diff, 1);
      window.statusToday = today;
      renderStatus();
    }

    // 협의하기 화면
    function renderDiscussion() {
      renderMenu('discussion');
      const content = document.getElementById('content');
      
      // 검색 및 필터
      let filterHtml = `
        <div style='display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;'>
          <div style='display:flex;gap:8px;'>
            <input type='text' id='discussion-search' placeholder='제목/내용 검색' style='padding:8px 12px;border-radius:6px;border:1.5px solid #2d3344;background:#181c24;color:#fff;width:300px;'>
            <button onclick='searchDiscussion()' style='background:#3b82f6;color:#fff;border:none;border-radius:6px;padding:8px 16px;'>검색</button>
          </div>
          <button onclick='downloadDiscussionExcel()' style='background:#22c55e;color:#fff;border:none;border-radius:6px;padding:8px 16px;'>엑셀 다운로드</button>
        </div>`;

      // 작성 폼
      let formHtml = `
        <form id="discussion-form" style="margin-bottom:32px;">
          <div style="margin-bottom:16px;">
            <input type="text" id="discussion-title" placeholder="제목" style="width:100%;padding:12px;border-radius:6px;border:1.5px solid #2d3344;background:#181c24;color:#fff;font-size:1.1rem;" required>
          </div>
          <div style="margin-bottom:16px;">
            <div style="display:flex;gap:8px;margin-bottom:8px;">
              <input type="text" id="discussion-site-search" placeholder="현장 검색" style="padding:8px 12px;border-radius:6px;border:1.5px solid #2d3344;background:#181c24;color:#fff;width:200px;">
              <button type="button" onclick="searchDiscussionSites()" style="background:#3b82f6;color:#fff;border:none;border-radius:6px;padding:8px 16px;">검색</button>
            </div>
            <div id="sites-checkbox-list" style="max-height:200px;overflow-y:auto;padding:12px;border:1.5px solid #2d3344;border-radius:6px;background:#181c24;"></div>
          </div>
          <div style="margin-bottom:16px;">
            <textarea id="discussion-content" placeholder="협의 내용" style="width:100%;min-height:200px;padding:12px;border-radius:6px;border:1.5px solid #2d3344;background:#181c24;color:#fff;font-size:1rem;" required></textarea>
          </div>
          <div style="margin-bottom:16px;">
            <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;">
              <input type="file" id="discussion-images" multiple accept="image/*" style="display:none;" onchange="previewImages(this)">
              <label style="background:#3b82f6;color:#fff;border:none;border-radius:6px;padding:8px 16px;cursor:pointer;">
                사진 추가
                <input type="file" id="discussion-images" multiple accept="image/*" style="display:none;" onchange="previewImages(this)">
              </label>
            </div>
            <div id="image-preview" style="display:flex;gap:8px;flex-wrap:wrap;"></div>
          </div>
          <button type="submit" style="background:#22c55e;color:#fff;border:none;border-radius:6px;padding:12px 24px;font-weight:700;font-size:1.1rem;">작성하기</button>
        </form>`;

      content.innerHTML = `<h2>협의하기</h2>${filterHtml}${formHtml}<div id="discussion-list"></div>`;

      // 현장 목록 로드
      loadDiscussionSites();

      // 폼 이벤트 리스너
      document.getElementById('discussion-form').onsubmit = function(e) {
        e.preventDefault();
        const title = document.getElementById('discussion-title').value.trim();
        const content = document.getElementById('discussion-content').value.trim();
        const selectedSites = Array.from(document.querySelectorAll('input[name="discussion-sites"]:checked')).map(cb => ({
          id: cb.value,
          name: cb.getAttribute('data-name')
        }));
        const images = window.discussionImages || [];

        if (!title || !content || selectedSites.length === 0) {
          alert('제목, 내용, 현장을 모두 입력해주세요.');
          return;
        }

        // 이미지 업로드
        Promise.all(images.map(file => {
          const storageRef = firebase.storage().ref();
          const imageRef = storageRef.child(`discussions/${Date.now()}_${file.name}`);
          return imageRef.put(file).then(snapshot => snapshot.ref.getDownloadURL());
        })).then(imageUrls => {
          // 협의 내용 저장
          db.collection('discussions').add({
            title,
            content,
            sites: selectedSites,
            images: imageUrls,
            author: {
              uid: firebase.auth().currentUser.uid,
              email: firebase.auth().currentUser.email
            },
            createdAt: new Date()
          }).then(() => {
            // 폼 초기화
            document.getElementById('discussion-title').value = '';
            document.getElementById('discussion-content').value = '';
            document.querySelectorAll('input[name="discussion-sites"]').forEach(cb => cb.checked = false);
            document.getElementById('image-preview').innerHTML = '';
            window.discussionImages = [];
          });
        });
      };

      // 협의 목록 로드
      loadDiscussions();
    }

    // 현장 목록 로드
    function loadDiscussionSites() {
      const container = document.getElementById('sites-checkbox-list');
      db.collection('sites').get().then(snapshot => {
        let html = '';
        snapshot.forEach(doc => {
          const d = doc.data();
          html += `
            <div style="margin-bottom:8px;">
              <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                <input type="checkbox" name="discussion-sites" value="${doc.id}" data-name="${d.name}" style="width:16px;height:16px;">
                <span>${d.name} (${d.status})</span>
              </label>
            </div>`;
        });
        container.innerHTML = html;
      });
    }

    // 현장 검색
    window.searchDiscussionSites = function() {
      const keyword = document.getElementById('discussion-site-search').value.trim().toLowerCase();
      const checkboxes = document.querySelectorAll('input[name="discussion-sites"]');
      
      checkboxes.forEach(cb => {
        const name = cb.getAttribute('data-name').toLowerCase();
        const parent = cb.parentNode.parentNode;
        parent.style.display = name.includes(keyword) ? 'block' : 'none';
      });
    }

    // 이미지 미리보기
    window.previewImages = function(input) {
      const preview = document.getElementById('image-preview');
      window.discussionImages = window.discussionImages || [];
      
      Array.from(input.files).forEach(file => {
        window.discussionImages.push(file);
        const reader = new FileReader();
        reader.onload = function(e) {
          preview.innerHTML += `
            <div style="position:relative;width:100px;height:100px;">
              <img src="${e.target.result}" style="width:100%;height:100%;object-fit:cover;border-radius:6px;">
              <button onclick="removeImage(this)" style="position:absolute;top:-8px;right:-8px;background:#ef4444;color:#fff;border:none;border-radius:50%;width:20px;height:20px;font-size:14px;cursor:pointer;">×</button>
            </div>`;
        };
        reader.readAsDataURL(file);
      });
    }

    // 이미지 제거
    window.removeImage = function(btn) {
      const index = Array.from(btn.parentNode.parentNode.children).indexOf(btn.parentNode);
      window.discussionImages.splice(index, 1);
      btn.parentNode.remove();
    }

    // 협의 목록 로드
    function loadDiscussions() {
      const container = document.getElementById('discussion-list');
      db.collection('discussions').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
        let html = '';
        snapshot.forEach(doc => {
          const d = doc.data();
          const isAuthor = d.author.uid === firebase.auth().currentUser.uid;
          const isAdmin = window.currentUserRole === 'admin' || window.currentUserRole === 'master';
          
          html += `
            <div style="background:#232837;border-radius:12px;padding:24px;margin-bottom:16px;">
              <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:16px;">
                <div>
                  <h3 style="margin:0 0 8px 0;color:#3b82f6;">${d.title}</h3>
                  <div style="color:#b3b8c5;font-size:0.9rem;">
                    작성자: ${d.author.email} | ${d.createdAt.toDate().toLocaleString()}
                  </div>
                </div>
                ${isAuthor || isAdmin ? `
                  <div style="display:flex;gap:8px;">
                    <button onclick="editDiscussion('${doc.id}')" style="background:#3b82f6;color:#fff;border:none;border-radius:6px;padding:6px 12px;">수정</button>
                    <button onclick="deleteDiscussion('${doc.id}')" style="background:#ef4444;color:#fff;border:none;border-radius:6px;padding:6px 12px;">삭제</button>
                  </div>
                ` : ''}
              </div>
              <div style="margin-bottom:16px;">
                <div style="color:#b3b8c5;margin-bottom:8px;">관련 현장:</div>
                <div style="display:flex;gap:8px;flex-wrap:wrap;">
                  ${d.sites.map(site => `
                    <span style="background:#181c24;color:#fff;padding:4px 8px;border-radius:4px;">${site.name}</span>
                  `).join('')}
                </div>
              </div>
              <div style="margin-bottom:16px;white-space:pre-wrap;">${d.content}</div>
              ${d.images && d.images.length > 0 ? `
                <div style="display:flex;gap:8px;flex-wrap:wrap;">
                  ${d.images.map(url => `
                    <img src="${url}" style="width:100px;height:100px;object-fit:cover;border-radius:6px;cursor:pointer;" onclick="showImage('${url}')">
                  `).join('')}
                </div>
              ` : ''}
            </div>`;
        });
        container.innerHTML = html;
      });
    }

    // 이미지 확대보기
    window.showImage = function(url) {
      const popupBg = document.createElement('div');
      popupBg.style.cssText = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.8);z-index:2000;display:flex;align-items:center;justify-content:center;';
      popupBg.onclick = function(e){ if(e.target===popupBg) popupBg.remove(); };
      popupBg.innerHTML = `<img src="${url}" style="max-width:90vw;max-height:90vh;object-fit:contain;">`;
      document.body.appendChild(popupBg);
    }

    // 협의 수정
    window.editDiscussion = function(id) {
      db.collection('discussions').doc(id).get().then(doc => {
        const d = doc.data();
        document.getElementById('discussion-title').value = d.title;
        document.getElementById('discussion-content').value = d.content;
        document.querySelectorAll('input[name="discussion-sites"]').forEach(cb => {
          cb.checked = d.sites.some(site => site.id === cb.value);
        });
        
        // 이미지 미리보기
        const preview = document.getElementById('image-preview');
        preview.innerHTML = '';
        if (d.images && d.images.length > 0) {
          d.images.forEach(url => {
            preview.innerHTML += `
              <div style="position:relative;width:100px;height:100px;">
                <img src="${url}" style="width:100%;height:100%;object-fit:cover;border-radius:6px;">
                <button onclick="removeImage(this)" style="position:absolute;top:-8px;right:-8px;background:#ef4444;color:#fff;border:none;border-radius:50%;width:20px;height:20px;font-size:14px;cursor:pointer;">×</button>
              </div>`;
          });
        }
        
        // 폼 제출 이벤트 변경
        const form = document.getElementById('discussion-form');
        form.onsubmit = function(e) {
          e.preventDefault();
          const title = document.getElementById('discussion-title').value.trim();
          const content = document.getElementById('discussion-content').value.trim();
          const selectedSites = Array.from(document.querySelectorAll('input[name="discussion-sites"]:checked')).map(cb => ({
            id: cb.value,
            name: cb.getAttribute('data-name')
          }));
          const images = window.discussionImages || [];

          if (!title || !content || selectedSites.length === 0) {
            alert('제목, 내용, 현장을 모두 입력해주세요.');
            return;
          }

          // 새 이미지 업로드
          Promise.all(images.map(file => {
            const storageRef = firebase.storage().ref();
            const imageRef = storageRef.child(`discussions/${Date.now()}_${file.name}`);
            return imageRef.put(file).then(snapshot => snapshot.ref.getDownloadURL());
          })).then(newImageUrls => {
            // 기존 이미지와 새 이미지 합치기
            const existingImages = Array.from(document.querySelectorAll('#image-preview img')).map(img => img.src);
            const allImages = [...existingImages, ...newImageUrls];

            // 협의 내용 업데이트
            db.collection('discussions').doc(id).update({
              title,
              content,
              sites: selectedSites,
              images: allImages,
              updatedAt: new Date()
            }).then(() => {
              // 폼 초기화
              document.getElementById('discussion-title').value = '';
              document.getElementById('discussion-content').value = '';
              document.querySelectorAll('input[name="discussion-sites"]').forEach(cb => cb.checked = false);
              document.getElementById('image-preview').innerHTML = '';
              window.discussionImages = [];
              
              // 폼 이벤트 리스너 원래대로 복구
              form.onsubmit = null;
              renderDiscussion();
            });
          });
        };
      });
    }

    // 협의 삭제
    window.deleteDiscussion = function(id) {
      if (confirm('정말 삭제하시겠습니까?')) {
        db.collection('discussions').doc(id).delete();
      }
    }

    // 협의 검색
    window.searchDiscussion = function() {
      const keyword = document.getElementById('discussion-search').value.trim().toLowerCase();
      if (!keyword) {
        loadDiscussions();
        return;
      }

      db.collection('discussions').get().then(snapshot => {
        const container = document.getElementById('discussion-list');
        let html = '';
        
        snapshot.forEach(doc => {
          const d = doc.data();
          if (
            d.title.toLowerCase().includes(keyword) ||
            d.content.toLowerCase().includes(keyword) ||
            d.sites.some(site => site.name.toLowerCase().includes(keyword))
          ) {
            const isAuthor = d.author.uid === firebase.auth().currentUser.uid;
            const isAdmin = window.currentUserRole === 'admin' || window.currentUserRole === 'master';
            
            html += `
              <div style="background:#232837;border-radius:12px;padding:24px;margin-bottom:16px;">
                <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:16px;">
                  <div>
                    <h3 style="margin:0 0 8px 0;color:#3b82f6;">${d.title}</h3>
                    <div style="color:#b3b8c5;font-size:0.9rem;">
                      작성자: ${d.author.email} | ${d.createdAt.toDate().toLocaleString()}
                    </div>
                  </div>
                  ${isAuthor || isAdmin ? `
                    <div style="display:flex;gap:8px;">
                      <button onclick="editDiscussion('${doc.id}')" style="background:#3b82f6;color:#fff;border:none;border-radius:6px;padding:6px 12px;">수정</button>
                      <button onclick="deleteDiscussion('${doc.id}')" style="background:#ef4444;color:#fff;border:none;border-radius:6px;padding:6px 12px;">삭제</button>
                    </div>
                  ` : ''}
                </div>
                <div style="margin-bottom:16px;">
                  <div style="color:#b3b8c5;margin-bottom:8px;">관련 현장:</div>
                  <div style="display:flex;gap:8px;flex-wrap:wrap;">
                    ${d.sites.map(site => `
                      <span style="background:#181c24;color:#fff;padding:4px 8px;border-radius:4px;">${site.name}</span>
                    `).join('')}
                  </div>
                </div>
                <div style="margin-bottom:16px;white-space:pre-wrap;">${d.content}</div>
                ${d.images && d.images.length > 0 ? `
                  <div style="display:flex;gap:8px;flex-wrap:wrap;">
                    ${d.images.map(url => `
                      <img src="${url}" style="width:100px;height:100px;object-fit:cover;border-radius:6px;cursor:pointer;" onclick="showImage('${url}')">
                    `).join('')}
                  </div>
                ` : ''}
              </div>`;
          }
        });
        
        container.innerHTML = html;
      });
    }

    // 엑셀 다운로드
    window.downloadDiscussionExcel = function() {
      db.collection('discussions').get().then(snapshot => {
        const data = snapshot.docs.map(doc => {
          const d = doc.data();
          return {
            '제목': d.title || '',
            '작성자': d.author.email || '',
            '작성일': d.createdAt ? d.createdAt.toDate().toLocaleString() : '',
            '관련 현장': d.sites.map(site => site.name).join(', '),
            '내용': d.content || '',
            '이미지 수': d.images ? d.images.length : 0
          };
        });

        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, '협의목록');
        XLSX.writeFile(wb, '협의목록.xlsx');
      });
    }

    // 기성현황 화면
    function renderProgress() {
      renderMenu('progress');
      const content = document.getElementById('content');
      // 검색/엑셀
      let filterHtml = `
        <div style='display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;'>
          <div style='display:flex;gap:8px;'>
            <input type='text' id='progress-search' placeholder='현장명/회사/소장/내용 검색' style='padding:8px 12px;border-radius:6px;border:1.5px solid #2d3344;background:#181c24;color:#fff;width:300px;'>
            <button onclick='searchProgress()' style='background:#3b82f6;color:#fff;border:none;border-radius:6px;padding:8px 16px;'>검색</button>
          </div>
          <button onclick='downloadProgressExcel()' style='background:#22c55e;color:#fff;border:none;border-radius:6px;padding:8px 16px;'>엑셀 다운로드</button>
        </div>`;
      // 작성 폼
      let formHtml = `
        <form id="progress-form" style="margin-bottom:32px;">
          <div style="margin-bottom:16px;">
            <select id="progress-site" style="width:100%;padding:12px;border-radius:6px;border:1.5px solid #2d3344;background:#181c24;color:#fff;font-size:1.1rem;" required></select>
          </div>
          <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:16px;margin-bottom:16px;">
            <input type="text" id="progress-company" placeholder="회사" style="padding:10px;border-radius:6px;border:1.5px solid #2d3344;background:#181c24;color:#fff;" readonly>
            <input type="text" id="progress-manager" placeholder="현장소장" style="padding:10px;border-radius:6px;border:1.5px solid #2d3344;background:#181c24;color:#fff;" readonly>
            <input type="text" id="progress-period" placeholder="공사기간" style="padding:10px;border-radius:6px;border:1.5px solid #2d3344;background:#181c24;color:#fff;" readonly>
            <input type="text" id="progress-contract" placeholder="계약금액" style="padding:10px;border-radius:6px;border:1.5px solid #2d3344;background:#181c24;color:#fff;" readonly>
          </div>
          <div style="margin-bottom:16px;">
            <textarea id="progress-content" placeholder="기성내역/비고 등 추가 내용" style="width:100%;min-height:120px;padding:12px;border-radius:6px;border:1.5px solid #2d3344;background:#181c24;color:#fff;font-size:1rem;"></textarea>
          </div>
          <div style="margin-bottom:16px;">
            <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;">
              <input type="file" id="progress-images" multiple accept="image/*" style="display:none;" onchange="previewProgressImages(this)">
              <label style="background:#3b82f6;color:#fff;border:none;border-radius:6px;padding:8px 16px;cursor:pointer;">
                사진 추가
                <input type="file" id="progress-images" multiple accept="image/*" style="display:none;" onchange="previewProgressImages(this)">
              </label>
            </div>
            <div id="progress-image-preview" style="display:flex;gap:8px;flex-wrap:wrap;"></div>
          </div>
          <button type="submit" style="background:#22c55e;color:#fff;border:none;border-radius:6px;padding:12px 24px;font-weight:700;font-size:1.1rem;">작성하기</button>
        </form>`;
      content.innerHTML = `<h2>기성현황</h2>${filterHtml}${formHtml}<div id="progress-list"></div>`;
      // 현장 불러오기(보류 제외)
      db.collection('sites').get().then(snapshot => {
        const select = document.getElementById('progress-site');
        let html = '<option value="">현장 선택</option>';
        snapshot.forEach(doc => {
          const d = doc.data();
          if(d.status !== '보류') {
            html += `<option value="${doc.id}" data-company="${d.company||''}" data-manager="${d.manager||''}" data-period="${d.start||''}~${d.end||''}" data-contract="${d.contract||''}">${d.name}</option>`;
          }
        });
        select.innerHTML = html;
      });
      // 현장 선택 시 자동 입력
      document.getElementById('progress-site').onchange = function() {
        const opt = this.selectedOptions[0];
        document.getElementById('progress-company').value = opt.getAttribute('data-company')||'';
        document.getElementById('progress-manager').value = opt.getAttribute('data-manager')||'';
        document.getElementById('progress-period').value = opt.getAttribute('data-period')||'';
        document.getElementById('progress-contract').value = opt.getAttribute('data-contract')||'';
      };
      // 이미지 미리보기
      window.previewProgressImages = function(input) {
        const preview = document.getElementById('progress-image-preview');
        window.progressImages = window.progressImages || [];
        Array.from(input.files).forEach(file => {
          window.progressImages.push(file);
          const reader = new FileReader();
          reader.onload = function(e) {
            preview.innerHTML += `<div style="position:relative;width:100px;height:100px;"><img src="${e.target.result}" style="width:100%;height:100%;object-fit:cover;border-radius:6px;"><button onclick="removeProgressImage(this)" style="position:absolute;top:-8px;right:-8px;background:#ef4444;color:#fff;border:none;border-radius:50%;width:20px;height:20px;font-size:14px;cursor:pointer;">×</button></div>`;
          };
          reader.readAsDataURL(file);
        });
      }
      window.removeProgressImage = function(btn) {
        const index = Array.from(btn.parentNode.parentNode.children).indexOf(btn.parentNode);
        window.progressImages.splice(index, 1);
        btn.parentNode.remove();
      }
      // 작성 폼 이벤트
      document.getElementById('progress-form').onsubmit = function(e) {
        e.preventDefault();
        const siteId = document.getElementById('progress-site').value;
        const siteName = document.getElementById('progress-site').selectedOptions[0]?.textContent || '';
        if (!siteName || !siteId) { alert('현장명을 선택하세요.'); return; }
        const company = document.getElementById('progress-company').value;
        const manager = document.getElementById('progress-manager').value;
        const period = document.getElementById('progress-period').value;
        const contract = document.getElementById('progress-contract').value;
        const content = document.getElementById('progress-content').value.trim();
        const images = window.progressImages || [];
        if(!siteId) { alert('현장을 선택하세요.'); return; }
        // 이미지 업로드
        Promise.all(images.map(file => {
          const storageRef = firebase.storage().ref();
          const imageRef = storageRef.child(`progress/${Date.now()}_${file.name}`);
          return imageRef.put(file).then(snapshot => snapshot.ref.getDownloadURL());
        })).then(imageUrls => {
          db.collection('progress_status').add({
            siteId, siteName, company, manager, period, contract, content, images: imageUrls,
            author: { uid: firebase.auth().currentUser.uid, email: firebase.auth().currentUser.email },
            createdAt: new Date()
          }).then(()=>{
            document.getElementById('progress-site').value = '';
            document.getElementById('progress-company').value = '';
            document.getElementById('progress-manager').value = '';
            document.getElementById('progress-period').value = '';
            document.getElementById('progress-contract').value = '';
            document.getElementById('progress-content').value = '';
            document.getElementById('progress-image-preview').innerHTML = '';
            window.progressImages = [];
          });
        });
      };
      // 목록 로드
      loadProgressList();
    }
    // 목록 로드
    function loadProgressList() {
      const container = document.getElementById('progress-list');
      db.collection('progress_status').orderBy('createdAt','desc').onSnapshot(snapshot => {
        let html = '';
        snapshot.forEach(doc => {
          const d = doc.data();
          const isAuthor = d.author.uid === firebase.auth().currentUser.uid;
          const isAdmin = window.currentUserRole === 'admin' || window.currentUserRole === 'master';
          html += `<div style="background:#232837;border-radius:12px;padding:24px;margin-bottom:16px;">
            <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:16px;">
              <div>
                <h3 style="margin:0 0 8px 0;color:#3b82f6;">${d.siteName}</h3>
                <div style="color:#b3b8c5;font-size:0.9rem;">회사: ${d.company||''} | 소장: ${d.manager||''} | 기간: ${d.period||''} | 계약금액: ${d.contract||''}</div>
                <div style="color:#b3b8c5;font-size:0.9rem;">작성자: ${d.author.email} | ${d.createdAt.toDate().toLocaleString()}</div>
              </div>
              ${(isAuthor||isAdmin)?`<div style="display:flex;gap:8px;"><button onclick="editProgress('${doc.id}')" style="background:#3b82f6;color:#fff;border:none;border-radius:6px;padding:6px 12px;">수정</button><button onclick="deleteProgress('${doc.id}')" style="background:#ef4444;color:#fff;border:none;border-radius:6px;padding:6px 12px;">삭제</button></div>`:''}
            </div>
            <div style="margin-bottom:16px;white-space:pre-wrap;">${d.content||''}</div>
            ${d.images&&d.images.length>0?`<div style="display:flex;gap:8px;flex-wrap:wrap;">${d.images.map(url=>`<img src="${url}" style="width:100px;height:100px;object-fit:cover;border-radius:6px;cursor:pointer;" onclick="showImage('${url}')">`).join('')}</div>`:''}
          </div>`;
        });
        container.innerHTML = html;
      });
    }
    // 수정
    window.editProgress = function(id) {
      db.collection('progress_status').doc(id).get().then(doc => {
        const d = doc.data();
        document.getElementById('progress-site').value = d.siteId;
        document.getElementById('progress-company').value = d.company;
        document.getElementById('progress-manager').value = d.manager;
        document.getElementById('progress-period').value = d.period;
        document.getElementById('progress-contract').value = d.contract;
        document.getElementById('progress-content').value = d.content;
        // 이미지 미리보기
        const preview = document.getElementById('progress-image-preview');
        preview.innerHTML = '';
        if(d.images&&d.images.length>0){
          d.images.forEach(url=>{
            preview.innerHTML += `<div style="position:relative;width:100px;height:100px;"><img src="${url}" style="width:100%;height:100%;object-fit:cover;border-radius:6px;"><button onclick="removeProgressImage(this)" style="position:absolute;top:-8px;right:-8px;background:#ef4444;color:#fff;border:none;border-radius:50%;width:20px;height:20px;font-size:14px;cursor:pointer;">×</button></div>`;
          });
        }
        // 폼 제출 이벤트 변경
        const form = document.getElementById('progress-form');
        form.onsubmit = function(e) {
          e.preventDefault();
          const siteId = document.getElementById('progress-site').value;
          const siteName = document.getElementById('progress-site').selectedOptions[0]?.textContent || '';
          if (!siteName || !siteId) { alert('현장명을 선택하세요.'); return; }
          const company = document.getElementById('progress-company').value;
          const manager = document.getElementById('progress-manager').value;
          const period = document.getElementById('progress-period').value;
          const contract = document.getElementById('progress-contract').value;
          const content = document.getElementById('progress-content').value.trim();
          const images = window.progressImages || [];
          if(!siteId) { alert('현장을 선택하세요.'); return; }
          Promise.all(images.map(file => {
            const storageRef = firebase.storage().ref();
            const imageRef = storageRef.child(`progress/${Date.now()}_${file.name}`);
            return imageRef.put(file).then(snapshot => snapshot.ref.getDownloadURL());
          })).then(newImageUrls => {
            const existingImages = Array.from(document.querySelectorAll('#progress-image-preview img')).map(img=>img.src);
            const allImages = [...existingImages, ...newImageUrls];
            db.collection('progress_status').doc(id).update({
              siteId, siteName, company, manager, period, contract, content, images: allImages, updatedAt: new Date()
            }).then(()=>{
              document.getElementById('progress-site').value = '';
              document.getElementById('progress-company').value = '';
              document.getElementById('progress-manager').value = '';
              document.getElementById('progress-period').value = '';
              document.getElementById('progress-contract').value = '';
              document.getElementById('progress-content').value = '';
              document.getElementById('progress-image-preview').innerHTML = '';
              window.progressImages = [];
              form.onsubmit = null;
              renderProgress();
            });
          });
        };
      });
    }
    // 삭제
    window.deleteProgress = function(id) {
      if(confirm('정말 삭제하시겠습니까?')){
        db.collection('progress_status').doc(id).delete();
      }
    }
    // 검색
    window.searchProgress = function() {
      const keyword = document.getElementById('progress-search').value.trim().toLowerCase();
      if(!keyword){ loadProgressList(); return; }
      db.collection('progress_status').get().then(snapshot => {
        const container = document.getElementById('progress-list');
        let html = '';
        snapshot.forEach(doc => {
          const d = doc.data();
          if(
            (d.siteName||'').toLowerCase().includes(keyword) ||
            (d.company||'').toLowerCase().includes(keyword) ||
            (d.manager||'').toLowerCase().includes(keyword) ||
            (d.content||'').toLowerCase().includes(keyword)
          ){
            const isAuthor = d.author.uid === firebase.auth().currentUser.uid;
            const isAdmin = window.currentUserRole === 'admin' || window.currentUserRole === 'master';
            html += `
              <div style="background:#232837;border-radius:12px;padding:24px;margin-bottom:16px;">
                <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:16px;">
                  <div>
                    <h3 style="margin:0 0 8px 0;color:#3b82f6;">${d.siteName}</h3>
                    <div style="color:#b3b8c5;font-size:0.9rem;">회사: ${d.company||''} | 소장: ${d.manager||''} | 기간: ${d.period||''} | 계약금액: ${d.contract||''}</div>
                    <div style="color:#b3b8c5;font-size:0.9rem;">작성자: ${d.author.email} | ${d.createdAt.toDate().toLocaleString()}</div>
                  </div>
                  ${(isAuthor||isAdmin)?`<div style=\"display:flex;gap:8px;\"><button onclick=\"editProgress('${doc.id}')\" style=\"background:#3b82f6;color:#fff;border:none;border-radius:6px;padding:6px 12px;\">수정</button><button onclick=\"deleteProgress('${doc.id}')\" style=\"background:#ef4444;color:#fff;border:none;border-radius:6px;padding:6px 12px;\">삭제</button></div>`:''}
                </div>
                <div style="margin-bottom:16px;white-space:pre-wrap;">${d.content||''}</div>
                ${d.images&&d.images.length>0?`<div style="display:flex;gap:8px;flex-wrap:wrap;">${d.images.map(url=>`<img src=\"${url}\" style=\"width:100px;height:100px;object-fit:cover;border-radius:6px;cursor:pointer;\" onclick=\"showImage('${url}')\">`).join('')}</div>`:''}
              </div>`;
          }
        });
        container.innerHTML = html;
      });
    }
    // 엑셀 다운로드
    window.downloadProgressExcel = function() {
      db.collection('progress_status').get().then(snapshot => {
        const data = snapshot.docs.map(doc => {
          const d = doc.data();
          return {
            '현장명': d.siteName||'',
            '회사': d.company||'',
            '현장소장': d.manager||'',
            '공사기간': d.period||'',
            '계약금액': d.contract||'',
            '작성자': d.author.email||'',
            '작성일': d.createdAt?d.createdAt.toDate().toLocaleString():'',
            '기성내역': d.content||'',
            '이미지수': d.images?d.images.length:0
          };
        });
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, '기성현황');
        XLSX.writeFile(wb, '기성현황.xlsx');
      });
    }
    // 엑셀 업로드
    window.uploadProgressExcel = function(input) {
      const file = input.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, {type: 'array'});
        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(firstSheet);
        jsonData.forEach(row => {
          db.collection('progress_status').add({
            siteName: row['현장명']||'',
            company: row['회사']||'',
            manager: row['현장소장']||'',
            period: row['공사기간']||'',
            contract: row['계약금액']||'',
            content: row['기성내역']||'',
            author: { email: row['작성자']||'' },
            createdAt: new Date(row['작성일']||Date.now()),
            images: [] // 이미지URL은 별도 처리 필요
          });
        });
        alert('엑셀 데이터가 업로드되었습니다.');
        input.value = '';
      };
      reader.readAsArrayBuffer(file);
    }

    // 거래처 현황 화면
    function renderPartners() {
      renderMenu('partners');
      const content = document.getElementById('content');
      // 검색/엑셀
      let filterHtml = `
        <div style='display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;'>
          <div style='display:flex;gap:8px;'>
            <input type='text' id='partner-search' placeholder='거래처명/대표자/연락처/이메일 검색' style='padding:8px 12px;border-radius:6px;border:1.5px solid #2d3344;background:#181c24;color:#fff;width:300px;'>
            <button onclick='searchPartners()' style='background:#3b82f6;color:#fff;border:none;border-radius:6px;padding:8px 16px;'>검색</button>
          </div>
          <div style='display:flex;gap:8px;'>
            <button onclick='downloadPartnersExcel()' style='background:#22c55e;color:#fff;border:none;border-radius:6px;padding:8px 16px;'>엑셀 다운로드</button>
            <label style='background:#3b82f6;color:#fff;border:none;border-radius:6px;padding:8px 16px;cursor:pointer;'>
              엑셀 업로드
              <input type='file' id='partners-excel-upload' accept='.xlsx,.xls' style='display:none;' onchange='uploadPartnersExcel(this)'>
            </label>
          </div>
        </div>`;
      // 추가 폼
      let formHtml = `
        <form id="partner-form" style="margin-bottom:32px;display:flex;flex-wrap:wrap;gap:10px;align-items:center;">
          <select id="partner-type" style="padding:8px 10px;border-radius:6px;border:1.5px solid #2d3344;background:#181c24;color:#fff;font-size:1rem;" required>
            <option value="">구분 선택</option>
            <option value="종합건설">종합건설</option>
            <option value="AL관급업체">AL관급업체</option>
            <option value="PL관급업체">PL관급업체</option>
          </select>
          <input id="partner-name" type="text" placeholder="거래처명" style="padding:8px 10px;border-radius:6px;border:1.5px solid #2d3344;background:#181c24;color:#fff;font-size:1rem;" required />
          <input id="partner-ceo" type="text" placeholder="대표자명" style="padding:8px 10px;border-radius:6px;border:1.5px solid #2d3344;background:#181c24;color:#fff;font-size:1rem;" />
          <input id="partner-biznum" type="text" placeholder="사업자등록번호" style="padding:8px 10px;border-radius:6px;border:1.5px solid #2d3344;background:#181c24;color:#fff;font-size:1rem;" />
          <input id="partner-phone" type="text" placeholder="연락처" style="padding:8px 10px;border-radius:6px;border:1.5px solid #2d3344;background:#181c24;color:#fff;font-size:1rem;" />
          <input id="partner-email" type="text" placeholder="이메일" style="padding:8px 10px;border-radius:6px;border:1.5px solid #2d3344;background:#181c24;color:#fff;font-size:1rem;" />
          <input id="partner-address" type="text" placeholder="주소" style="padding:8px 10px;border-radius:6px;border:1.5px solid #2d3344;background:#181c24;color:#fff;font-size:1rem;" />
          <div style="position:relative;">
            <input id="partner-period" type="text" placeholder="공사기간" style="padding:8px 10px;border-radius:6px;border:1.5px solid #2d3344;background:#181c24;color:#fff;font-size:1rem;width:180px;" readonly />
            <div id="partner-period-calendar" style="display:none;position:absolute;top:100%;left:0;z-index:1000;background:#232837;padding:12px;border-radius:8px;box-shadow:0 4px 12px #0003;"></div>
          </div>
          <input id="partner-item" type="text" placeholder="주요거래품목/비고" style="padding:8px 10px;border-radius:6px;border:1.5px solid #2d3344;background:#181c24;color:#fff;font-size:1rem;width:300px;" />
          <button type="submit" style="background:#22c55e;color:#fff;border:none;border-radius:6px;padding:8px 22px;font-weight:700;">+ 거래처 추가</button>
        </form>`;
      content.innerHTML = `<h2>거래처 현황</h2>${filterHtml}${formHtml}<div id="partners-list"></div>`;
      // 미니 달력(공사기간)
      initCalendar('partner-period-calendar', 'partner-period');
      // 폼 이벤트
      document.getElementById('partner-form').onsubmit = function(e) {
        e.preventDefault();
        const type = document.getElementById('partner-type').value;
        const name = document.getElementById('partner-name').value.trim();
        if (!type) { alert('구분을 선택하세요.'); return; }
        if (!name) { alert('거래처명을 입력하세요.'); return; }
        const ceo = document.getElementById('partner-ceo').value.trim();
        const biznum = document.getElementById('partner-biznum').value.trim();
        const phone = document.getElementById('partner-phone').value.trim();
        const email = document.getElementById('partner-email').value.trim();
        const address = document.getElementById('partner-address').value.trim();
        const period = document.getElementById('partner-period').value.trim();
        const item = document.getElementById('partner-item').value.trim();
        db.collection('partners').add({
          type, name, ceo, biznum, phone, email, address, period, item,
          author: { uid: firebase.auth().currentUser.uid, email: firebase.auth().currentUser.email },
          createdAt: new Date()
        }).then(()=>{
          document.getElementById('partner-type').value = '';
          document.getElementById('partner-name').value = '';
          document.getElementById('partner-ceo').value = '';
          document.getElementById('partner-biznum').value = '';
          document.getElementById('partner-phone').value = '';
          document.getElementById('partner-email').value = '';
          document.getElementById('partner-address').value = '';
          document.getElementById('partner-period').value = '';
          document.getElementById('partner-item').value = '';
        });
      };
      // 목록 로드
      loadPartnersList();
    }
    // 목록 로드
    function loadPartnersList() {
      const container = document.getElementById('partners-list');
      db.collection('partners').orderBy('createdAt','desc').onSnapshot(snapshot => {
        let html = `<table style='width:100%;'><thead><tr>
          <th>구분</th><th>거래처명</th><th>대표자</th><th>사업자등록번호</th><th>연락처</th><th>이메일</th><th>주소</th><th>공사기간</th><th>주요거래품목/비고</th><th>등록일</th><th>관리</th>
        </tr></thead><tbody>`;
        snapshot.forEach(doc => {
          const d = doc.data();
          const isAuthor = d.author && d.author.uid === firebase.auth().currentUser.uid;
          const isAdmin = window.currentUserRole === 'admin' || window.currentUserRole === 'master';
          html += `<tr>
            <td>
              <select id='type-${doc.id}' style='width:100px;padding:4px;border-radius:4px;border:1px solid #2d3344;background:#232837;color:#fff;'>
                <option value='종합건설' ${d.type==='종합건설'?'selected':''}>종합건설</option>
                <option value='AL관급업체' ${d.type==='AL관급업체'?'selected':''}>AL관급업체</option>
                <option value='PL관급업체' ${d.type==='PL관급업체'?'selected':''}>PL관급업체</option>
              </select>
            </td>
            <td><input type='text' value='${d.name||''}' id='name-${doc.id}' style='width:120px;padding:4px;border-radius:4px;border:1px solid #2d3344;background:#232837;color:#fff;'></td>
            <td><input type='text' value='${d.ceo||''}' id='ceo-${doc.id}' style='width:100px;padding:4px;border-radius:4px;border:1px solid #2d3344;background:#232837;color:#fff;'></td>
            <td><input type='text' value='${d.biznum||''}' id='biznum-${doc.id}' style='width:120px;padding:4px;border-radius:4px;border:1px solid #2d3344;background:#232837;color:#fff;'></td>
            <td><input type='text' value='${d.phone||''}' id='phone-${doc.id}' style='width:120px;padding:4px;border-radius:4px;border:1px solid #2d3344;background:#232837;color:#fff;'></td>
            <td><input type='text' value='${d.email||''}' id='email-${doc.id}' style='width:140px;padding:4px;border-radius:4px;border:1px solid #2d3344;background:#232837;color:#fff;'></td>
            <td><input type='text' value='${d.address||''}' id='address-${doc.id}' style='width:180px;padding:4px;border-radius:4px;border:1px solid #2d3344;background:#232837;color:#fff;'></td>
            <td><input type='text' value='${d.period||''}' id='period-${doc.id}' style='width:140px;padding:4px;border-radius:4px;border:1px solid #2d3344;background:#232837;color:#fff;' readonly></td>
            <td><input type='text' value='${d.item||''}' id='item-${doc.id}' style='width:180px;padding:4px;border-radius:4px;border:1px solid #2d3344;background:#232837;color:#fff;'></td>
            <td>${d.createdAt ? d.createdAt.toDate().toLocaleString() : ''}</td>
            <td>
              ${(isAuthor||isAdmin)?`<button onclick="updatePartner('${doc.id}')" style='background:#3b82f6;color:#fff;border:none;border-radius:6px;padding:4px 12px;margin-right:4px;'>수정</button><button onclick="deletePartner('${doc.id}')" style='background:#ef4444;color:#fff;border:none;border-radius:6px;padding:4px 12px;'>삭제</button>`:''}
            </td>
          </tr>`;
        });
        html += '</tbody></table>';
        container.innerHTML = html;
      });
    }
    // 수정
    window.updatePartner = function(id) {
      const type = document.getElementById('type-' + id).value;
      const name = document.getElementById('name-' + id).value.trim();
      if (!type) { alert('구분을 선택하세요.'); return; }
      if (!name) { alert('거래처명을 입력하세요.'); return; }
      const ceo = document.getElementById('ceo-' + id).value.trim();
      const biznum = document.getElementById('biznum-' + id).value.trim();
      const phone = document.getElementById('phone-' + id).value.trim();
      const email = document.getElementById('email-' + id).value.trim();
      const address = document.getElementById('address-' + id).value.trim();
      const period = document.getElementById('period-' + id).value.trim();
      const item = document.getElementById('item-' + id).value.trim();
      db.collection('partners').doc(id).update({ type, name, ceo, biznum, phone, email, address, period, item, updatedAt: new Date() });
    }
    // 삭제
    window.deletePartner = function(id) {
      if(confirm('정말 삭제하시겠습니까?')){
        db.collection('partners').doc(id).delete();
      }
    }
    // 검색
    window.searchPartners = function() {
      const keyword = document.getElementById('partner-search').value.trim().toLowerCase();
      if(!keyword){ loadPartnersList(); return; }
      db.collection('partners').get().then(snapshot => {
        const container = document.getElementById('partners-list');
        let html = `<table style='width:100%;'><thead><tr>
          <th>구분</th><th>거래처명</th><th>대표자</th><th>사업자등록번호</th><th>연락처</th><th>이메일</th><th>주소</th><th>공사기간</th><th>주요거래품목/비고</th><th>등록일</th><th>관리</th>
        </tr></thead><tbody>`;
        snapshot.forEach(doc => {
          const d = doc.data();
          if(
            (d.type||'').toLowerCase().includes(keyword) ||
            (d.name||'').toLowerCase().includes(keyword) ||
            (d.ceo||'').toLowerCase().includes(keyword) ||
            (d.biznum||'').toLowerCase().includes(keyword) ||
            (d.phone||'').toLowerCase().includes(keyword) ||
            (d.email||'').toLowerCase().includes(keyword) ||
            (d.address||'').toLowerCase().includes(keyword) ||
            (d.period||'').toLowerCase().includes(keyword) ||
            (d.item||'').toLowerCase().includes(keyword)
          ){
            const isAuthor = d.author && d.author.uid === firebase.auth().currentUser.uid;
            const isAdmin = window.currentUserRole === 'admin' || window.currentUserRole === 'master';
            html += `<tr>
              <td>
                <select id='type-${doc.id}' style='width:100px;padding:4px;border-radius:4px;border:1px solid #2d3344;background:#232837;color:#fff;'>
                  <option value='종합건설' ${d.type==='종합건설'?'selected':''}>종합건설</option>
                  <option value='AL관급업체' ${d.type==='AL관급업체'?'selected':''}>AL관급업체</option>
                  <option value='PL관급업체' ${d.type==='PL관급업체'?'selected':''}>PL관급업체</option>
                </select>
              </td>
              <td><input type='text' value='${d.name||''}' id='name-${doc.id}' style='width:120px;padding:4px;border-radius:4px;border:1px solid #2d3344;background:#232837;color:#fff;'></td>
              <td><input type='text' value='${d.ceo||''}' id='ceo-${doc.id}' style='width:100px;padding:4px;border-radius:4px;border:1px solid #2d3344;background:#232837;color:#fff;'></td>
              <td><input type='text' value='${d.biznum||''}' id='biznum-${doc.id}' style='width:120px;padding:4px;border-radius:4px;border:1px solid #2d3344;background:#232837;color:#fff;'></td>
              <td><input type='text' value='${d.phone||''}' id='phone-${doc.id}' style='width:120px;padding:4px;border-radius:4px;border:1px solid #2d3344;background:#232837;color:#fff;'></td>
              <td><input type='text' value='${d.email||''}' id='email-${doc.id}' style='width:140px;padding:4px;border-radius:4px;border:1px solid #2d3344;background:#232837;color:#fff;'></td>
              <td><input type='text' value='${d.address||''}' id='address-${doc.id}' style='width:180px;padding:4px;border-radius:4px;border:1px solid #2d3344;background:#232837;color:#fff;'></td>
              <td><input type='text' value='${d.period||''}' id='period-${doc.id}' style='width:140px;padding:4px;border-radius:4px;border:1px solid #2d3344;background:#232837;color:#fff;' readonly></td>
              <td><input type='text' value='${d.item||''}' id='item-${doc.id}' style='width:180px;padding:4px;border-radius:4px;border:1px solid #2d3344;background:#232837;color:#fff;'></td>
              <td>${d.createdAt ? d.createdAt.toDate().toLocaleString() : ''}</td>
              <td>
                ${(isAuthor||isAdmin)?`<button onclick=\"updatePartner('${doc.id}')\" style='background:#3b82f6;color:#fff;border:none;border-radius:6px;padding:4px 12px;margin-right:4px;'>수정</button><button onclick=\"deletePartner('${doc.id}')\" style='background:#ef4444;color:#fff;border:none;border-radius:6px;padding:4px 12px;'>삭제</button>`:''}
              </td>
            </tr>`;
          }
        });
        html += '</tbody></table>';
        container.innerHTML = html;
      });
    }
    // 엑셀 다운로드
    window.downloadPartnersExcel = function() {
      db.collection('partners').get().then(snapshot => {
        const data = snapshot.docs.map(doc => {
          const d = doc.data();
          return {
            '구분': d.type||'',
            '거래처명': d.name||'',
            '대표자': d.ceo||'',
            '사업자등록번호': d.biznum||'',
            '연락처': d.phone||'',
            '이메일': d.email||'',
            '주소': d.address||'',
            '공사기간': d.period||'',
            '주요거래품목/비고': d.item||'',
            '등록일': d.createdAt?d.createdAt.toDate().toLocaleString():'',
            '작성자': d.author?d.author.email:''
          };
        });
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, '거래처현황');
        XLSX.writeFile(wb, '거래처현황.xlsx');
      });
    }
    // 엑셀 업로드
    window.uploadPartnersExcel = function(input) {
      const file = input.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, {type: 'array'});
        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(firstSheet);
        jsonData.forEach(row => {
          db.collection('partners').add({
            type: row['구분']||'',
            name: row['거래처명']||'',
            ceo: row['대표자']||'',
            biznum: row['사업자등록번호']||'',
            phone: row['연락처']||'',
            email: row['이메일']||'',
            address: row['주소']||'',
            period: row['공사기간']||'',
            item: row['주요거래품목/비고']||'',
            author: { email: row['작성자']||'' },
            createdAt: new Date(row['등록일']||Date.now())
          });
        });
        alert('엑셀 데이터가 업로드되었습니다.');
        input.value = '';
      };
      reader.readAsArrayBuffer(file);
    }

    // 메인 화면 렌더링
    function renderMain() {
      renderMenu('main');
      const content = document.getElementById('content');
      
      // 건설뉴스 가져오기
      fetch('https://api.odcloud.kr/api/15040861/v1/uddi:5c4c3c3c-3c3c-3c3c-3c3c-3c3c3c3c3c3c?page=1&perPage=100')
        .then(response => response.json())
        .then(data => {
          let news = data.data;
          
          // 유리 관련 뉴스 필터링
          const glassNews = news.filter(item => 
            item.title.includes('유리') || 
            item.title.includes('복층') || 
            item.title.includes('로이') || 
            item.title.includes('삼중')
          );
          
          // 나머지 뉴스
          const otherNews = news.filter(item => 
            !item.title.includes('유리') && 
            !item.title.includes('복층') && 
            !item.title.includes('로이') && 
            !item.title.includes('삼중')
          );
          
          // 유리 뉴스 먼저 표시하고 나머지 뉴스 랜덤 선택
          const selectedNews = [
            ...glassNews.slice(0, 3),
            ...otherNews.sort(() => Math.random() - 0.5).slice(0, 2)
          ];

          let html = `
            <div style="background:#232837;border-radius:12px;padding:24px;margin-bottom:16px;">
              <h2 style="color:#3b82f6;margin-bottom:16px;">건설뉴스</h2>
              <div style="display:flex;flex-direction:column;gap:12px;">
                ${selectedNews.map(item => `
                  <div style="background:#181c24;padding:16px;border-radius:8px;cursor:pointer;" 
                       onclick="window.open('${item.link}', '_blank')">
                    <h3 style="margin:0;color:#fff;font-size:1.1rem;">${item.title}</h3>
                    <div style="color:#b3b8c5;font-size:0.9rem;margin-top:8px;">
                      ${new Date(item.date).toLocaleDateString()}
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
          `;
          
          content.innerHTML = html;
        })
        .catch(error => {
          content.innerHTML = '<div class="error-msg">뉴스를 불러오는데 실패했습니다.</div>';
        });
    }

    firebase.auth().createUserWithEmailAndPassword('admin@naver.com', '12345678')
      .then((userCredential) => {
        db.collection('users').doc(userCredential.user.uid).set({
          name: '관리자',
          affil: '관리팀',
          email: 'admin@naver.com',
          pw: '12345678',
          role: 'admin',
          createdAt: new Date()
        });
        alert('임시 관리자 계정 생성 완료!');
      })
      .catch((e) => {
        // 이미 있으면 무시
      });
  </script>
</body>
</html> 