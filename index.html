<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Chunwoo Firestore ì—°ë™ ì˜ˆì‹œ</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <style>
    body { font-family: 'Noto Sans KR', Arial, sans-serif; background: #181c24; color: #fff; margin: 0; }
    .container { max-width: 900px; margin: 40px auto; background: #232837; border-radius: 12px; box-shadow: 0 2px 16px #0002; padding: 32px 24px; }
    h2 { color: #3b82f6; }
    .menu { display: flex; gap: 16px; margin-bottom: 24px; }
    .menu button { background: #232837; color: #b3b8c5; border: none; border-radius: 8px; padding: 10px 24px; font-size: 1.1rem; font-weight: 700; cursor: pointer; }
    .menu button.active, .menu button:hover { background: #3b82f6; color: #fff; }
    .logout-btn { background: #ef4444; color: #fff; border: none; border-radius: 6px; padding: 8px 20px; font-size: 1rem; font-weight: 700; cursor: pointer; float: right; }
    /* í–„ë²„ê±° ë©”ë‰´ ìŠ¤íƒ€ì¼ */
    .hamburger { display: none; background: none; border: none; font-size: 2rem; color: #3b82f6; margin-left: 12px; cursor: pointer; }
    @media (max-width: 700px) {
      .menu { display: none; position: absolute; top: 60px; left: 0; width: 100vw; background: #232837; flex-direction: column; gap: 0; z-index: 1001; box-shadow: 0 2px 16px #0002; }
      .menu.menu-open { display: flex; }
      .menu button { width: 100%; padding: 16px; text-align: center; border-radius: 0; }
      .logout-btn { width: 100%; margin: 0; border-radius: 0; }
      .hamburger { display: block; }
    }
    table { width: 100%; border-collapse: collapse; margin-top: 18px; }
    th, td { padding: 10px; border-bottom: 1px solid #2d3344; }
    th { background: #232837; color: #3b82f6; }
    tr:last-child td { border-bottom: none; }
    .login-box { 
      background: #232837; 
      border-radius: 12px; 
      box-shadow: 0 2px 16px #0002; 
      max-width: 350px; 
      margin: 80px auto; 
      padding: 36px 28px 28px 28px; 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
    }
    .login-box h2 { 
      color: #3b82f6; 
      margin-bottom: 24px; 
      font-size: 1.5rem; 
      font-weight: 700; 
    }
    .login-box input { 
      width: 100%; 
      padding: 12px 10px; 
      margin-bottom: 16px; 
      border: 1.5px solid #2d3344; 
      border-radius: 6px; 
      font-size: 1rem; 
      background: #181c24; 
      color: #fff; 
    }
    .login-box button { 
      width: 100%; 
      padding: 12px 0; 
      border: none; 
      border-radius: 6px; 
      font-size: 1.1rem; 
      font-weight: 700; 
      cursor: pointer; 
      margin-bottom: 10px; 
      background: #3b82f6; 
      color: #fff; 
    }
    .login-box button:hover { 
      background: #2563eb; 
    }
    .error-msg { 
      color: #ef4444; 
      font-size: 0.98rem; 
      margin-bottom: 10px; 
      text-align: center; 
    }
  </style>
</head>
<body>
  <div id="main"></div>
  <script>
    // Firebase ì´ˆê¸°í™”
    const firebaseConfig = {
      apiKey: "AIzaSyATCGXGD2_teiJFdpng9J2_fvZRItPef0w",
      authDomain: "chunwooo-edf9f.firebaseapp.com",
      databaseURL: "https://chunwooo-edf9f-default-rtdb.firebaseio.com",
      projectId: "chunwooo-edf9f",
      storageBucket: "chunwooo-edf9f.appspot.com",
      messagingSenderId: "417029078660",
      appId: "1:417029078660:web:00e23d79af77876e598cd1",
      measurementId: "G-653CL9XWFH"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // ì¸ì¦ ìƒíƒœ ê°ì‹œ
    firebase.auth().onAuthStateChanged(user => {
      if (user) {
        // ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        db.collection('users').doc(user.uid).get().then(doc => {
          if (doc.exists) {
            window.currentUserRole = doc.data().role;
            renderMain();
          } else {
            renderLogin();
          }
        }).catch(() => {
          renderLogin();
        });
      } else {
        renderLogin();
      }
    });

    // ì´ˆê¸° í™”ë©´ ë Œë”ë§
    renderLogin();

    // ë©”ë‰´ ë Œë”ë§
    function renderMenu(active) {
      let userRole = window.currentUserRole || '';
      document.getElementById('main').innerHTML = `
        <div class="container">
          <div style="display:flex;justify-content:space-between;align-items:center;position:relative;">
            <button class="hamburger" id="hamburger-btn">â˜°</button>
            <div class="menu" id="main-menu">
              <button class="${active==='main'?'active':''}" onclick="closeMenu();renderMain()">ê±´ì„¤NEWS</button>
              <button class="${active==='status'?'active':''}" onclick="closeMenu();renderStatus()">ê³µì‚¬í˜„í™©</button>
              <button class="${active==='sites'?'active':''}" onclick="closeMenu();renderSites()">í˜„ì¥ë‚´ì—­</button>
              <button class="${active==='discussion'?'active':''}" onclick="closeMenu();renderDiscussion()">í˜‘ì˜í•˜ê¸°</button>
              <button class="${active==='progress'?'active':''}" onclick="closeMenu();renderProgress()" style="${userRole==='admin'||userRole==='master'?'':'display:none;'}">ê¸°ì„±í˜„í™©</button>
              <button class="${active==='partners'?'active':''}" onclick="closeMenu();renderPartners()">ê±°ë˜ì²˜</button>
              ${(userRole==='admin'||userRole==='master')?`<button class="${active==='users'?'active':''}" onclick="closeMenu();renderUsers()">íšŒì›ëª…ë‹¨</button><button class="${active==='roles'?'active':''}" onclick="closeMenu();renderRoleSettings()">ê¶Œí•œì„¤ì •</button>`:''}
            </div>
            <button class="logout-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
          </div>
          <div id="content"></div>
        </div>
      `;
      // í–„ë²„ê±° ë©”ë‰´ ë™ì‘
      const hamburger = document.getElementById('hamburger-btn');
      const menu = document.getElementById('main-menu');
      if (hamburger && menu) {
        hamburger.onclick = function(e) {
          e.stopPropagation();
          menu.classList.toggle('menu-open');
        };
        // ë©”ë‰´ ë°”ê¹¥ í´ë¦­ ì‹œ ë‹«í˜
        document.addEventListener('click', function handler(e) {
          if (window.innerWidth <= 700 && menu.classList.contains('menu-open')) {
            if (!menu.contains(e.target) && e.target !== hamburger) {
              menu.classList.remove('menu-open');
            }
          }
        });
      }
    }
    // ë©”ë‰´ ë‹«ê¸° í•¨ìˆ˜
    function closeMenu() {
      const menu = document.getElementById('main-menu');
      if (menu) menu.classList.remove('menu-open');
    }

    // í˜„ì¥ ëª©ë¡ Firestore ì—°ë™ ì˜ˆì‹œ (ì¶”ê°€/ìˆ˜ì •/ì‚­ì œ í¬í•¨)
    function renderSites() {
      renderMenu('sites');
      const content = document.getElementById('content');
      
      // ìƒíƒœë³„ íƒ­
      let tabsHtml = `
        <div style='display:flex;gap:12px;margin-bottom:24px;'>
          <button onclick="filterSites('all')" class='tab-btn active' data-status='all'>ì „ì²´</button>
          <button onclick="filterSites('ì§„í–‰ì¤‘')" class='tab-btn' data-status='ì§„í–‰ì¤‘'>ì§„í–‰ì¤‘</button>
          <button onclick="filterSites('ì˜ˆì •')" class='tab-btn' data-status='ì˜ˆì •'>ì˜ˆì •</button>
          <button onclick="filterSites('ì™„ë£Œ')" class='tab-btn' data-status='ì™„ë£Œ'>ì™„ë£Œ</button>
          <button onclick="filterSites('ë³´ë¥˜')" class='tab-btn' data-status='ë³´ë¥˜'>ë³´ë¥˜</button>
        </div>
        <div style='display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;'>
          <div style='display:flex;gap:8px;'>
            <input type='text' id='site-search' placeholder='í˜„ì¥ëª…/ì£¼ì†Œ/ë‹´ë‹¹ì ê²€ìƒ‰' style='padding:8px 12px;border-radius:6px;border:1.5px solid #2d3344;background:#181c24;color:#fff;width:300px;'>
            <button onclick='searchSites()' style='background:#3b82f6;color:#fff;border:none;border-radius:6px;padding:8px 16px;'>ê²€ìƒ‰</button>
          </div>
          <div style='display:flex;gap:8px;'>
            <button onclick='downloadExcel()' style='background:#22c55e;color:#fff;border:none;border-radius:6px;padding:8px 16px;'>ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
            <label style='background:#3b82f6;color:#fff;border:none;border-radius:6px;padding:8px 16px;cursor:pointer;'>
              ì—‘ì…€ ì—…ë¡œë“œ
              <input type='file' id='excel-upload' accept='.xlsx,.xls' style='display:none;' onchange='uploadExcel(this)'>
            </label>
          </div>
        </div>`;

      // ì¶”ê°€ í¼
      let formHtml = `
        <form id="site-form" style="display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-bottom:18px;">
          <input id="site-name" type="text" placeholder="í˜„ì¥ëª…" style="padding:8px 10px;border-radius:6px;border:1.5px solid #2d3344;background:#181c24;color:#fff;font-size:1rem;" required />
          <input id="site-company" type="text" placeholder="íšŒì‚¬" style="padding:8px 10px;border-radius:6px;border:1.5px solid #2d3344;background:#181c24;color:#fff;font-size:1rem;" />
          <input id="site-manager" type="text" placeholder="í˜„ì¥ì†Œì¥" style="padding:8px 10px;border-radius:6px;border:1.5px solid #2d3344;background:#181c24;color:#fff;font-size:1rem;" />
          <select id="site-status" style="padding:8px 10px;border-radius:6px;border:1.5px solid #2d3344;background:#181c24;color:#fff;font-size:1rem;" required>
            <option value="">ìƒíƒœ ì„ íƒ</option>
            <option value="ì§„í–‰ì¤‘">ì§„í–‰ì¤‘</option>
            <option value="ì˜ˆì •">ì˜ˆì •</option>
            <option value="ì™„ë£Œ">ì™„ë£Œ</option>
            <option value="ë³´ë¥˜">ë³´ë¥˜</option>
          </select>
          <input id="site-address" type="text" placeholder="ì£¼ì†Œ" style="padding:8px 10px;border-radius:6px;border:1.5px solid #2d3344;background:#181c24;color:#fff;font-size:1rem;" />
          <input id="site-phone" type="text" placeholder="ì—°ë½ì²˜" style="padding:8px 10px;border-radius:6px;border:1.5px solid #2d3344;background:#181c24;color:#fff;font-size:1rem;" />
          <div style="position:relative;">
            <input id="site-start" type="text" placeholder="ì‹œì‘ì¼" style="padding:8px 10px;border-radius:6px;border:1.5px solid #2d3344;background:#181c24;color:#fff;font-size:1rem;width:120px;" readonly />
            <div id="start-calendar" style="display:none;position:absolute;top:100%;left:0;z-index:1000;background:#232837;padding:12px;border-radius:8px;box-shadow:0 4px 12px #0003;"></div>
          </div>
          <div style="position:relative;">
            <input id="site-end" type="text" placeholder="ì¢…ë£Œì¼" style="padding:8px 10px;border-radius:6px;border:1.5px solid #2d3344;background:#181c24;color:#fff;font-size:1rem;width:120px;" readonly />
            <div id="end-calendar" style="display:none;position:absolute;top:100%;left:0;z-index:1000;background:#232837;padding:12px;border-radius:8px;box-shadow:0 4px 12px #0003;"></div>
          </div>
          <input id="site-contract" type="number" placeholder="ê³„ì•½ê¸ˆì•¡" style="padding:8px 10px;border-radius:6px;border:1.5px solid #2d3344;background:#181c24;color:#fff;font-size:1rem;" />
          <div style="width:100%;">
            <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;">
              <input id="item-name" type="text" placeholder="í’ˆëª©ëª…" style="padding:8px 10px;border-radius:6px;border:1.5px solid #2d3344;background:#181c24;color:#fff;font-size:1rem;" />
              <input id="item-quantity" type="number" placeholder="ìˆ˜ëŸ‰" style="padding:8px 10px;border-radius:6px;border:1.5px solid #2d3344;background:#181c24;color:#fff;font-size:1rem;width:100px;" />
              <input id="item-unit" type="text" placeholder="ë‹¨ìœ„" style="padding:8px 10px;border-radius:6px;border:1.5px solid #2d3344;background:#181c24;color:#fff;font-size:1rem;width:80px;" />
              <button type="button" onclick="addItem()" style="background:#3b82f6;color:#fff;border:none;border-radius:6px;padding:8px 16px;">í’ˆëª© ì¶”ê°€</button>
            </div>
            <div id="items-list" style="margin-bottom:12px;"></div>
          </div>
          <textarea id="site-note" placeholder="ë¹„ê³ " style="padding:8px 10px;border-radius:6px;border:1.5px solid #2d3344;background:#181c24;color:#fff;font-size:1rem;width:100%;min-height:60px;"></textarea>
          <button type="submit" style="background:#22c55e;color:#fff;border:none;border-radius:6px;padding:8px 22px;font-weight:700;">+ í˜„ì¥ ì¶”ê°€</button>
        </form>`;

      content.innerHTML = `<h2>í˜„ì¥ ëª©ë¡</h2>${tabsHtml}${formHtml}<div id="sites-list" style="max-height:600px;overflow-y:auto;"></div>`;

      // ë‹¬ë ¥ ì´ˆê¸°í™”
      initCalendar('start-calendar', 'site-start');
      initCalendar('end-calendar', 'site-end');

      // í’ˆëª© ë¦¬ìŠ¤íŠ¸ ì´ˆê¸°í™”
      window.currentItems = [];
      updateItemsList();

      // í¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
      document.getElementById('site-form').onsubmit = function(e) {
        e.preventDefault();
        const name = document.getElementById('site-name').value.trim();
        const company = document.getElementById('site-company').value.trim();
        const manager = document.getElementById('site-manager').value.trim();
        const status = document.getElementById('site-status').value;
        const address = document.getElementById('site-address').value.trim();
        const phone = document.getElementById('site-phone').value.trim();
        const start = document.getElementById('site-start').value;
        const end = document.getElementById('site-end').value;
        const contract = document.getElementById('site-contract').value;
        const note = document.getElementById('site-note').value.trim();
        const items = window.currentItems;

        if (!name || !status) return;

        db.collection('sites').add({ 
          name, company, manager, status, address, phone, start, end, contract, note, items,
          createdAt: new Date()
        }).then(() => {
          // í¼ ì´ˆê¸°í™”
          document.getElementById('site-name').value = '';
          document.getElementById('site-company').value = '';
          document.getElementById('site-manager').value = '';
          document.getElementById('site-status').value = '';
          document.getElementById('site-address').value = '';
          document.getElementById('site-phone').value = '';
          document.getElementById('site-start').value = '';
          document.getElementById('site-end').value = '';
          document.getElementById('site-contract').value = '';
          document.getElementById('site-note').value = '';
          window.currentItems = [];
          updateItemsList();
        });
      };

      // ì‹¤ì‹œê°„ ë°ì´í„° ê°ì‹œ
      db.collection('sites').onSnapshot(snapshot => {
        renderSitesList(snapshot.docs);
      });
    }

    // ë‹¬ë ¥ ì´ˆê¸°í™”
    function initCalendar(calendarId, inputId) {
      const calendar = document.getElementById(calendarId);
      const input = document.getElementById(inputId);
      
      input.onclick = function() {
        calendar.style.display = calendar.style.display === 'none' ? 'block' : 'none';
        if (calendar.style.display === 'block') {
          renderCalendar(calendar, input);
        }
      };

      document.addEventListener('click', function(e) {
        if (!calendar.contains(e.target) && e.target !== input) {
          calendar.style.display = 'none';
        }
      });
    }

    // ë‹¬ë ¥ ë Œë”ë§
    function renderCalendar(calendar, input) {
      const today = new Date();
      const year = today.getFullYear();
      const month = today.getMonth();
      
      let html = `
        <div style='display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;'>
          <button onclick='changeCalendarMonth(this, -1)' style='background:none;border:none;color:#fff;'>&lt;</button>
          <span>${year}ë…„ ${month+1}ì›”</span>
          <button onclick='changeCalendarMonth(this, 1)' style='background:none;border:none;color:#fff;'>&gt;</button>
        </div>
        <div style='display:grid;grid-template-columns:repeat(7,1fr);gap:4px;'>`;
      
      const weekDays = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
      weekDays.forEach(day => {
        html += `<div style='text-align:center;color:${day==='ì¼'?'#ef4444':'#3b82f6'};'>${day}</div>`;
      });

      const firstDay = new Date(year, month, 1).getDay();
      const lastDate = new Date(year, month+1, 0).getDate();

      for(let i=0; i<firstDay; i++) {
        html += '<div></div>';
      }

      for(let i=1; i<=lastDate; i++) {
        html += `
          <div onclick='selectDate(this, "${input.id}")' 
            style='text-align:center;padding:4px;cursor:pointer;border-radius:4px;'
            data-date='${year}-${String(month+1).padStart(2,'0')}-${String(i).padStart(2,'0')}'>
            ${i}
          </div>`;
      }

      html += '</div>';
      calendar.innerHTML = html;
    }

    // ë‹¬ë ¥ ì›” ë³€ê²½
    window.changeCalendarMonth = function(btn, diff) {
      const calendar = btn.parentNode.parentNode;
      const monthText = btn.parentNode.querySelector('span').textContent;
      const [year, month] = monthText.split('ë…„ ').map(v => parseInt(v));
      const newDate = new Date(year, month-1+diff, 1);
      const input = calendar.parentNode.querySelector('input');
      renderCalendar(calendar, input);
    }

    // ë‚ ì§œ ì„ íƒ
    window.selectDate = function(day, inputId) {
      const date = day.getAttribute('data-date');
      document.getElementById(inputId).value = date;
      day.parentNode.parentNode.style.display = 'none';
    }

    // í’ˆëª© ì¶”ê°€
    window.addItem = function() {
      const name = document.getElementById('item-name').value.trim();
      const quantity = document.getElementById('item-quantity').value;
      const unit = document.getElementById('item-unit').value.trim();
      
      if (!name || !quantity || !unit) return;

      window.currentItems.push({ name, quantity, unit });
      
      document.getElementById('item-name').value = '';
      document.getElementById('item-quantity').value = '';
      document.getElementById('item-unit').value = '';
      
      updateItemsList();
    }

    // í’ˆëª© ë¦¬ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
    function updateItemsList() {
      const container = document.getElementById('items-list');
      let html = '';
      
      window.currentItems.forEach((item, idx) => {
        html += `
          <div style='display:flex;gap:8px;align-items:center;margin-bottom:4px;'>
            <span>${item.name} ${item.quantity}${item.unit}</span>
            <button onclick='removeItem(${idx})' style='background:#ef4444;color:#fff;border:none;border-radius:4px;padding:2px 8px;font-size:0.9em;'>ì‚­ì œ</button>
          </div>`;
      });
      
      container.innerHTML = html;
    }

    // í’ˆëª© ì‚­ì œ
    window.removeItem = function(idx) {
      window.currentItems.splice(idx, 1);
      updateItemsList();
    }

    // í˜„ì¥ ëª©ë¡ ë Œë”ë§
    function renderSitesList(docs) {
      const container = document.getElementById('sites-list');
      let html = `<table style='width:100%;'><thead><tr>
        <th>í˜„ì¥ëª…</th>
        <th>íšŒì‚¬</th>
        <th>í˜„ì¥ì†Œì¥</th>
        <th>ìƒíƒœ</th>
        <th>ì£¼ì†Œ</th>
        <th>ë‹´ë‹¹ì</th>
        <th>ì—°ë½ì²˜</th>
        <th>ê³µì‚¬ê¸°ê°„</th>
        <th>ê³„ì•½ê¸ˆì•¡</th>
        <th>ê´€ë¦¬</th>
      </tr></thead><tbody>`;

      docs.forEach(doc => {
        const d = doc.data();
        html += `<tr>
          <td><input type='text' value='${d.name||''}' id='name-${doc.id}' style='width:120px;padding:4px;border-radius:4px;border:1px solid #2d3344;background:#232837;color:#fff;'></td>
          <td><input type='text' value='${d.company||''}' id='company-${doc.id}' style='width:100px;padding:4px;border-radius:4px;border:1px solid #2d3344;background:#232837;color:#fff;'></td>
          <td><input type='text' value='${d.manager||''}' id='manager-${doc.id}' style='width:100px;padding:4px;border-radius:4px;border:1px solid #2d3344;background:#232837;color:#fff;'></td>
          <td>
            <select id='status-${doc.id}' style='width:100px;padding:4px;border-radius:4px;border:1px solid #2d3344;background:#232837;color:#fff;'>
              <option value='ì§„í–‰ì¤‘' ${d.status==='ì§„í–‰ì¤‘'?'selected':''}>ì§„í–‰ì¤‘</option>
              <option value='ì˜ˆì •' ${d.status==='ì˜ˆì •'?'selected':''}>ì˜ˆì •</option>
              <option value='ì™„ë£Œ' ${d.status==='ì™„ë£Œ'?'selected':''}>ì™„ë£Œ</option>
              <option value='ë³´ë¥˜' ${d.status==='ë³´ë¥˜'?'selected':''}>ë³´ë¥˜</option>
            </select>
          </td>
          <td><input type='text' value='${d.address||''}' id='address-${doc.id}' style='width:150px;padding:4px;border-radius:4px;border:1px solid #2d3344;background:#232837;color:#fff;'></td>
          <td><input type='text' value='${d.manager||''}' id='manager-${doc.id}' style='width:100px;padding:4px;border-radius:4px;border:1px solid #2d3344;background:#232837;color:#fff;'></td>
          <td><input type='text' value='${d.phone||''}' id='phone-${doc.id}' style='width:120px;padding:4px;border-radius:4px;border:1px solid #2d3344;background:#232837;color:#fff;'></td>
          <td>
            <div style='display:flex;gap:4px;align-items:center;'>
              <input type='text' value='${d.start||''}' id='start-${doc.id}' style='width:100px;padding:4px;border-radius:4px;border:1px solid #2d3344;background:#232837;color:#fff;' readonly>
              <span>~</span>
              <input type='text' value='${d.end||''}' id='end-${doc.id}' style='width:100px;padding:4px;border-radius:4px;border:1px solid #2d3344;background:#232837;color:#fff;' readonly>
            </div>
          </td>
          <td><input type='number' value='${d.contract||''}' id='contract-${doc.id}' style='width:120px;padding:4px;border-radius:4px;border:1px solid #2d3344;background:#232837;color:#fff;'></td>
          <td>
            <button onclick="showSiteDetail('${doc.id}')" style='background:#3b82f6;color:#fff;border:none;border-radius:6px;padding:4px 12px;margin-right:4px;'>ìƒì„¸</button>
            <button onclick="updateSite('${doc.id}')" style='background:#2563eb;color:#fff;border:none;border-radius:6px;padding:4px 12px;margin-right:4px;'>ìˆ˜ì •</button>
            <button onclick="deleteSite('${doc.id}')" style='background:#ef4444;color:#fff;border:none;border-radius:6px;padding:4px 12px;'>ì‚­ì œ</button>
          </td>
        </tr>`;
      });

      html += '</tbody></table>';
      container.innerHTML = html;

      // ë‹¬ë ¥ ì´ˆê¸°í™”
      docs.forEach(doc => {
        initCalendar(`start-calendar-${doc.id}`, `start-${doc.id}`);
        initCalendar(`end-calendar-${doc.id}`, `end-${doc.id}`);
      });
    }

    // í˜„ì¥ ìˆ˜ì •
    function updateSite(id) {
      const name = document.getElementById('name-' + id).value.trim();
      const company = document.getElementById('company-' + id).value.trim();
      const manager = document.getElementById('manager-' + id).value.trim();
      const status = document.getElementById('status-' + id).value;
      const address = document.getElementById('address-' + id).value.trim();
      const phone = document.getElementById('phone-' + id).value.trim();
      const start = document.getElementById('start-' + id).value;
      const end = document.getElementById('end-' + id).value;
      const contract = document.getElementById('contract-' + id).value;

      db.collection('sites').doc(id).update({ 
        name, company, manager, status, address, phone, start, end, contract,
        updatedAt: new Date()
      });
    }

    // í˜„ì¥ ì‚­ì œ
    function deleteSite(id) {
      if (confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        db.collection('sites').doc(id).delete();
      }
    }

    // í˜„ì¥ ìƒì„¸ë³´ê¸°
    window.showSiteDetail = function(id) {
      db.collection('sites').doc(id).get().then(doc => {
        const d = doc.data();
        const popupBg = document.createElement('div');
        popupBg.style.cssText = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.4);z-index:2000;display:flex;align-items:center;justify-content:center;';
        popupBg.onclick = function(e){ if(e.target===popupBg) popupBg.remove(); };
        let html = `<div style='background:#232837;padding:32px 28px 24px 28px;border-radius:16px;min-width:320px;max-width:90vw;box-shadow:0 4px 32px #0005;position:relative;'>
          <button onclick='this.parentNode.parentNode.remove()' style='position:absolute;right:16px;top:16px;background:none;border:none;color:#b3b8c5;font-size:1.3rem;cursor:pointer;'>&times;</button>
          <h3 style='margin:0 0 18px 0;color:#3b82f6;'>${d.name||''} í˜„ì¥ ìƒì„¸ì •ë³´</h3>
          <div style='display:grid;grid-template-columns:120px 1fr;gap:12px;align-items:start;'>
            <div>ìƒíƒœ:</div><div>${d.status||''}</div>
            <div>ì£¼ì†Œ:</div><div>${d.address||''}</div>
            <div>ë‹´ë‹¹ì:</div><div>${d.manager||''}</div>
            <div>ì—°ë½ì²˜:</div><div>${d.phone||''}</div>
            <div>ê³µì‚¬ê¸°ê°„:</div><div>${d.start||''} ~ ${d.end||''}</div>
            <div>ê³„ì•½ê¸ˆì•¡:</div><div>${d.contract ? d.contract.toLocaleString() + 'ì›' : ''}</div>
            <div>í’ˆëª©:</div><div>`;
        
        if(d.items && d.items.length > 0) {
          html += '<ul style="margin:0;padding-left:20px;">';
          d.items.forEach(item => {
            html += `<li>${item.name} ${item.quantity}${item.unit}</li>`;
          });
          html += '</ul>';
        }
        
        html += `</div>
            <div>ë¹„ê³ :</div><div style='white-space:pre-wrap;'>${d.note||''}</div>
            <div>ë“±ë¡ì¼:</div><div>${d.createdAt ? d.createdAt.toDate().toLocaleString() : ''}</div>
            <div>ìˆ˜ì •ì¼:</div><div>${d.updatedAt ? d.updatedAt.toDate().toLocaleString() : ''}</div>
          </div>
        </div>`;
        popupBg.innerHTML = html;
        document.body.appendChild(popupBg);
      });
    }

    // ìƒíƒœë³„ í•„í„°ë§
    window.filterSites = function(status) {
      const buttons = document.querySelectorAll('.tab-btn');
      buttons.forEach(btn => {
        btn.classList.toggle('active', btn.getAttribute('data-status') === status);
      });
      
      db.collection('sites').get().then(snapshot => {
        const docs = snapshot.docs.filter(doc => {
          if (status === 'all') return true;
          return doc.data().status === status;
        });
        renderSitesList(docs);
      });
    }

    // ê²€ìƒ‰
    window.searchSites = function() {
      const keyword = document.getElementById('site-search').value.trim().toLowerCase();
      if (!keyword) {
        db.collection('sites').get().then(snapshot => {
          renderSitesList(snapshot.docs);
        });
        return;
      }

      db.collection('sites').get().then(snapshot => {
        const docs = snapshot.docs.filter(doc => {
          const d = doc.data();
          return (
            (d.name || '').toLowerCase().includes(keyword) ||
            (d.address || '').toLowerCase().includes(keyword) ||
            (d.manager || '').toLowerCase().includes(keyword)
          );
        });
        renderSitesList(docs);
      });
    }

    // ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
    window.downloadExcel = function() {
      db.collection('sites').get().then(snapshot => {
        const data = snapshot.docs.map(doc => {
          const d = doc.data();
          return {
            'í˜„ì¥ëª…': d.name || '',
            'ìƒíƒœ': d.status || '',
            'ì£¼ì†Œ': d.address || '',
            'ë‹´ë‹¹ì': d.manager || '',
            'ì—°ë½ì²˜': d.phone || '',
            'ì‹œì‘ì¼': d.start || '',
            'ì¢…ë£Œì¼': d.end || '',
            'ê³„ì•½ê¸ˆì•¡': d.contract || '',
            'í’ˆëª©': (d.items || []).map(item => `${item.name} ${item.quantity}${item.unit}`).join(', '),
            'ë¹„ê³ ': d.note || ''
          };
        });

        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'í˜„ì¥ëª©ë¡');
        XLSX.writeFile(wb, 'í˜„ì¥ëª©ë¡.xlsx');
      });
    }

    // ì—‘ì…€ ì—…ë¡œë“œ
    window.uploadExcel = function(input) {
      const file = input.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, {type: 'array'});
        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(firstSheet);

        jsonData.forEach(row => {
          const items = (row['í’ˆëª©'] || '').split(',').map(item => {
            const [name, rest] = item.trim().split(' ');
            const match = rest.match(/(\d+)(.+)/);
            return {
              name: name,
              quantity: match ? match[1] : '',
              unit: match ? match[2] : ''
            };
          });

          db.collection('sites').add({
            name: row['í˜„ì¥ëª…'] || '',
            status: row['ìƒíƒœ'] || 'ì§„í–‰ì¤‘',
            address: row['ì£¼ì†Œ'] || '',
            manager: row['ë‹´ë‹¹ì'] || '',
            phone: row['ì—°ë½ì²˜'] || '',
            start: row['ì‹œì‘ì¼'] || '',
            end: row['ì¢…ë£Œì¼'] || '',
            contract: row['ê³„ì•½ê¸ˆì•¡'] || '',
            items: items,
            note: row['ë¹„ê³ '] || '',
            createdAt: new Date()
          });
        });

        alert('ì—‘ì…€ ë°ì´í„°ê°€ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
        input.value = '';
      };
      reader.readAsArrayBuffer(file);
    }

    // ê³µì‚¬í˜„í™©ê³¼ ì—°ë™
    function updateStatusCalendar() {
      db.collection('sites').get().then(siteSnap => {
        const sites = siteSnap.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));

        sites.forEach(site => {
          if (!site.start || !site.end) return;

          const start = new Date(site.start);
          const end = new Date(site.end);
          const year = start.getFullYear();
          const month = start.getMonth();

          db.collection('status_calendar').doc(`${year}-${month+1}`).get().then(calDoc => {
            let data = calDoc.exists ? calDoc.data() : {};
            
            for(let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
              const day = d.getDate();
              if (!data[day]) data[day] = [];
              if (!data[day].some(item => item.type === 'site' && item.value === site.name)) {
                data[day].push({
                  type: 'site',
                  value: site.name,
                  siteId: site.id
                });
              }
            }

            db.collection('status_calendar').doc(`${year}-${month+1}`).set(data);
          });
        });
      });
    }

    // í˜„ì¥ ì¶”ê°€/ìˆ˜ì •/ì‚­ì œ ì‹œ ê³µì‚¬í˜„í™© ì—…ë°ì´íŠ¸
    db.collection('sites').onSnapshot(() => {
      updateStatusCalendar();
    });

    // íšŒì›ê°€ì… í™”ë©´
    function renderSignup() {
      document.getElementById('main').innerHTML = `
        <div class="login-box">
          <h2>íšŒì›ê°€ì…</h2>
          <input id="signup-name" type="text" placeholder="ì´ë¦„" autocomplete="name"/>
          <input id="signup-affil" type="text" placeholder="ì†Œì†" autocomplete="organization"/>
          <input id="signup-id" type="text" placeholder="ì´ë©”ì¼" autocomplete="username"/>
          <div style="position:relative;width:100%;">
            <input id="signup-pw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" autocomplete="new-password" style="width:100%;"/>
            <span id="pw-eye" style="position:absolute;right:12px;top:14px;cursor:pointer;font-size:1.2em;color:#b3b8c5;">ğŸ‘ï¸</span>
          </div>
          <button onclick="signup()">íšŒì›ê°€ì…</button>
          <button onclick="renderLogin()" style="background:#232837;color:#fff;">ë¡œê·¸ì¸ í™”ë©´</button>
          <div class="error-msg" id="signup-error"></div>
        </div>
      `;
      document.getElementById('pw-eye').onclick = function(){
        const pw = document.getElementById('signup-pw');
        pw.type = pw.type==='password'?'text':'password';
      };
    }
    // íšŒì›ê°€ì… í•¨ìˆ˜
    function signup() {
      const name = document.getElementById('signup-name').value.trim();
      const affil = document.getElementById('signup-affil').value.trim();
      const email = document.getElementById('signup-id').value.trim();
      const pw = document.getElementById('signup-pw').value.trim();
      
      if (!name || !email || !pw) {
        document.getElementById('signup-error').textContent = 'ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
        return;
      }

      // ì´ë©”ì¼ ë„ë©”ì¸ í™•ì¸
      if (!email.endsWith('@naver.com')) {
        document.getElementById('signup-error').textContent = 'naver.com ì´ë©”ì¼ë§Œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.';
        return;
      }

      let role = email === 'fire8803@naver.com' ? 'master' : 'admin';
      
      firebase.auth().createUserWithEmailAndPassword(email, pw)
        .then((userCredential) => {
          db.collection('users').doc(userCredential.user.uid).set({
            name, affil, email, pw, role, createdAt: new Date()
          });
          alert('íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
          renderLogin();
        })
        .catch((e) => {
          document.getElementById('signup-error').textContent = 'íšŒì›ê°€ì… ì‹¤íŒ¨: ' + (e.message || 'ì˜¤ë¥˜');
        });
    }
    // ë¡œê·¸ì¸ í™”ë©´
    function renderLogin() {
      document.getElementById('main').innerHTML = `
        <div class="login-box">
          <h2>ë¡œê·¸ì¸</h2>
          <input id="login-id" type="text" placeholder="ì´ë©”ì¼" autocomplete="username"/>
          <input id="login-pw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" autocomplete="current-password"/>
          <button onclick="login()">ë¡œê·¸ì¸</button>
          <button onclick="renderSignup()" style="background:#232837;color:#fff;">íšŒì›ê°€ì…</button>
          <div class="error-msg" id="login-error"></div>
        </div>
      `;

      // ì—”í„°í‚¤ë¡œ ë¡œê·¸ì¸
      document.getElementById('login-pw').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          login();
        }
      });
    }
    // ë¡œê·¸ì¸ í•¨ìˆ˜(ë¡œê·¸ì¸ í›„ Firestoreì—ì„œ role í™•ì¸)
    function login() {
      const id = document.getElementById('login-id').value.trim();
      const pw = document.getElementById('login-pw').value.trim();
      firebase.auth().signInWithEmailAndPassword(id, pw)
        .then(() => {
          // ì¸ì¦ ìƒíƒœ ê°ì‹œì—ì„œ ì²˜ë¦¬
        })
        .catch(() => {
          document.getElementById('login-error').textContent = 'ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.';
        });
    }
    // ë¡œê·¸ì•„ì›ƒ
    function logout() {
      firebase.auth().signOut().then(renderLogin);
    }
    // íšŒì› ê´€ë¦¬(ê¶Œí•œë³„ 4ê°œ í…Œì´ë¸”, ì „ì²´ë¦¬ìŠ¤íŠ¸, ì²´í¬ë°•ìŠ¤ ì¼ê´„ì‚­ì œ, ì—‘ì…€, ì‹¤ì‹œê°„)
    function renderUsers() {
      renderMenu('users');
      const content = document.getElementById('content');
      content.innerHTML = `<h2>íšŒì›ëª…ë‹¨</h2>
        <div style='display:flex;gap:8px;margin-bottom:16px;'>
          <button onclick='renderUsers()' style='background:#3b82f6;color:#fff;border:none;border-radius:6px;padding:8px 16px;'>ê¶Œí•œë³„ ë³´ê¸°</button>
          <button onclick='renderAllUsers()' style='background:#232837;color:#fff;border:none;border-radius:6px;padding:8px 16px;'>ì „ì²´ íšŒì›ë¦¬ìŠ¤íŠ¸</button>
          <button onclick='downloadUsersExcel()' style='background:#22c55e;color:#fff;border:none;border-radius:6px;padding:8px 16px;'>ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
          <label style='background:#3b82f6;color:#fff;border:none;border-radius:6px;padding:8px 16px;cursor:pointer;'>ì—‘ì…€ ì—…ë¡œë“œ<input type='file' id='users-excel-upload' accept='.xlsx,.xls' style='display:none;' onchange='uploadUsersExcel(this)'></label>
        </div>
        <div id='users-tables'></div>`;
      db.collection('users').onSnapshot(snapshot => {
        const users = [];
        snapshot.forEach(doc => {
          const d = doc.data();
          users.push({id: doc.id, ...d});
        });
        renderUserTables(users);
      });
    }
    function renderUserTables(users) {
      const tables = [
        {title:'ìš”ì²­', key:'ìš”ì²­', order:0},
        {title:'ëŒ€ë§ˆíŒ€', key:'ëŒ€ë§ˆíŒ€', order:1},
        {title:'ê¸°íƒ€', key:'ê¸°íƒ€', order:2},
        {title:'ê´€ë¦¬ì', key:'admin', order:3},
        {title:'ë§ˆìŠ¤í„°', key:'master', order:4}
      ];
      let html = '';
      tables.forEach(t => {
        let filtered = users.filter(u => (u.role||'').includes(t.key));
        if(t.key==='ê¸°íƒ€') filtered = users.filter(u => u.role && !['ìš”ì²­','ëŒ€ë§ˆíŒ€','admin','master'].includes(u.role));
        if(t.key==='admin') filtered = users.filter(u => u.role==='admin');
        if(t.key==='master') filtered = users.filter(u => u.role==='master');
        if(filtered.length===0) return;
        html += `<div style='margin-bottom:24px;'><h3 style='color:#3b82f6;'>${t.title} (${filtered.length})</h3>`;
        html += `<div style='max-height:260px;overflow-y:auto;'>`;
        html += `<table style='width:100%;'><thead><tr>${t.key!=='admin'&&t.key!=='master'?'<th><input type="checkbox" onclick="toggleAllUsers(this,\''+t.key+'\')"></th>':''}<th>ì´ë¦„</th><th>ì•„ì´ë””</th><th>ë¹„ë°€ë²ˆí˜¸</th><th>ì†Œì†</th><th>ê¶Œí•œ</th><th>ê´€ë¦¬</th></tr></thead><tbody>`;
        filtered.forEach(u => {
          html += `<tr>
            ${t.key!=='admin'&&t.key!=='master'?`<td><input type='checkbox' class='user-chk-${t.key}' value='${u.id}'></td>`:''}
            <td><input type='text' value='${u.name||''}' id='uname-${u.id}' style='width:80px;padding:4px;border-radius:4px;border:1px solid #2d3344;background:#232837;color:#fff;'></td>
            <td>${u.email||''}</td>
            <td><input type='password' value='${u.pw||''}' id='upw-${u.id}' style='width:100px;padding:4px;border-radius:4px;border:1px solid #2d3344;background:#232837;color:#fff;'><span style='cursor:pointer;margin-left:6px;' onclick='togglePw("upw-${u.id}")'>ğŸ‘ï¸</span></td>
            <td><input type='text' value='${u.affil||''}' id='uaffil-${u.id}' style='width:100px;padding:4px;border-radius:4px;border:1px solid #2d3344;background:#232837;color:#fff;'></td>
            <td><select id='urole-${u.id}' style='padding:4px 8px;border-radius:4px;background:#232837;color:#fff;'>
              <option value='ìš”ì²­' ${u.role==='ìš”ì²­'?'selected':''}>ìš”ì²­</option>
              <option value='ëŒ€ë§ˆíŒ€' ${u.role==='ëŒ€ë§ˆíŒ€'?'selected':''}>ëŒ€ë§ˆíŒ€</option>
              <option value='ê¸°íƒ€' ${u.role!=='ìš”ì²­'&&u.role!=='ëŒ€ë§ˆíŒ€'&&u.role!=='admin'&&u.role!=='master'?'selected':''}>ê¸°íƒ€</option>
              <option value='admin' ${u.role==='admin'?'selected':''}>ê´€ë¦¬ì</option>
              <option value='master' ${u.role==='master'?'selected':''}>ë§ˆìŠ¤í„°</option>
            </select></td>
            <td><button onclick='updateUser("${u.id}")' style='background:#3b82f6;color:#fff;border:none;border-radius:6px;padding:4px 12px;margin-right:4px;'>ìˆ˜ì •</button>${t.key!=='admin'&&t.key!=='master'?`<button onclick='deleteUser("${u.id}")' style='background:#ef4444;color:#fff;border:none;border-radius:6px;padding:4px 12px;'>ì‚­ì œ</button>`:''}</td>
          </tr>`;
        });
        html += `</tbody></table>`;
        if(filtered.length>5) html += `<div style='height:8px;'></div>`;
        if(t.key!=='admin'&&t.key!=='master') html += `<button onclick='deleteCheckedUsers("${t.key}")' style='background:#ef4444;color:#fff;border:none;border-radius:6px;padding:4px 16px;margin-top:8px;'>ì„ íƒì‚­ì œ</button>`;
        html += `</div></div>`;
      });
      document.getElementById('users-tables').innerHTML = html;
    }
    window.togglePw = function(id) {
      const input = document.getElementById(id);
      input.type = input.type==='password'?'text':'password';
    }
    window.toggleAllUsers = function(chk, role) {
      document.querySelectorAll('.user-chk-'+role).forEach(c=>c.checked=chk.checked);
    }
    window.deleteCheckedUsers = function(role) {
      const ids = Array.from(document.querySelectorAll('.user-chk-'+role+':checked')).map(c=>c.value);
      if(ids.length===0) return;
      if(!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      ids.forEach(id=>db.collection('users').doc(id).delete());
    }
    window.updateUser = function(id) {
      const name = document.getElementById('uname-'+id).value.trim();
      const pw = document.getElementById('upw-'+id).value.trim();
      const affil = document.getElementById('uaffil-'+id).value.trim();
      let role = document.getElementById('urole-'+id).value;
      if(role==='ê¸°íƒ€') role = 'ê¸°íƒ€';
      db.collection('users').doc(id).update({ name, pw, affil, role, updatedAt: new Date() });
    }
    window.deleteUser = function(id) {
      if(confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) db.collection('users').doc(id).delete();
    }
    // ì „ì²´ íšŒì›ë¦¬ìŠ¤íŠ¸
    function renderAllUsers() {
      renderMenu('users');
      const content = document.getElementById('content');
      content.innerHTML = `<h2>ì „ì²´ íšŒì›ë¦¬ìŠ¤íŠ¸</h2>
        <div style='display:flex;gap:8px;margin-bottom:16px;'>
          <button onclick='renderUsers()' style='background:#232837;color:#fff;border:none;border-radius:6px;padding:8px 16px;'>ê¶Œí•œë³„ ë³´ê¸°</button>
          <button onclick='downloadUsersExcel()' style='background:#22c55e;color:#fff;border:none;border-radius:6px;padding:8px 16px;'>ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
          <label style='background:#3b82f6;color:#fff;border:none;border-radius:6px;padding:8px 16px;cursor:pointer;'>ì—‘ì…€ ì—…ë¡œë“œ<input type='file' id='users-excel-upload' accept='.xlsx,.xls' style='display:none;' onchange='uploadUsersExcel(this)'></label>
        </div>
        <div id='all-users-table'></div>`;
      db.collection('users').onSnapshot(snapshot => {
        const users = [];
        snapshot.forEach(doc => {
          const d = doc.data();
          users.push({id: doc.id, ...d});
        });
        let html = `<div style='max-height:400px;overflow-y:auto;'><table style='width:100%;'><thead><tr><th>ì´ë¦„</th><th>ì•„ì´ë””</th><th>ë¹„ë°€ë²ˆí˜¸</th><th>ì†Œì†</th><th>ê¶Œí•œ</th><th>ê´€ë¦¬</th></tr></thead><tbody>`;
        users.forEach(u => {
          html += `<tr>
            <td><input type='text' value='${u.name||''}' id='uname-${u.id}' style='width:80px;padding:4px;border-radius:4px;border:1px solid #2d3344;background:#232837;color:#fff;'></td>
            <td>${u.email||''}</td>
            <td><input type='password' value='${u.pw||''}' id='upw-${u.id}' style='width:100px;padding:4px;border-radius:4px;border:1px solid #2d3344;background:#232837;color:#fff;'><span style='cursor:pointer;margin-left:6px;' onclick='togglePw("upw-${u.id}")'>ğŸ‘ï¸</span></td>
            <td><input type='text' value='${u.affil||''}' id='uaffil-${u.id}' style='width:100px;padding:4px;border-radius:4px;border:1px solid #2d3344;background:#232837;color:#fff;'></td>
            <td><select id='urole-${u.id}' style='padding:4px 8px;border-radius:4px;background:#232837;color:#fff;'>
              <option value='ìš”ì²­' ${u.role==='ìš”ì²­'?'selected':''}>ìš”ì²­</option>
              <option value='ëŒ€ë§ˆíŒ€' ${u.role==='ëŒ€ë§ˆíŒ€'?'selected':''}>ëŒ€ë§ˆíŒ€</option>
              <option value='ê¸°íƒ€' ${u.role!=='ìš”ì²­'&&u.role!=='ëŒ€ë§ˆíŒ€'&&u.role!=='admin'&&u.role!=='master'?'selected':''}>ê¸°íƒ€</option>
              <option value='admin' ${u.role==='admin'?'selected':''}>ê´€ë¦¬ì</option>
              <option value='master' ${u.role==='master'?'selected':''}>ë§ˆìŠ¤í„°</option>
            </select></td>
            <td><button onclick='updateUser("${u.id}")' style='background:#3b82f6;color:#fff;border:none;border-radius:6px;padding:4px 12px;margin-right:4px;'>ìˆ˜ì •</button><button onclick='deleteUser("${u.id}")' style='background:#ef4444;color:#fff;border:none;border-radius:6px;padding:4px 12px;'>ì‚­ì œ</button></td>
          </tr>`;
        });
        html += `</tbody></table></div>`;
        document.getElementById('all-users-table').innerHTML = html;
      });
    }
    // ì—‘ì…€ ë‹¤ìš´ë¡œë“œ/ì—…ë¡œë“œ
    window.downloadUsersExcel = function() {
      db.collection('users').get().then(snapshot => {
        const data = snapshot.docs.map(doc => {
          const d = doc.data();
          return {
            'ì´ë¦„': d.name||'',
            'ì•„ì´ë””': d.email||'',
            'ë¹„ë°€ë²ˆí˜¸': d.pw||'',
            'ì†Œì†': d.affil||'',
            'ê¶Œí•œ': d.role||'',
            'ê°€ì…ì¼': d.createdAt?d.createdAt.toDate().toLocaleString():'',
          };
        });
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'íšŒì›ëª…ë‹¨');
        XLSX.writeFile(wb, 'íšŒì›ëª…ë‹¨.xlsx');
      });
    }
    window.uploadUsersExcel = function(input) {
      const file = input.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, {type: 'array'});
        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(firstSheet);
        jsonData.forEach(row => {
          db.collection('users').add({
            name: row['ì´ë¦„']||'',
            email: row['ì•„ì´ë””']||'',
            pw: row['ë¹„ë°€ë²ˆí˜¸']||'',
            affil: row['ì†Œì†']||'',
            role: row['ê¶Œí•œ']||'',
            createdAt: new Date(row['ê°€ì…ì¼']||Date.now())
          });
        });
        alert('ì—‘ì…€ ë°ì´í„°ê°€ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
        input.value = '';
      };
      reader.readAsArrayBuffer(file);
    }

    // ê¶Œí•œì„¤ì • í™”ë©´
    function renderRoleSettings() {
      renderMenu('roles');
      const content = document.getElementById('content');
      // ë©”ë‰´ë³„ ê¶Œí•œ(ì½ê¸°/ì“°ê¸°/ìˆ˜ì •/ì‚­ì œ)
      const menus = [
        {key:'sites', label:'í˜„ì¥'},
        {key:'status', label:'ê³µì‚¬í˜„í™©'},
        {key:'discussion', label:'í˜‘ì˜í•˜ê¸°'},
        {key:'progress', label:'ê¸°ì„±í˜„í™©'},
        {key:'partners', label:'ê±°ë˜ì²˜'},
        {key:'users', label:'íšŒì›ëª…ë‹¨'},
        {key:'roles', label:'ê¶Œí•œì„¤ì •'}
      ];
      content.innerHTML = `<h2>ê¶Œí•œì„¤ì •</h2><form id='role-form'><table style='width:100%;'><thead><tr><th>ë©”ë‰´</th><th>ì½ê¸°</th><th>ì“°ê¸°</th><th>ìˆ˜ì •</th><th>ì‚­ì œ</th></tr></thead><tbody id='role-tbody'></tbody></table><button type='submit' style='background:#22c55e;color:#fff;border:none;border-radius:6px;padding:10px 28px;font-weight:700;margin-top:18px;'>ì €ì¥</button></form>`;
      db.collection('role_settings').doc('default').get().then(docSnap => {
        const data = docSnap.exists ? docSnap.data() : {};
        let html = '';
        menus.forEach(m => {
          html += `<tr><td>${m.label}</td>`;
          ['read','write','update','delete'].forEach(act => {
            html += `<td><input type='checkbox' name='${m.key}-${act}' ${data[m.key]&&data[m.key][act]?'checked':''}></td>`;
          });
          html += '</tr>';
        });
        document.getElementById('role-tbody').innerHTML = html;
      });
      document.getElementById('role-form').onsubmit = function(e) {
        e.preventDefault();
        const data = {};
        menus.forEach(m => {
          data[m.key] = {
            read: document.querySelector(`input[name='${m.key}-read']`).checked,
            write: document.querySelector(`input[name='${m.key}-write']`).checked,
            update: document.querySelector(`input[name='${m.key}-update']`).checked,
            delete: document.querySelector(`input[name='${m.key}-delete']`).checked
          };
        });
        db.collection('role_settings').doc('default').set(data).then(()=>{
          alert('ê¶Œí•œì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
        });
      }
    }

    // ê³µì‚¬í˜„í™©(ë‹¬ë ¥+í˜„ì¥ë¦¬ìŠ¤íŠ¸+ì¶”ê°€ì‚¬í•­) Firestore ì—°ë™ 1ì°¨ êµ¬í˜„ (ë‚ ì§œë³„ í˜„ì¥/ì¶”ê°€ì‚¬í•­ í‘œì‹œ, íŒì—… ì¶”ê°€)
    function renderStatus() {
      renderMenu('status');
      const content = document.getElementById('content');
      // ì›” ë„¤ë¹„ê²Œì´ì…˜
      let today = window.statusToday || new Date();
      let year = today.getFullYear();
      let month = today.getMonth();
      let firstDay = new Date(year, month, 1).getDay();
      let lastDate = new Date(year, month+1, 0).getDate();
      db.collection('sites').get().then(siteSnap => {
        const sites = [];
        siteSnap.forEach(doc => sites.push(doc.data()));
        db.collection('status_calendar').doc(`${year}-${month+1}`).get().then(calDoc => {
          const calendarData = calDoc.exists ? calDoc.data() : {};
          // ë‹¬ë ¥ UI
          let calHtml = `<div style='display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;'>
            <button onclick='changeStatusMonth(-1)' style='background:#232837;color:#fff;border:none;border-radius:6px;padding:6px 18px;font-size:1.2rem;'>&lt;</button>
            <span style='font-size:1.3rem;font-weight:700;'>${year}ë…„ ${month+1}ì›”</span>
            <button onclick='changeStatusMonth(1)' style='background:#232837;color:#fff;border:none;border-radius:6px;padding:6px 18px;font-size:1.2rem;'>&gt;</button>
          </div>`;
          calHtml += `<table style='width:100%;table-layout:fixed;'><thead><tr>`;
          const weekDays = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
          for(let i=0;i<7;i++) calHtml += `<th style='color:${i===0?'#ef4444':'#3b82f6'}'>${weekDays[i]}</th>`;
          calHtml += `</tr></thead><tbody><tr>`;
          let day = 1;
          for(let i=0;i<firstDay;i++) calHtml += '<td></td>';
          for(let i=firstDay;i<7;i++) {
            calHtml += renderCalendarCell(day, calendarData, sites);
            day++;
          }
          calHtml += '</tr>';
          while(day<=lastDate) {
            calHtml += '<tr>';
            for(let i=0;i<7;i++) {
              if(day>lastDate) { calHtml += '<td></td>'; continue; }
              calHtml += renderCalendarCell(day, calendarData, sites);
              day++;
            }
            calHtml += '</tr>';
          }
          calHtml += '</tbody></table>';
          // í˜„ì¥ ë¦¬ìŠ¤íŠ¸
          let siteHtml = `<div style='margin-top:24px;'><b>í˜„ì¥ ë¦¬ìŠ¤íŠ¸</b><ul style='padding-left:18px;'>`;
          sites.forEach(s=>{siteHtml+=`<li>${s.name||''} (${s.status||''})</li>`});
          siteHtml += '</ul></div>';
          content.innerHTML = `<h2>ê³µì‚¬í˜„í™©</h2>${calHtml}${siteHtml}`;
        });
      });
    }
    // ë‹¬ë ¥ ì…€ ë Œë”ë§ (ë‚ ì§œë³„ í˜„ì¥/ì¶”ê°€ì‚¬í•­ í‘œì‹œ, í´ë¦­ ì‹œ íŒì—…)
    function renderCalendarCell(day, calendarData, sites) {
      let cell = `<td style='vertical-align:top;height:60px;position:relative;cursor:pointer;' onclick='showStatusPopup(${day})'>`;
      cell += `<div style='position:absolute;top:4px;right:8px;font-size:1rem;font-weight:700;'>${day}</div>`;
      let items = (calendarData[day]||[]);
      if(items.length>0) {
        cell += `<div style='margin-top:22px;'>`;
        items.forEach((item,idx)=>{
          if(item.type==='site') cell += `<div style='background:#3b82f6;color:#fff;border-radius:4px;padding:2px 6px;margin:2px 0;font-size:0.95em;'>${item.value}</div>`;
          if(item.type==='extra') cell += `<div style='background:#232837;color:#fff;border-radius:4px;padding:2px 6px;margin:2px 0;font-size:0.95em;'>${item.value}</div>`;
        });
        cell += `</div>`;
      }
      cell += `</td>`;
      return cell;
    }
    // íŒì—… í‘œì‹œ í•¨ìˆ˜(í˜„ì¥/ì¶”ê°€ì‚¬í•­ ì¶”ê°€/ì‚­ì œ)
    window.showStatusPopup = function(day) {
      let today = window.statusToday || new Date();
      let year = today.getFullYear();
      let month = today.getMonth();
      const popupBg = document.createElement('div');
      popupBg.style.cssText = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.4);z-index:2000;display:flex;align-items:center;justify-content:center;';
      popupBg.onclick = function(e){ if(e.target===popupBg) popupBg.remove(); };
      db.collection('status_calendar').doc(`${year}-${month+1}`).get().then(docSnap => {
        const data = docSnap.exists ? docSnap.data() : {};
        const items = data[day]||[];
        let html = `<div style='background:#232837;padding:32px 28px 24px 28px;border-radius:16px;min-width:320px;max-width:90vw;box-shadow:0 4px 32px #0005;position:relative;'>
          <button onclick='this.parentNode.parentNode.remove()' style='position:absolute;right:16px;top:16px;background:none;border:none;color:#b3b8c5;font-size:1.3rem;cursor:pointer;'>&times;</button>
          <h3 style='margin:0 0 18px 0;color:#3b82f6;'>${year}ë…„ ${month+1}ì›” ${day}ì¼</h3>
          <div><b>í˜„ì¥/ì¶”ê°€ì‚¬í•­</b></div>
          <ul style='padding-left:18px;margin-bottom:12px;'>`;
        items.forEach((item,idx)=>{
          html += `<li style='margin-bottom:4px;'>
            <span style='background:${item.type==='site'?'#3b82f6':'#232837'};color:#fff;border-radius:4px;padding:2px 8px;'>${item.value}</span>
            <button onclick='deleteStatusItem(${day},${idx})' style='background:#ef4444;color:#fff;border:none;border-radius:4px;padding:2px 8px;margin-left:6px;font-size:0.95em;'>ì‚­ì œ</button>
          </li>`;
        });
        html += `</ul>
          <form id='popup-add-form' style='display:flex;gap:8px;margin-top:8px;'>
            <select id='popup-type' style='padding:6px 8px;border-radius:6px;'>
              <option value='site'>í˜„ì¥</option>
              <option value='extra'>ì¶”ê°€ì‚¬í•­</option>
            </select>
            <input id='popup-value' type='text' placeholder='ë‚´ìš© ì…ë ¥' style='flex:1;padding:6px 8px;border-radius:6px;'>
            <button type='submit' style='background:#22c55e;color:#fff;border:none;border-radius:6px;padding:6px 16px;'>ì¶”ê°€</button>
          </form>
        </div>`;
        popupBg.innerHTML = html;
        document.body.appendChild(popupBg);
        document.getElementById('popup-add-form').onsubmit = function(e) {
          e.preventDefault();
          const type = document.getElementById('popup-type').value;
          const value = document.getElementById('popup-value').value.trim();
          if(!value) return;
          const calRef = db.collection('status_calendar').doc(`${year}-${month+1}`);
          calRef.get().then(docSnap2 => {
            let data2 = docSnap2.exists ? docSnap2.data() : {};
            if(!data2[day]) data2[day]=[];
            data2[day].push({type,value});
            calRef.set(data2).then(()=>{
              popupBg.remove();
              renderStatus();
            });
          });
        };
      });
    }
    // ì‚­ì œ í•¨ìˆ˜
    window.deleteStatusItem = function(day, idx) {
      let today = window.statusToday || new Date();
      let year = today.getFullYear();
      let month = today.getMonth();
      const calRef = db.collection('status_calendar').doc(`${year}-${month+1}`);
      calRef.get().then(docSnap => {
        let data = docSnap.exists ? docSnap.data() : {};
        if(!data[day]) return;
        data[day].splice(idx,1);
        calRef.set(data).then(()=>{
          renderStatus();
        });
      });
    }
    // ì›” ë„¤ë¹„ê²Œì´ì…˜ í•¨ìˆ˜
    function changeStatusMonth(diff) {
      let today = window.statusToday || new Date();
      today = new Date(today.getFullYear(), today.getMonth()+diff, 1);
      window.statusToday = today;
      renderStatus();
    }

    // í˜‘ì˜í•˜ê¸° í™”ë©´
    function renderDiscussion() {
      renderMenu('discussion');
      const content = document.getElementById('content');
      
      // ê²€ìƒ‰ ë° í•„í„°
      let filterHtml = `
        <div style='display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;'>
          <div style='display:flex;gap:8px;'>
            <input type='text' id='discussion-search' placeholder='ì œëª©/ë‚´ìš© ê²€ìƒ‰' style='padding:8px 12px;border-radius:6px;border:1.5px solid #2d3344;background:#181c24;color:#fff;width:300px;'>
            <button onclick='searchDiscussion()' style='background:#3b82f6;color:#fff;border:none;border-radius:6px;padding:8px 16px;'>ê²€ìƒ‰</button>
          </div>
          <button onclick='downloadDiscussionExcel()' style='background:#22c55e;color:#fff;border:none;border-radius:6px;padding:8px 16px;'>ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
        </div>`;

      // ì‘ì„± í¼
      let formHtml = `
        <form id="discussion-form" style="margin-bottom:32px;">
          <div style="margin-bottom:16px;">
            <input type="text" id="discussion-title" placeholder="ì œëª©" style="width:100%;padding:12px;border-radius:6px;border:1.5px solid #2d3344;background:#181c24;color:#fff;font-size:1.1rem;" required>
          </div>
          <div style="margin-bottom:16px;">
            <div style="display:flex;gap:8px;margin-bottom:8px;">
              <input type="text" id="discussion-site-search" placeholder="í˜„ì¥ ê²€ìƒ‰" style="padding:8px 12px;border-radius:6px;border:1.5px solid #2d3344;background:#181c24;color:#fff;width:200px;">
              <button type="button" onclick="searchDiscussionSites()" style="background:#3b82f6;color:#fff;border:none;border-radius:6px;padding:8px 16px;">ê²€ìƒ‰</button>
            </div>
            <div id="sites-checkbox-list" style="max-height:200px;overflow-y:auto;padding:12px;border:1.5px solid #2d3344;border-radius:6px;background:#181c24;"></div>
          </div>
          <div style="margin-bottom:16px;">
            <textarea id="discussion-content" placeholder="í˜‘ì˜ ë‚´ìš©" style="width:100%;min-height:200px;padding:12px;border-radius:6px;border:1.5px solid #2d3344;background:#181c24;color:#fff;font-size:1rem;" required></textarea>
          </div>
          <div style="margin-bottom:16px;">
            <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;">
              <input type="file" id="discussion-images" multiple accept="image/*" style="display:none;" onchange="previewImages(this)">
              <label style="background:#3b82f6;color:#fff;border:none;border-radius:6px;padding:8px 16px;cursor:pointer;">
                ì‚¬ì§„ ì¶”ê°€
                <input type="file" id="discussion-images" multiple accept="image/*" style="display:none;" onchange="previewImages(this)">
              </label>
            </div>
            <div id="image-preview" style="display:flex;gap:8px;flex-wrap:wrap;"></div>
          </div>
          <button type="submit" style="background:#22c55e;color:#fff;border:none;border-radius:6px;padding:12px 24px;font-weight:700;font-size:1.1rem;">ì‘ì„±í•˜ê¸°</button>
        </form>`;

      content.innerHTML = `<h2>í˜‘ì˜í•˜ê¸°</h2>${filterHtml}${formHtml}<div id="discussion-list"></div>`;

      // í˜„ì¥ ëª©ë¡ ë¡œë“œ
      loadDiscussionSites();

      // í¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
      document.getElementById('discussion-form').onsubmit = function(e) {
        e.preventDefault();
        const title = document.getElementById('discussion-title').value.trim();
        const content = document.getElementById('discussion-content').value.trim();
        const selectedSites = Array.from(document.querySelectorAll('input[name="discussion-sites"]:checked')).map(cb => ({
          id: cb.value,
          name: cb.getAttribute('data-name')
        }));
        const images = window.discussionImages || [];

        if (!title || !content || selectedSites.length === 0) {
          alert('ì œëª©, ë‚´ìš©, í˜„ì¥ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          return;
        }

        // ì´ë¯¸ì§€ ì—…ë¡œë“œ
        Promise.all(images.map(file => {
          const storageRef = firebase.storage().ref();
          const imageRef = storageRef.child(`discussions/${Date.now()}_${file.name}`);
          return imageRef.put(file).then(snapshot => snapshot.ref.getDownloadURL());
        })).then(imageUrls => {
          // í˜‘ì˜ ë‚´ìš© ì €ì¥
          db.collection('discussions').add({
            title,
            content,
            sites: selectedSites,
            images: imageUrls,
            author: {
              uid: firebase.auth().currentUser.uid,
              email: firebase.auth().currentUser.email
            },
            createdAt: new Date()
          }).then(() => {
            // í¼ ì´ˆê¸°í™”
            document.getElementById('discussion-title').value = '';
            document.getElementById('discussion-content').value = '';
            document.querySelectorAll('input[name="discussion-sites"]').forEach(cb => cb.checked = false);
            document.getElementById('image-preview').innerHTML = '';
            window.discussionImages = [];
          });
        });
      };

      // í˜‘ì˜ ëª©ë¡ ë¡œë“œ
      loadDiscussions();
    }

    // í˜„ì¥ ëª©ë¡ ë¡œë“œ
    function loadDiscussionSites() {
      const container = document.getElementById('sites-checkbox-list');
      db.collection('sites').get().then(snapshot => {
        let html = '';
        snapshot.forEach(doc => {
          const d = doc.data();
          html += `
            <div style="margin-bottom:8px;">
              <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                <input type="checkbox" name="discussion-sites" value="${doc.id}" data-name="${d.name}" style="width:16px;height:16px;">
                <span>${d.name} (${d.status})</span>
              </label>
            </div>`;
        });
        container.innerHTML = html;
      });
    }

    // í˜„ì¥ ê²€ìƒ‰
    window.searchDiscussionSites = function() {
      const keyword = document.getElementById('discussion-site-search').value.trim().toLowerCase();
      const checkboxes = document.querySelectorAll('input[name="discussion-sites"]');
      
      checkboxes.forEach(cb => {
        const name = cb.getAttribute('data-name').toLowerCase();
        const parent = cb.parentNode.parentNode;
        parent.style.display = name.includes(keyword) ? 'block' : 'none';
      });
    }

    // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°
    window.previewImages = function(input) {
      const preview = document.getElementById('image-preview');
      window.discussionImages = window.discussionImages || [];
      
      Array.from(input.files).forEach(file => {
        window.discussionImages.push(file);
        const reader = new FileReader();
        reader.onload = function(e) {
          preview.innerHTML += `
            <div style="position:relative;width:100px;height:100px;">
              <img src="${e.target.result}" style="width:100%;height:100%;object-fit:cover;border-radius:6px;">
              <button onclick="removeImage(this)" style="position:absolute;top:-8px;right:-8px;background:#ef4444;color:#fff;border:none;border-radius:50%;width:20px;height:20px;font-size:14px;cursor:pointer;">Ã—</button>
            </div>`;
        };
        reader.readAsDataURL(file);
      });
    }

    // ì´ë¯¸ì§€ ì œê±°
    window.removeImage = function(btn) {
      const index = Array.from(btn.parentNode.parentNode.children).indexOf(btn.parentNode);
      window.discussionImages.splice(index, 1);
      btn.parentNode.remove();
    }

    // í˜‘ì˜ ëª©ë¡ ë¡œë“œ
    function loadDiscussions() {
      const container = document.getElementById('discussion-list');
      db.collection('discussions').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
        let html = '';
        snapshot.forEach(doc => {
          const d = doc.data();
          const isAuthor = d.author.uid === firebase.auth().currentUser.uid;
          const isAdmin = window.currentUserRole === 'admin' || window.currentUserRole === 'master';
          
          html += `
            <div style="background:#232837;border-radius:12px;padding:24px;margin-bottom:16px;">
              <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:16px;">
                <div>
                  <h3 style="margin:0 0 8px 0;color:#3b82f6;">${d.title}</h3>
                  <div style="color:#b3b8c5;font-size:0.9rem;">
                    ì‘ì„±ì: ${d.author.email} | ${d.createdAt.toDate().toLocaleString()}
                  </div>
                </div>
                ${isAuthor || isAdmin ? `
                  <div style="display:flex;gap:8px;">
                    <button onclick="editDiscussion('${doc.id}')" style="background:#3b82f6;color:#fff;border:none;border-radius:6px;padding:6px 12px;">ìˆ˜ì •</button>
                    <button onclick="deleteDiscussion('${doc.id}')" style="background:#ef4444;color:#fff;border:none;border-radius:6px;padding:6px 12px;">ì‚­ì œ</button>
                  </div>
                ` : ''}
              </div>
              <div style="margin-bottom:16px;">
                <div style="color:#b3b8c5;margin-bottom:8px;">ê´€ë ¨ í˜„ì¥:</div>
                <div style="display:flex;gap:8px;flex-wrap:wrap;">
                  ${d.sites.map(site => `
                    <span style="background:#181c24;color:#fff;padding:4px 8px;border-radius:4px;">${site.name}</span>
                  `).join('')}
                </div>
              </div>
              <div style="margin-bottom:16px;white-space:pre-wrap;">${d.content}</div>
              ${d.images && d.images.length > 0 ? `
                <div style="display:flex;gap:8px;flex-wrap:wrap;">
                  ${d.images.map(url => `
                    <img src="${url}" style="width:100px;height:100px;object-fit:cover;border-radius:6px;cursor:pointer;" onclick="showImage('${url}')">
                  `).join('')}
                </div>
              ` : ''}
            </div>`;
        });
        container.innerHTML = html;
      });
    }

    // ì´ë¯¸ì§€ í™•ëŒ€ë³´ê¸°
    window.showImage = function(url) {
      const popupBg = document.createElement('div');
      popupBg.style.cssText = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.8);z-index:2000;display:flex;align-items:center;justify-content:center;';
      popupBg.onclick = function(e){ if(e.target===popupBg) popupBg.remove(); };
      popupBg.innerHTML = `<img src="${url}" style="max-width:90vw;max-height:90vh;object-fit:contain;">`;
      document.body.appendChild(popupBg);
    }

    // í˜‘ì˜ ìˆ˜ì •
    window.editDiscussion = function(id) {
      db.collection('discussions').doc(id).get().then(doc => {
        const d = doc.data();
        document.getElementById('discussion-title').value = d.title;
        document.getElementById('discussion-content').value = d.content;
        document.querySelectorAll('input[name="discussion-sites"]').forEach(cb => {
          cb.checked = d.sites.some(site => site.id === cb.value);
        });
        
        // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°
        const preview = document.getElementById('image-preview');
        preview.innerHTML = '';
        if (d.images && d.images.length > 0) {
          d.images.forEach(url => {
            preview.innerHTML += `
              <div style="position:relative;width:100px;height:100px;">
                <img src="${url}" style="width:100%;height:100%;object-fit:cover;border-radius:6px;">
                <button onclick="removeImage(this)" style="position:absolute;top:-8px;right:-8px;background:#ef4444;color:#fff;border:none;border-radius:50%;width:20px;height:20px;font-size:14px;cursor:pointer;">Ã—</button>
              </div>`;
          });
        }
        
        // í¼ ì œì¶œ ì´ë²¤íŠ¸ ë³€ê²½
        const form = document.getElementById('discussion-form');
        form.onsubmit = function(e) {
          e.preventDefault();
          const title = document.getElementById('discussion-title').value.trim();
          const content = document.getElementById('discussion-content').value.trim();
          const selectedSites = Array.from(document.querySelectorAll('input[name="discussion-sites"]:checked')).map(cb => ({
            id: cb.value,
            name: cb.getAttribute('data-name')
          }));
          const images = window.discussionImages || [];

          if (!title || !content || selectedSites.length === 0) {
            alert('ì œëª©, ë‚´ìš©, í˜„ì¥ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
          }

          // ìƒˆ ì´ë¯¸ì§€ ì—…ë¡œë“œ
          Promise.all(images.map(file => {
            const storageRef = firebase.storage().ref();
            const imageRef = storageRef.child(`discussions/${Date.now()}_${file.name}`);
            return imageRef.put(file).then(snapshot => snapshot.ref.getDownloadURL());
          })).then(newImageUrls => {
            // ê¸°ì¡´ ì´ë¯¸ì§€ì™€ ìƒˆ ì´ë¯¸ì§€ í•©ì¹˜ê¸°
            const existingImages = Array.from(document.querySelectorAll('#image-preview img')).map(img => img.src);
            const allImages = [...existingImages, ...newImageUrls];

            // í˜‘ì˜ ë‚´ìš© ì—…ë°ì´íŠ¸
            db.collection('discussions').doc(id).update({
              title,
              content,
              sites: selectedSites,
              images: allImages,
              updatedAt: new Date()
            }).then(() => {
              // í¼ ì´ˆê¸°í™”
              document.getElementById('discussion-title').value = '';
              document.getElementById('discussion-content').value = '';
              document.querySelectorAll('input[name="discussion-sites"]').forEach(cb => cb.checked = false);
              document.getElementById('image-preview').innerHTML = '';
              window.discussionImages = [];
              
              // í¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì›ë˜ëŒ€ë¡œ ë³µêµ¬
              form.onsubmit = null;
              renderDiscussion();
            });
          });
        };
      });
    }

    // í˜‘ì˜ ì‚­ì œ
    window.deleteDiscussion = function(id) {
      if (confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        db.collection('discussions').doc(id).delete();
      }
    }

    // í˜‘ì˜ ê²€ìƒ‰
    window.searchDiscussion = function() {
      const keyword = document.getElementById('discussion-search').value.trim().toLowerCase();
      if (!keyword) {
        loadDiscussions();
        return;
      }

      db.collection('discussions').get().then(snapshot => {
        const container = document.getElementById('discussion-list');
        let html = '';
        
        snapshot.forEach(doc => {
          const d = doc.data();
          if (
            d.title.toLowerCase().includes(keyword) ||
            d.content.toLowerCase().includes(keyword) ||
            d.sites.some(site => site.name.toLowerCase().includes(keyword))
          ) {
            const isAuthor = d.author.uid === firebase.auth().currentUser.uid;
            const isAdmin = window.currentUserRole === 'admin' || window.currentUserRole === 'master';
            
            html += `
              <div style="background:#232837;border-radius:12px;padding:24px;margin-bottom:16px;">
                <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:16px;">
                  <div>
                    <h3 style="margin:0 0 8px 0;color:#3b82f6;">${d.title}</h3>
                    <div style="color:#b3b8c5;font-size:0.9rem;">
                      ì‘ì„±ì: ${d.author.email} | ${d.createdAt.toDate().toLocaleString()}
                    </div>
                  </div>
                  ${isAuthor || isAdmin ? `
                    <div style="display:flex;gap:8px;">
                      <button onclick="editDiscussion('${doc.id}')" style="background:#3b82f6;color:#fff;border:none;border-radius:6px;padding:6px 12px;">ìˆ˜ì •</button>
                      <button onclick="deleteDiscussion('${doc.id}')" style="background:#ef4444;color:#fff;border:none;border-radius:6px;padding:6px 12px;">ì‚­ì œ</button>
                    </div>
                  ` : ''}
                </div>
                <div style="margin-bottom:16px;">
                  <div style="color:#b3b8c5;margin-bottom:8px;">ê´€ë ¨ í˜„ì¥:</div>
                  <div style="display:flex;gap:8px;flex-wrap:wrap;">
                    ${d.sites.map(site => `
                      <span style="background:#181c24;color:#fff;padding:4px 8px;border-radius:4px;">${site.name}</span>
                    `).join('')}
                  </div>
                </div>
                <div style="margin-bottom:16px;white-space:pre-wrap;">${d.content}</div>
                ${d.images && d.images.length > 0 ? `
                  <div style="display:flex;gap:8px;flex-wrap:wrap;">
                    ${d.images.map(url => `
                      <img src="${url}" style="width:100px;height:100px;object-fit:cover;border-radius:6px;cursor:pointer;" onclick="showImage('${url}')">
                    `).join('')}
                  </div>
                ` : ''}
              </div>`;
          }
        });
        
        container.innerHTML = html;
      });
    }

    // ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
    window.downloadDiscussionExcel = function() {
      db.collection('discussions').get().then(snapshot => {
        const data = snapshot.docs.map(doc => {
          const d = doc.data();
          return {
            'ì œëª©': d.title || '',
            'ì‘ì„±ì': d.author.email || '',
            'ì‘ì„±ì¼': d.createdAt ? d.createdAt.toDate().toLocaleString() : '',
            'ê´€ë ¨ í˜„ì¥': d.sites.map(site => site.name).join(', '),
            'ë‚´ìš©': d.content || '',
            'ì´ë¯¸ì§€ ìˆ˜': d.images ? d.images.length : 0
          };
        });

        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'í˜‘ì˜ëª©ë¡');
        XLSX.writeFile(wb, 'í˜‘ì˜ëª©ë¡.xlsx');
      });
    }

    // ê¸°ì„±í˜„í™© í™”ë©´
    function renderProgress() {
      renderMenu('progress');
      const content = document.getElementById('content');
      // ê²€ìƒ‰/ì—‘ì…€
      let filterHtml = `
        <div style='display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;'>
          <div style='display:flex;gap:8px;'>
            <input type='text' id='progress-search' placeholder='í˜„ì¥ëª…/íšŒì‚¬/ì†Œì¥/ë‚´ìš© ê²€ìƒ‰' style='padding:8px 12px;border-radius:6px;border:1.5px solid #2d3344;background:#181c24;color:#fff;width:300px;'>
            <button onclick='searchProgress()' style='background:#3b82f6;color:#fff;border:none;border-radius:6px;padding:8px 16px;'>ê²€ìƒ‰</button>
          </div>
          <button onclick='downloadProgressExcel()' style='background:#22c55e;color:#fff;border:none;border-radius:6px;padding:8px 16px;'>ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
        </div>`;
      // ì‘ì„± í¼
      let formHtml = `
        <form id="progress-form" style="margin-bottom:32px;">
          <div style="margin-bottom:16px;">
            <select id="progress-site" style="width:100%;padding:12px;border-radius:6px;border:1.5px solid #2d3344;background:#181c24;color:#fff;font-size:1.1rem;" required></select>
          </div>
          <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:16px;margin-bottom:16px;">
            <input type="text" id="progress-company" placeholder="íšŒì‚¬" style="padding:10px;border-radius:6px;border:1.5px solid #2d3344;background:#181c24;color:#fff;" readonly>
            <input type="text" id="progress-manager" placeholder="í˜„ì¥ì†Œì¥" style="padding:10px;border-radius:6px;border:1.5px solid #2d3344;background:#181c24;color:#fff;" readonly>
            <input type="text" id="progress-period" placeholder="ê³µì‚¬ê¸°ê°„" style="padding:10px;border-radius:6px;border:1.5px solid #2d3344;background:#181c24;color:#fff;" readonly>
            <input type="text" id="progress-contract" placeholder="ê³„ì•½ê¸ˆì•¡" style="padding:10px;border-radius:6px;border:1.5px solid #2d3344;background:#181c24;color:#fff;" readonly>
          </div>
          <div style="margin-bottom:16px;">
            <textarea id="progress-content" placeholder="ê¸°ì„±ë‚´ì—­/ë¹„ê³  ë“± ì¶”ê°€ ë‚´ìš©" style="width:100%;min-height:120px;padding:12px;border-radius:6px;border:1.5px solid #2d3344;background:#181c24;color:#fff;font-size:1rem;"></textarea>
          </div>
          <div style="margin-bottom:16px;">
            <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;">
              <input type="file" id="progress-images" multiple accept="image/*" style="display:none;" onchange="previewProgressImages(this)">
              <label style="background:#3b82f6;color:#fff;border:none;border-radius:6px;padding:8px 16px;cursor:pointer;">
                ì‚¬ì§„ ì¶”ê°€
                <input type="file" id="progress-images" multiple accept="image/*" style="display:none;" onchange="previewProgressImages(this)">
              </label>
            </div>
            <div id="progress-image-preview" style="display:flex;gap:8px;flex-wrap:wrap;"></div>
          </div>
          <button type="submit" style="background:#22c55e;color:#fff;border:none;border-radius:6px;padding:12px 24px;font-weight:700;font-size:1.1rem;">ì‘ì„±í•˜ê¸°</button>
        </form>`;
      content.innerHTML = `<h2>ê¸°ì„±í˜„í™©</h2>${filterHtml}${formHtml}<div id="progress-list"></div>`;
      // í˜„ì¥ ë¶ˆëŸ¬ì˜¤ê¸°(ë³´ë¥˜ ì œì™¸)
      db.collection('sites').get().then(snapshot => {
        const select = document.getElementById('progress-site');
        let html = '<option value="">í˜„ì¥ ì„ íƒ</option>';
        snapshot.forEach(doc => {
          const d = doc.data();
          if(d.status !== 'ë³´ë¥˜') {
            html += `<option value="${doc.id}" data-company="${d.company||''}" data-manager="${d.manager||''}" data-period="${d.start||''}~${d.end||''}" data-contract="${d.contract||''}">${d.name}</option>`;
          }
        });
        select.innerHTML = html;
      });
      // í˜„ì¥ ì„ íƒ ì‹œ ìë™ ì…ë ¥
      document.getElementById('progress-site').onchange = function() {
        const opt = this.selectedOptions[0];
        document.getElementById('progress-company').value = opt.getAttribute('data-company')||'';
        document.getElementById('progress-manager').value = opt.getAttribute('data-manager')||'';
        document.getElementById('progress-period').value = opt.getAttribute('data-period')||'';
        document.getElementById('progress-contract').value = opt.getAttribute('data-contract')||'';
      };
      // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°
      window.previewProgressImages = function(input) {
        const preview = document.getElementById('progress-image-preview');
        window.progressImages = window.progressImages || [];
        Array.from(input.files).forEach(file => {
          window.progressImages.push(file);
          const reader = new FileReader();
          reader.onload = function(e) {
            preview.innerHTML += `<div style="position:relative;width:100px;height:100px;"><img src="${e.target.result}" style="width:100%;height:100%;object-fit:cover;border-radius:6px;"><button onclick="removeProgressImage(this)" style="position:absolute;top:-8px;right:-8px;background:#ef4444;color:#fff;border:none;border-radius:50%;width:20px;height:20px;font-size:14px;cursor:pointer;">Ã—</button></div>`;
          };
          reader.readAsDataURL(file);
        });
      }
      window.removeProgressImage = function(btn) {
        const index = Array.from(btn.parentNode.parentNode.children).indexOf(btn.parentNode);
        window.progressImages.splice(index, 1);
        btn.parentNode.remove();
      }
      // ì‘ì„± í¼ ì´ë²¤íŠ¸
      document.getElementById('progress-form').onsubmit = function(e) {
        e.preventDefault();
        const siteId = document.getElementById('progress-site').value;
        const siteName = document.getElementById('progress-site').selectedOptions[0]?.textContent || '';
        if (!siteName || !siteId) { alert('í˜„ì¥ëª…ì„ ì„ íƒí•˜ì„¸ìš”.'); return; }
        const company = document.getElementById('progress-company').value;
        const manager = document.getElementById('progress-manager').value;
        const period = document.getElementById('progress-period').value;
        const contract = document.getElementById('progress-contract').value;
        const content = document.getElementById('progress-content').value.trim();
        const images = window.progressImages || [];
        if(!siteId) { alert('í˜„ì¥ì„ ì„ íƒí•˜ì„¸ìš”.'); return; }
        // ì´ë¯¸ì§€ ì—…ë¡œë“œ
        Promise.all(images.map(file => {
          const storageRef = firebase.storage().ref();
          const imageRef = storageRef.child(`progress/${Date.now()}_${file.name}`);
          return imageRef.put(file).then(snapshot => snapshot.ref.getDownloadURL());
        })).then(imageUrls => {
          db.collection('progress_status').add({
            siteId, siteName, company, manager, period, contract, content, images: imageUrls,
            author: { uid: firebase.auth().currentUser.uid, email: firebase.auth().currentUser.email },
            createdAt: new Date()
          }).then(()=>{
            document.getElementById('progress-site').value = '';
            document.getElementById('progress-company').value = '';
            document.getElementById('progress-manager').value = '';
            document.getElementById('progress-period').value = '';
            document.getElementById('progress-contract').value = '';
            document.getElementById('progress-content').value = '';
            document.getElementById('progress-image-preview').innerHTML = '';
            window.progressImages = [];
          });
        });
      };
      // ëª©ë¡ ë¡œë“œ
      loadProgressList();
    }
    // ëª©ë¡ ë¡œë“œ
    function loadProgressList() {
      const container = document.getElementById('progress-list');
      db.collection('progress_status').orderBy('createdAt','desc').onSnapshot(snapshot => {
        let html = '';
        snapshot.forEach(doc => {
          const d = doc.data();
          const isAuthor = d.author.uid === firebase.auth().currentUser.uid;
          const isAdmin = window.currentUserRole === 'admin' || window.currentUserRole === 'master';
          html += `<div style="background:#232837;border-radius:12px;padding:24px;margin-bottom:16px;">
            <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:16px;">
              <div>
                <h3 style="margin:0 0 8px 0;color:#3b82f6;">${d.siteName}</h3>
                <div style="color:#b3b8c5;font-size:0.9rem;">íšŒì‚¬: ${d.company||''} | ì†Œì¥: ${d.manager||''} | ê¸°ê°„: ${d.period||''} | ê³„ì•½ê¸ˆì•¡: ${d.contract||''}</div>
                <div style="color:#b3b8c5;font-size:0.9rem;">ì‘ì„±ì: ${d.author.email} | ${d.createdAt.toDate().toLocaleString()}</div>
              </div>
              ${(isAuthor||isAdmin)?`<div style="display:flex;gap:8px;"><button onclick="editProgress('${doc.id}')" style="background:#3b82f6;color:#fff;border:none;border-radius:6px;padding:6px 12px;">ìˆ˜ì •</button><button onclick="deleteProgress('${doc.id}')" style="background:#ef4444;color:#fff;border:none;border-radius:6px;padding:6px 12px;">ì‚­ì œ</button></div>`:''}
            </div>
            <div style="margin-bottom:16px;white-space:pre-wrap;">${d.content||''}</div>
            ${d.images&&d.images.length>0?`<div style="display:flex;gap:8px;flex-wrap:wrap;">${d.images.map(url=>`<img src="${url}" style="width:100px;height:100px;object-fit:cover;border-radius:6px;cursor:pointer;" onclick="showImage('${url}')">`).join('')}</div>`:''}
          </div>`;
        });
        container.innerHTML = html;
      });
    }
    // ìˆ˜ì •
    window.editProgress = function(id) {
      db.collection('progress_status').doc(id).get().then(doc => {
        const d = doc.data();
        document.getElementById('progress-site').value = d.siteId;
        document.getElementById('progress-company').value = d.company;
        document.getElementById('progress-manager').value = d.manager;
        document.getElementById('progress-period').value = d.period;
        document.getElementById('progress-contract').value = d.contract;
        document.getElementById('progress-content').value = d.content;
        // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°
        const preview = document.getElementById('progress-image-preview');
        preview.innerHTML = '';
        if(d.images&&d.images.length>0){
          d.images.forEach(url=>{
            preview.innerHTML += `<div style="position:relative;width:100px;height:100px;"><img src="${url}" style="width:100%;height:100%;object-fit:cover;border-radius:6px;"><button onclick="removeProgressImage(this)" style="position:absolute;top:-8px;right:-8px;background:#ef4444;color:#fff;border:none;border-radius:50%;width:20px;height:20px;font-size:14px;cursor:pointer;">Ã—</button></div>`;
          });
        }
        // í¼ ì œì¶œ ì´ë²¤íŠ¸ ë³€ê²½
        const form = document.getElementById('progress-form');
        form.onsubmit = function(e) {
          e.preventDefault();
          const siteId = document.getElementById('progress-site').value;
          const siteName = document.getElementById('progress-site').selectedOptions[0]?.textContent || '';
          if (!siteName || !siteId) { alert('í˜„ì¥ëª…ì„ ì„ íƒí•˜ì„¸ìš”.'); return; }
          const company = document.getElementById('progress-company').value;
          const manager = document.getElementById('progress-manager').value;
          const period = document.getElementById('progress-period').value;
          const contract = document.getElementById('progress-contract').value;
          const content = document.getElementById('progress-content').value.trim();
          const images = window.progressImages || [];
          if(!siteId) { alert('í˜„ì¥ì„ ì„ íƒí•˜ì„¸ìš”.'); return; }
          Promise.all(images.map(file => {
            const storageRef = firebase.storage().ref();
            const imageRef = storageRef.child(`progress/${Date.now()}_${file.name}`);
            return imageRef.put(file).then(snapshot => snapshot.ref.getDownloadURL());
          })).then(newImageUrls => {
            const existingImages = Array.from(document.querySelectorAll('#progress-image-preview img')).map(img=>img.src);
            const allImages = [...existingImages, ...newImageUrls];
            db.collection('progress_status').doc(id).update({
              siteId, siteName, company, manager, period, contract, content, images: allImages, updatedAt: new Date()
            }).then(()=>{
              document.getElementById('progress-site').value = '';
              document.getElementById('progress-company').value = '';
              document.getElementById('progress-manager').value = '';
              document.getElementById('progress-period').value = '';
              document.getElementById('progress-contract').value = '';
              document.getElementById('progress-content').value = '';
              document.getElementById('progress-image-preview').innerHTML = '';
              window.progressImages = [];
              form.onsubmit = null;
              renderProgress();
            });
          });
        };
      });
    }
    // ì‚­ì œ
    window.deleteProgress = function(id) {
      if(confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')){
        db.collection('progress_status').doc(id).delete();
      }
    }
    // ê²€ìƒ‰
    window.searchProgress = function() {
      const keyword = document.getElementById('progress-search').value.trim().toLowerCase();
      if(!keyword){ loadProgressList(); return; }
      db.collection('progress_status').get().then(snapshot => {
        const container = document.getElementById('progress-list');
        let html = '';
        snapshot.forEach(doc => {
          const d = doc.data();
          if(
            (d.siteName||'').toLowerCase().includes(keyword) ||
            (d.company||'').toLowerCase().includes(keyword) ||
            (d.manager||'').toLowerCase().includes(keyword) ||
            (d.content||'').toLowerCase().includes(keyword)
          ){
            const isAuthor = d.author.uid === firebase.auth().currentUser.uid;
            const isAdmin = window.currentUserRole === 'admin' || window.currentUserRole === 'master';
            html += `
              <div style="background:#232837;border-radius:12px;padding:24px;margin-bottom:16px;">
                <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:16px;">
                  <div>
                    <h3 style="margin:0 0 8px 0;color:#3b82f6;">${d.siteName}</h3>
                    <div style="color:#b3b8c5;font-size:0.9rem;">íšŒì‚¬: ${d.company||''} | ì†Œì¥: ${d.manager||''} | ê¸°ê°„: ${d.period||''} | ê³„ì•½ê¸ˆì•¡: ${d.contract||''}</div>
                    <div style="color:#b3b8c5;font-size:0.9rem;">ì‘ì„±ì: ${d.author.email} | ${d.createdAt.toDate().toLocaleString()}</div>
                  </div>
                  ${(isAuthor||isAdmin)?`<div style=\"display:flex;gap:8px;\"><button onclick=\"editProgress('${doc.id}')\" style=\"background:#3b82f6;color:#fff;border:none;border-radius:6px;padding:6px 12px;\">ìˆ˜ì •</button><button onclick=\"deleteProgress('${doc.id}')\" style=\"background:#ef4444;color:#fff;border:none;border-radius:6px;padding:6px 12px;\">ì‚­ì œ</button></div>`:''}
                </div>
                <div style="margin-bottom:16px;white-space:pre-wrap;">${d.content||''}</div>
                ${d.images&&d.images.length>0?`<div style="display:flex;gap:8px;flex-wrap:wrap;">${d.images.map(url=>`<img src=\"${url}\" style=\"width:100px;height:100px;object-fit:cover;border-radius:6px;cursor:pointer;\" onclick=\"showImage('${url}')\">`).join('')}</div>`:''}
              </div>`;
          }
        });
        container.innerHTML = html;
      });
    }
    // ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
    window.downloadProgressExcel = function() {
      db.collection('progress_status').get().then(snapshot => {
        const data = snapshot.docs.map(doc => {
          const d = doc.data();
          return {
            'í˜„ì¥ëª…': d.siteName||'',
            'íšŒì‚¬': d.company||'',
            'í˜„ì¥ì†Œì¥': d.manager||'',
            'ê³µì‚¬ê¸°ê°„': d.period||'',
            'ê³„ì•½ê¸ˆì•¡': d.contract||'',
            'ì‘ì„±ì': d.author.email||'',
            'ì‘ì„±ì¼': d.createdAt?d.createdAt.toDate().toLocaleString():'',
            'ê¸°ì„±ë‚´ì—­': d.content||'',
            'ì´ë¯¸ì§€ìˆ˜': d.images?d.images.length:0
          };
        });
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'ê¸°ì„±í˜„í™©');
        XLSX.writeFile(wb, 'ê¸°ì„±í˜„í™©.xlsx');
      });
    }
    // ì—‘ì…€ ì—…ë¡œë“œ
    window.uploadProgressExcel = function(input) {
      const file = input.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, {type: 'array'});
        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(firstSheet);
        jsonData.forEach(row => {
          db.collection('progress_status').add({
            siteName: row['í˜„ì¥ëª…']||'',
            company: row['íšŒì‚¬']||'',
            manager: row['í˜„ì¥ì†Œì¥']||'',
            period: row['ê³µì‚¬ê¸°ê°„']||'',
            contract: row['ê³„ì•½ê¸ˆì•¡']||'',
            content: row['ê¸°ì„±ë‚´ì—­']||'',
            author: { email: row['ì‘ì„±ì']||'' },
            createdAt: new Date(row['ì‘ì„±ì¼']||Date.now()),
            images: [] // ì´ë¯¸ì§€URLì€ ë³„ë„ ì²˜ë¦¬ í•„ìš”
          });
        });
        alert('ì—‘ì…€ ë°ì´í„°ê°€ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
        input.value = '';
      };
      reader.readAsArrayBuffer(file);
    }

    // ê±°ë˜ì²˜ í˜„í™© í™”ë©´
    function renderPartners() {
      renderMenu('partners');
      const content = document.getElementById('content');
      // ê²€ìƒ‰/ì—‘ì…€
      let filterHtml = `
        <div style='display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;'>
          <div style='display:flex;gap:8px;'>
            <input type='text' id='partner-search' placeholder='ê±°ë˜ì²˜ëª…/ëŒ€í‘œì/ì—°ë½ì²˜/ì´ë©”ì¼ ê²€ìƒ‰' style='padding:8px 12px;border-radius:6px;border:1.5px solid #2d3344;background:#181c24;color:#fff;width:300px;'>
            <button onclick='searchPartners()' style='background:#3b82f6;color:#fff;border:none;border-radius:6px;padding:8px 16px;'>ê²€ìƒ‰</button>
          </div>
          <div style='display:flex;gap:8px;'>
            <button onclick='downloadPartnersExcel()' style='background:#22c55e;color:#fff;border:none;border-radius:6px;padding:8px 16px;'>ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
            <label style='background:#3b82f6;color:#fff;border:none;border-radius:6px;padding:8px 16px;cursor:pointer;'>
              ì—‘ì…€ ì—…ë¡œë“œ
              <input type='file' id='partners-excel-upload' accept='.xlsx,.xls' style='display:none;' onchange='uploadPartnersExcel(this)'>
            </label>
          </div>
        </div>`;
      // ì¶”ê°€ í¼
      let formHtml = `
        <form id="partner-form" style="margin-bottom:32px;display:flex;flex-wrap:wrap;gap:10px;align-items:center;">
          <select id="partner-type" style="padding:8px 10px;border-radius:6px;border:1.5px solid #2d3344;background:#181c24;color:#fff;font-size:1rem;" required>
            <option value="">êµ¬ë¶„ ì„ íƒ</option>
            <option value="ì¢…í•©ê±´ì„¤">ì¢…í•©ê±´ì„¤</option>
            <option value="ALê´€ê¸‰ì—…ì²´">ALê´€ê¸‰ì—…ì²´</option>
            <option value="PLê´€ê¸‰ì—…ì²´">PLê´€ê¸‰ì—…ì²´</option>
          </select>
          <input id="partner-name" type="text" placeholder="ê±°ë˜ì²˜ëª…" style="padding:8px 10px;border-radius:6px;border:1.5px solid #2d3344;background:#181c24;color:#fff;font-size:1rem;" required />
          <input id="partner-ceo" type="text" placeholder="ëŒ€í‘œìëª…" style="padding:8px 10px;border-radius:6px;border:1.5px solid #2d3344;background:#181c24;color:#fff;font-size:1rem;" />
          <input id="partner-biznum" type="text" placeholder="ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸" style="padding:8px 10px;border-radius:6px;border:1.5px solid #2d3344;background:#181c24;color:#fff;font-size:1rem;" />
          <input id="partner-phone" type="text" placeholder="ì—°ë½ì²˜" style="padding:8px 10px;border-radius:6px;border:1.5px solid #2d3344;background:#181c24;color:#fff;font-size:1rem;" />
          <input id="partner-email" type="text" placeholder="ì´ë©”ì¼" style="padding:8px 10px;border-radius:6px;border:1.5px solid #2d3344;background:#181c24;color:#fff;font-size:1rem;" />
          <input id="partner-address" type="text" placeholder="ì£¼ì†Œ" style="padding:8px 10px;border-radius:6px;border:1.5px solid #2d3344;background:#181c24;color:#fff;font-size:1rem;" />
          <div style="position:relative;">
            <input id="partner-period" type="text" placeholder="ê³µì‚¬ê¸°ê°„" style="padding:8px 10px;border-radius:6px;border:1.5px solid #2d3344;background:#181c24;color:#fff;font-size:1rem;width:180px;" readonly />
            <div id="partner-period-calendar" style="display:none;position:absolute;top:100%;left:0;z-index:1000;background:#232837;padding:12px;border-radius:8px;box-shadow:0 4px 12px #0003;"></div>
          </div>
          <input id="partner-item" type="text" placeholder="ì£¼ìš”ê±°ë˜í’ˆëª©/ë¹„ê³ " style="padding:8px 10px;border-radius:6px;border:1.5px solid #2d3344;background:#181c24;color:#fff;font-size:1rem;width:300px;" />
          <button type="submit" style="background:#22c55e;color:#fff;border:none;border-radius:6px;padding:8px 22px;font-weight:700;">+ ê±°ë˜ì²˜ ì¶”ê°€</button>
        </form>`;
      content.innerHTML = `<h2>ê±°ë˜ì²˜ í˜„í™©</h2>${filterHtml}${formHtml}<div id="partners-list"></div>`;
      // ë¯¸ë‹ˆ ë‹¬ë ¥(ê³µì‚¬ê¸°ê°„)
      initCalendar('partner-period-calendar', 'partner-period');
      // í¼ ì´ë²¤íŠ¸
      document.getElementById('partner-form').onsubmit = function(e) {
        e.preventDefault();
        const type = document.getElementById('partner-type').value;
        const name = document.getElementById('partner-name').value.trim();
        if (!type) { alert('êµ¬ë¶„ì„ ì„ íƒí•˜ì„¸ìš”.'); return; }
        if (!name) { alert('ê±°ë˜ì²˜ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
        const ceo = document.getElementById('partner-ceo').value.trim();
        const biznum = document.getElementById('partner-biznum').value.trim();
        const phone = document.getElementById('partner-phone').value.trim();
        const email = document.getElementById('partner-email').value.trim();
        const address = document.getElementById('partner-address').value.trim();
        const period = document.getElementById('partner-period').value.trim();
        const item = document.getElementById('partner-item').value.trim();
        db.collection('partners').add({
          type, name, ceo, biznum, phone, email, address, period, item,
          author: { uid: firebase.auth().currentUser.uid, email: firebase.auth().currentUser.email },
          createdAt: new Date()
        }).then(()=>{
          document.getElementById('partner-type').value = '';
          document.getElementById('partner-name').value = '';
          document.getElementById('partner-ceo').value = '';
          document.getElementById('partner-biznum').value = '';
          document.getElementById('partner-phone').value = '';
          document.getElementById('partner-email').value = '';
          document.getElementById('partner-address').value = '';
          document.getElementById('partner-period').value = '';
          document.getElementById('partner-item').value = '';
        });
      };
      // ëª©ë¡ ë¡œë“œ
      loadPartnersList();
    }
    // ëª©ë¡ ë¡œë“œ
    function loadPartnersList() {
      const container = document.getElementById('partners-list');
      db.collection('partners').orderBy('createdAt','desc').onSnapshot(snapshot => {
        let html = `<table style='width:100%;'><thead><tr>
          <th>êµ¬ë¶„</th><th>ê±°ë˜ì²˜ëª…</th><th>ëŒ€í‘œì</th><th>ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸</th><th>ì—°ë½ì²˜</th><th>ì´ë©”ì¼</th><th>ì£¼ì†Œ</th><th>ê³µì‚¬ê¸°ê°„</th><th>ì£¼ìš”ê±°ë˜í’ˆëª©/ë¹„ê³ </th><th>ë“±ë¡ì¼</th><th>ê´€ë¦¬</th>
        </tr></thead><tbody>`;
        snapshot.forEach(doc => {
          const d = doc.data();
          const isAuthor = d.author && d.author.uid === firebase.auth().currentUser.uid;
          const isAdmin = window.currentUserRole === 'admin' || window.currentUserRole === 'master';
          html += `<tr>
            <td>
              <select id='type-${doc.id}' style='width:100px;padding:4px;border-radius:4px;border:1px solid #2d3344;background:#232837;color:#fff;'>
                <option value='ì¢…í•©ê±´ì„¤' ${d.type==='ì¢…í•©ê±´ì„¤'?'selected':''}>ì¢…í•©ê±´ì„¤</option>
                <option value='ALê´€ê¸‰ì—…ì²´' ${d.type==='ALê´€ê¸‰ì—…ì²´'?'selected':''}>ALê´€ê¸‰ì—…ì²´</option>
                <option value='PLê´€ê¸‰ì—…ì²´' ${d.type==='PLê´€ê¸‰ì—…ì²´'?'selected':''}>PLê´€ê¸‰ì—…ì²´</option>
              </select>
            </td>
            <td><input type='text' value='${d.name||''}' id='name-${doc.id}' style='width:120px;padding:4px;border-radius:4px;border:1px solid #2d3344;background:#232837;color:#fff;'></td>
            <td><input type='text' value='${d.ceo||''}' id='ceo-${doc.id}' style='width:100px;padding:4px;border-radius:4px;border:1px solid #2d3344;background:#232837;color:#fff;'></td>
            <td><input type='text' value='${d.biznum||''}' id='biznum-${doc.id}' style='width:120px;padding:4px;border-radius:4px;border:1px solid #2d3344;background:#232837;color:#fff;'></td>
            <td><input type='text' value='${d.phone||''}' id='phone-${doc.id}' style='width:120px;padding:4px;border-radius:4px;border:1px solid #2d3344;background:#232837;color:#fff;'></td>
            <td><input type='text' value='${d.email||''}' id='email-${doc.id}' style='width:140px;padding:4px;border-radius:4px;border:1px solid #2d3344;background:#232837;color:#fff;'></td>
            <td><input type='text' value='${d.address||''}' id='address-${doc.id}' style='width:180px;padding:4px;border-radius:4px;border:1px solid #2d3344;background:#232837;color:#fff;'></td>
            <td><input type='text' value='${d.period||''}' id='period-${doc.id}' style='width:140px;padding:4px;border-radius:4px;border:1px solid #2d3344;background:#232837;color:#fff;' readonly></td>
            <td><input type='text' value='${d.item||''}' id='item-${doc.id}' style='width:180px;padding:4px;border-radius:4px;border:1px solid #2d3344;background:#232837;color:#fff;'></td>
            <td>${d.createdAt ? d.createdAt.toDate().toLocaleString() : ''}</td>
            <td>
              ${(isAuthor||isAdmin)?`<button onclick="updatePartner('${doc.id}')" style='background:#3b82f6;color:#fff;border:none;border-radius:6px;padding:4px 12px;margin-right:4px;'>ìˆ˜ì •</button><button onclick="deletePartner('${doc.id}')" style='background:#ef4444;color:#fff;border:none;border-radius:6px;padding:4px 12px;'>ì‚­ì œ</button>`:''}
            </td>
          </tr>`;
        });
        html += '</tbody></table>';
        container.innerHTML = html;
      });
    }
    // ìˆ˜ì •
    window.updatePartner = function(id) {
      const type = document.getElementById('type-' + id).value;
      const name = document.getElementById('name-' + id).value.trim();
      if (!type) { alert('êµ¬ë¶„ì„ ì„ íƒí•˜ì„¸ìš”.'); return; }
      if (!name) { alert('ê±°ë˜ì²˜ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
      const ceo = document.getElementById('ceo-' + id).value.trim();
      const biznum = document.getElementById('biznum-' + id).value.trim();
      const phone = document.getElementById('phone-' + id).value.trim();
      const email = document.getElementById('email-' + id).value.trim();
      const address = document.getElementById('address-' + id).value.trim();
      const period = document.getElementById('period-' + id).value.trim();
      const item = document.getElementById('item-' + id).value.trim();
      db.collection('partners').doc(id).update({ type, name, ceo, biznum, phone, email, address, period, item, updatedAt: new Date() });
    }
    // ì‚­ì œ
    window.deletePartner = function(id) {
      if(confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')){
        db.collection('partners').doc(id).delete();
      }
    }
    // ê²€ìƒ‰
    window.searchPartners = function() {
      const keyword = document.getElementById('partner-search').value.trim().toLowerCase();
      if(!keyword){ loadPartnersList(); return; }
      db.collection('partners').get().then(snapshot => {
        const container = document.getElementById('partners-list');
        let html = `<table style='width:100%;'><thead><tr>
          <th>êµ¬ë¶„</th><th>ê±°ë˜ì²˜ëª…</th><th>ëŒ€í‘œì</th><th>ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸</th><th>ì—°ë½ì²˜</th><th>ì´ë©”ì¼</th><th>ì£¼ì†Œ</th><th>ê³µì‚¬ê¸°ê°„</th><th>ì£¼ìš”ê±°ë˜í’ˆëª©/ë¹„ê³ </th><th>ë“±ë¡ì¼</th><th>ê´€ë¦¬</th>
        </tr></thead><tbody>`;
        snapshot.forEach(doc => {
          const d = doc.data();
          if(
            (d.type||'').toLowerCase().includes(keyword) ||
            (d.name||'').toLowerCase().includes(keyword) ||
            (d.ceo||'').toLowerCase().includes(keyword) ||
            (d.biznum||'').toLowerCase().includes(keyword) ||
            (d.phone||'').toLowerCase().includes(keyword) ||
            (d.email||'').toLowerCase().includes(keyword) ||
            (d.address||'').toLowerCase().includes(keyword) ||
            (d.period||'').toLowerCase().includes(keyword) ||
            (d.item||'').toLowerCase().includes(keyword)
          ){
            const isAuthor = d.author && d.author.uid === firebase.auth().currentUser.uid;
            const isAdmin = window.currentUserRole === 'admin' || window.currentUserRole === 'master';
            html += `<tr>
              <td>
                <select id='type-${doc.id}' style='width:100px;padding:4px;border-radius:4px;border:1px solid #2d3344;background:#232837;color:#fff;'>
                  <option value='ì¢…í•©ê±´ì„¤' ${d.type==='ì¢…í•©ê±´ì„¤'?'selected':''}>ì¢…í•©ê±´ì„¤</option>
                  <option value='ALê´€ê¸‰ì—…ì²´' ${d.type==='ALê´€ê¸‰ì—…ì²´'?'selected':''}>ALê´€ê¸‰ì—…ì²´</option>
                  <option value='PLê´€ê¸‰ì—…ì²´' ${d.type==='PLê´€ê¸‰ì—…ì²´'?'selected':''}>PLê´€ê¸‰ì—…ì²´</option>
                </select>
              </td>
              <td><input type='text' value='${d.name||''}' id='name-${doc.id}' style='width:120px;padding:4px;border-radius:4px;border:1px solid #2d3344;background:#232837;color:#fff;'></td>
              <td><input type='text' value='${d.ceo||''}' id='ceo-${doc.id}' style='width:100px;padding:4px;border-radius:4px;border:1px solid #2d3344;background:#232837;color:#fff;'></td>
              <td><input type='text' value='${d.biznum||''}' id='biznum-${doc.id}' style='width:120px;padding:4px;border-radius:4px;border:1px solid #2d3344;background:#232837;color:#fff;'></td>
              <td><input type='text' value='${d.phone||''}' id='phone-${doc.id}' style='width:120px;padding:4px;border-radius:4px;border:1px solid #2d3344;background:#232837;color:#fff;'></td>
              <td><input type='text' value='${d.email||''}' id='email-${doc.id}' style='width:140px;padding:4px;border-radius:4px;border:1px solid #2d3344;background:#232837;color:#fff;'></td>
              <td><input type='text' value='${d.address||''}' id='address-${doc.id}' style='width:180px;padding:4px;border-radius:4px;border:1px solid #2d3344;background:#232837;color:#fff;'></td>
              <td><input type='text' value='${d.period||''}' id='period-${doc.id}' style='width:140px;padding:4px;border-radius:4px;border:1px solid #2d3344;background:#232837;color:#fff;' readonly></td>
              <td><input type='text' value='${d.item||''}' id='item-${doc.id}' style='width:180px;padding:4px;border-radius:4px;border:1px solid #2d3344;background:#232837;color:#fff;'></td>
              <td>${d.createdAt ? d.createdAt.toDate().toLocaleString() : ''}</td>
              <td>
                ${(isAuthor||isAdmin)?`<button onclick=\"updatePartner('${doc.id}')\" style='background:#3b82f6;color:#fff;border:none;border-radius:6px;padding:4px 12px;margin-right:4px;'>ìˆ˜ì •</button><button onclick=\"deletePartner('${doc.id}')\" style='background:#ef4444;color:#fff;border:none;border-radius:6px;padding:4px 12px;'>ì‚­ì œ</button>`:''}
              </td>
            </tr>`;
          }
        });
        html += '</tbody></table>';
        container.innerHTML = html;
      });
    }
    // ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
    window.downloadPartnersExcel = function() {
      db.collection('partners').get().then(snapshot => {
        const data = snapshot.docs.map(doc => {
          const d = doc.data();
          return {
            'êµ¬ë¶„': d.type||'',
            'ê±°ë˜ì²˜ëª…': d.name||'',
            'ëŒ€í‘œì': d.ceo||'',
            'ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸': d.biznum||'',
            'ì—°ë½ì²˜': d.phone||'',
            'ì´ë©”ì¼': d.email||'',
            'ì£¼ì†Œ': d.address||'',
            'ê³µì‚¬ê¸°ê°„': d.period||'',
            'ì£¼ìš”ê±°ë˜í’ˆëª©/ë¹„ê³ ': d.item||'',
            'ë“±ë¡ì¼': d.createdAt?d.createdAt.toDate().toLocaleString():'',
            'ì‘ì„±ì': d.author?d.author.email:''
          };
        });
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'ê±°ë˜ì²˜í˜„í™©');
        XLSX.writeFile(wb, 'ê±°ë˜ì²˜í˜„í™©.xlsx');
      });
    }
    // ì—‘ì…€ ì—…ë¡œë“œ
    window.uploadPartnersExcel = function(input) {
      const file = input.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, {type: 'array'});
        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(firstSheet);
        jsonData.forEach(row => {
          db.collection('partners').add({
            type: row['êµ¬ë¶„']||'',
            name: row['ê±°ë˜ì²˜ëª…']||'',
            ceo: row['ëŒ€í‘œì']||'',
            biznum: row['ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸']||'',
            phone: row['ì—°ë½ì²˜']||'',
            email: row['ì´ë©”ì¼']||'',
            address: row['ì£¼ì†Œ']||'',
            period: row['ê³µì‚¬ê¸°ê°„']||'',
            item: row['ì£¼ìš”ê±°ë˜í’ˆëª©/ë¹„ê³ ']||'',
            author: { email: row['ì‘ì„±ì']||'' },
            createdAt: new Date(row['ë“±ë¡ì¼']||Date.now())
          });
        });
        alert('ì—‘ì…€ ë°ì´í„°ê°€ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
        input.value = '';
      };
      reader.readAsArrayBuffer(file);
    }

    // ë©”ì¸ í™”ë©´ ë Œë”ë§
    function renderMain() {
      renderMenu('main');
      const content = document.getElementById('content');
      
      // ê±´ì„¤ë‰´ìŠ¤ ê°€ì ¸ì˜¤ê¸°
      fetch('https://api.odcloud.kr/api/15040861/v1/uddi:5c4c3c3c-3c3c-3c3c-3c3c-3c3c3c3c3c3c?page=1&perPage=100')
        .then(response => response.json())
        .then(data => {
          let news = data.data;
          
          // ìœ ë¦¬ ê´€ë ¨ ë‰´ìŠ¤ í•„í„°ë§
          const glassNews = news.filter(item => 
            item.title.includes('ìœ ë¦¬') || 
            item.title.includes('ë³µì¸µ') || 
            item.title.includes('ë¡œì´') || 
            item.title.includes('ì‚¼ì¤‘')
          );
          
          // ë‚˜ë¨¸ì§€ ë‰´ìŠ¤
          const otherNews = news.filter(item => 
            !item.title.includes('ìœ ë¦¬') && 
            !item.title.includes('ë³µì¸µ') && 
            !item.title.includes('ë¡œì´') && 
            !item.title.includes('ì‚¼ì¤‘')
          );
          
          // ìœ ë¦¬ ë‰´ìŠ¤ ë¨¼ì € í‘œì‹œí•˜ê³  ë‚˜ë¨¸ì§€ ë‰´ìŠ¤ ëœë¤ ì„ íƒ
          const selectedNews = [
            ...glassNews.slice(0, 3),
            ...otherNews.sort(() => Math.random() - 0.5).slice(0, 2)
          ];

          let html = `
            <div style="background:#232837;border-radius:12px;padding:24px;margin-bottom:16px;">
              <h2 style="color:#3b82f6;margin-bottom:16px;">ê±´ì„¤ë‰´ìŠ¤</h2>
              <div style="display:flex;flex-direction:column;gap:12px;">
                ${selectedNews.map(item => `
                  <div style="background:#181c24;padding:16px;border-radius:8px;cursor:pointer;" 
                       onclick="window.open('${item.link}', '_blank')">
                    <h3 style="margin:0;color:#fff;font-size:1.1rem;">${item.title}</h3>
                    <div style="color:#b3b8c5;font-size:0.9rem;margin-top:8px;">
                      ${new Date(item.date).toLocaleDateString()}
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
          `;
          
          content.innerHTML = html;
        })
        .catch(error => {
          content.innerHTML = '<div class="error-msg">ë‰´ìŠ¤ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>';
        });
    }

    firebase.auth().createUserWithEmailAndPassword('admin@naver.com', '12345678')
      .then((userCredential) => {
        db.collection('users').doc(userCredential.user.uid).set({
          name: 'ê´€ë¦¬ì',
          affil: 'ê´€ë¦¬íŒ€',
          email: 'admin@naver.com',
          pw: '12345678',
          role: 'admin',
          createdAt: new Date()
        });
        alert('ì„ì‹œ ê´€ë¦¬ì ê³„ì • ìƒì„± ì™„ë£Œ!');
      })
      .catch((e) => {
        // ì´ë¯¸ ìˆìœ¼ë©´ ë¬´ì‹œ
      });
  </script>
</body>
</html> 